<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>نظام البحث</title>

  <!-- مكتبة قراءة Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- مكتبة QR -->
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>

  <style>
    body { font-family: Tahoma, sans-serif; margin:0; padding:0; background:#f5f5f5; }
    #loginBox, #app { display:none; padding:20px; }
    #loginBox { display:block; max-width:300px; margin:80px auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 0 8px rgba(0,0,0,0.2); }
    .error-msg { color:red; margin-top:10px; font-size:14px; display:none; }

    .keyboard button { width:60px; height:60px; margin:5px; font-size:20px; }
    .flex { display:flex; gap:20px; }
    table { border-collapse:collapse; width:100%; margin-top:10px; background:#fff; }
    th, td { border:1px solid #ccc; padding:8px; text-align:center; }
    th { background:#eee; }
    .actions button { margin:2px; }
    .top-bar { margin-bottom:10px; display:flex; gap:10px; align-items:center; }
  </style>
</head>
<body>

<!-- شاشة الباسورد -->
<div id="loginBox">
  <h3>أدخل كلمة المرور</h3>
  <input type="password" id="passwordInput" readonly style="width:100%;padding:8px;margin-bottom:10px;font-size:18px;" />
  <div class="keyboard">
    <div>
      <button onclick="pressDigit('1')">1</button>
      <button onclick="pressDigit('2')">2</button>
      <button onclick="pressDigit('3')">3</button>
    </div>
    <div>
      <button onclick="pressDigit('4')">4</button>
      <button onclick="pressDigit('5')">5</button>
      <button onclick="pressDigit('6')">6</button>
    </div>
    <div>
      <button onclick="pressDigit('7')">7</button>
      <button onclick="pressDigit('8')">8</button>
      <button onclick="pressDigit('9')">9</button>
    </div>
    <div>
      <button onclick="backspacePass()">⌫</button>
      <button onclick="pressDigit('0')">0</button>
      <button onclick="submitPass()">⏎</button>
    </div>
  </div>
  <div id="errorMsg" class="error-msg">كلمة المرور غير صحيحة</div>
</div>

<!-- التطبيق -->
<div id="app">
  <div class="top-bar">
    <input type="file" id="excelFile" />
    <button onclick="startCamera()">📷 كاميرا QR</button>
    <button onclick="filterByScale()">🔎 كود الميزان</button>
  </div>
  <div id="excelStatus">لم يتم تحميل ملف إكسل</div>

  <div class="top-bar">
    <input type="text" id="searchBar" placeholder="ابحث هنا" />
    <button onclick="manualSearch()">بحث</button>
    <button onclick="clearSearch()">حذف</button>
  </div>

  <div class="flex">
    <!-- جدول البحث -->
    <div style="flex:1">
      <h3>نتائج البحث</h3>
      <table id="searchTable">
        <thead><tr><th>الباركود</th><th>الاسم</th><th>كود الميزان</th><th>إجراء</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <!-- جدول المنتجات المختارة -->
    <div style="flex:1">
      <h3>المنتجات المختارة <button onclick="clearResults()">حذف الكل</button></h3>
      <table id="resultsTable">
        <thead><tr><th>الباركود</th><th>الاسم</th><th>كود الميزان</th><th>إجراء</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="reader" style="width:300px;margin:auto;display:none;"></div>
</div>

<script>
  // ================== متغيرات عامة ==================
  const correctPassword = "1234";
  const passwordInput = document.getElementById("passwordInput");
  const errorMsg = document.getElementById("errorMsg");
  const loginBox = document.getElementById("loginBox");
  const app = document.getElementById("app");
  const searchBar = document.getElementById("searchBar");
  const searchTable = document.getElementById("searchTable").querySelector("tbody");
  const resultsTable = document.getElementById("resultsTable").querySelector("tbody");
  let products = [];

  // ================== باسورد ==================
  function pressDigit(d) { passwordInput.value = (passwordInput.value || "") + d; }
  function backspacePass() { passwordInput.value = (passwordInput.value || "").slice(0, -1); }
  function submitPass() {
    if ((passwordInput.value || "") === correctPassword) {
      loginBox.style.display = "none";
      app.style.display = "block";
      errorMsg.style.display = "none";
      setTimeout(()=>searchBar.focus(), 150);
    } else {
      errorMsg.style.display = "block";
    }
  }
  document.addEventListener("keydown", e=>{
    if(loginBox.style.display === "block"){
      if(e.key >= "0" && e.key <= "9"){ pressDigit(e.key); }
      if(e.key === "Backspace"){ backspacePass(); }
      if(e.key === "Enter"){ submitPass(); }
    }
  });

  // ================== تحميل ملف Excel ==================
  document.getElementById("excelFile").addEventListener("change", function(e){
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e){
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, {type:"array"});
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      products = XLSX.utils.sheet_to_json(sheet);
      document.getElementById("excelStatus").innerText = "تم تحميل ملف إكسل بنجاح ✅";
    };
    reader.readAsArrayBuffer(file);
  });

  // ================== البحث ==================
  function renderSearchResults(list){
    searchTable.innerHTML = "";
    list.forEach(p=>{
      let row = searchTable.insertRow();
      row.insertCell().innerText = p.barcode;
      row.insertCell().innerText = p.name;
      row.insertCell().innerText = p.scale || "";
      let act = row.insertCell();
      let btn = document.createElement("button");
      btn.innerText = "إضافة";
      btn.onclick = ()=>addToResults(p);
      act.appendChild(btn);
    });
  }
  function manualSearch(){
    let q = searchBar.value.trim();
    if(!q) return;
    let res = products.filter(p=>
      (p.barcode && p.barcode.includes(q)) ||
      (p.name && p.name.includes(q))
    );
    renderSearchResults(res);
    searchBar.value = "";
  }
  function clearSearch(){ searchBar.value=""; searchTable.innerHTML=""; }

  // ================== إضافة للنتائج ==================
  function addToResults(p){
    // منع تكرار
    let exists = Array.from(resultsTable.rows).some(r=>r.cells[0].innerText === p.barcode);
    if(exists) return;
    let row = resultsTable.insertRow();
    row.insertCell().innerText = p.barcode;
    row.insertCell().innerText = p.name;
    row.insertCell().innerText = p.scale || "";
    let act = row.insertCell();
    let btn = document.createElement("button");
    btn.innerText = "حذف";
    btn.onclick = ()=>row.remove();
    act.appendChild(btn);
  }
  function clearResults(){ resultsTable.innerHTML=""; }

  // ================== QR ==================
  function startCamera(){
    document.getElementById("reader").style.display="block";
    let qr = new Html5Qrcode("reader");
    qr.start({facingMode:"environment"}, {fps:10, qrbox:250},
      code=>{
        handleQRCodeInput(code);
        qr.stop().then(()=>{document.getElementById("reader").style.display="none";});
      }
    );
  }
  function handleQRCodeInput(code){
    let found = products.find(p=>p.barcode === code);
    if(found){
      let already = Array.from(resultsTable.rows).some(r=>r.cells[0].innerText === found.barcode);
      if(!already){ addToResults(found); }
    }
    // ✨ تفريغ البحث دائمًا
    searchBar.value = "";
  }

  // ================== فلترة كود الميزان ==================
  function filterByScale(){
    [searchTable, resultsTable].forEach(tbl=>{
      Array.from(tbl.rows).forEach(r=>{
        let scale = r.cells[2].innerText.trim();
        r.style.display = scale ? "" : "none";
      });
    });
  }

  // ================== دعم Enter للبحث ==================
  searchBar.addEventListener("keydown", e=>{
    if(e.key==="Enter"){ manualSearch(); }
  });
</script>
</body>
</html>
