<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø­Ø« (Ù…ÙƒØªÙ…Ù„)</title>

  <!-- Ù…ÙƒØªØ¨Ø§Øª -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>

  <style>
    :root {
      --bg: #f7f8fb;
      --card: #fff;
      --muted: #6c757d;
      --primary: #0d6efd;
      --success: #28a745;
      --danger: #dc3545;
      --accent: #20c997;
    }
    body { margin:0; padding:18px; font-family: Tahoma, Arial, sans-serif; background:var(--bg); color:#222; }
    h2 { text-align:center; margin:6px 0 14px; }

    /* Ø­Ø§Ù„Ø© Ù…Ù„Ù Ø§Ù„Ø§ÙƒØ³Ù„ */
    #status { position: fixed; top:12px; right:12px; padding:8px 12px; border-radius:8px; color:#fff; font-weight:700; z-index:10; }
    #status.active { background:var(--success); }
    #status.inactive { background:var(--danger); }

    /* login box */
    #loginBox {
      max-width:420px; margin:18px auto; background:var(--card); padding:16px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.06); text-align:center;
    }
    #passwordInput {
      width:100%; max-width:260px; padding:10px; font-size:20px; border-radius:8px; border:1px solid #ddd; text-align:center;
    }
    .numpad { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; width:260px; margin:12px auto 0; }
    .numpad button { padding:12px; font-size:18px; border-radius:8px; border:1px solid #ccc; background:#f3f3f3; cursor:pointer; }

    #passError {
      display:none; margin-top:12px; color:#842029; background:#f8d7da; border:1px solid #f5c2c7; padding:8px; border-radius:6px;
    }

    /* app */
    #app { display:none; margin-top:14px; }
    .topbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px; justify-content:center; }
    input[type="text"], input[type="file"] { padding:8px; border-radius:8px; border:1px solid #ddd; }
    .btn { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-size:15px; }
    .btn.primary { background:var(--primary); color:#fff; }
    .btn.ghost { background:#e9ecef; }
    .btn.camera { background:var(--accent); color:#fff; }
    .btn.warn { background:var(--danger); color:#fff; }

    #reader { width:320px; margin:10px auto; display:none; }

    .tables { display:flex; gap:18px; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; }
    .col { width:48%; background:var(--card); padding:12px; border-radius:8px; box-shadow:0 1px 6px rgba(0,0,0,0.04); box-sizing:border-box; }
    @media(max-width:900px){ .col { width:100%; } .tables{flex-direction:column;} #reader{width:100%} }

    table { width:100%; border-collapse:collapse; table-layout:fixed; word-wrap:break-word; }
    thead th { background:#f2f2f2; padding:8px; border:1px solid #ddd; font-weight:600; }
    tbody td { padding:8px; border:1px solid #ddd; text-align:center; vertical-align:middle; }
    table th:nth-child(1), table td:nth-child(1) { width: 30%; }
    table th:nth-child(2), table td:nth-child(2) { width: 18%; }
    table th:nth-child(3), table td:nth-child(3) { width: 18%; }
    table th:nth-child(4), table td:nth-child(4) { width: 18%; }
    table th:nth-child(5), table td:nth-child(5) { width: 16%; }

    .addBtn { background:#198754; color:#fff; padding:6px 10px; border:none; border-radius:6px; cursor:pointer; }
    .delBtn { background:var(--danger); color:#fff; padding:6px 10px; border:none; border-radius:6px; cursor:pointer; }
    #clearAllBtn { display:none; }
  </style>
</head>
<body>
  <h2>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø­Ø« â€” Ù…ØªÙƒØ§Ù…Ù„</h2>

  <div id="status" class="inactive">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù ÙØ¹Ø§Ù„</div>

  <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ -->
  <div id="loginBox" aria-live="polite">
    <input id="passwordInput" type="password" placeholder="Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" aria-label="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <div class="numpad" aria-hidden="false">
      <button onclick="pressDigit('1')">1</button>
      <button onclick="pressDigit('2')">2</button>
      <button onclick="pressDigit('3')">3</button>
      <button onclick="pressDigit('4')">4</button>
      <button onclick="pressDigit('5')">5</button>
      <button onclick="pressDigit('6')">6</button>
      <button onclick="pressDigit('7')">7</button>
      <button onclick="pressDigit('8')">8</button>
      <button onclick="pressDigit('9')">9</button>
      <button onclick="backspacePass()">âŒ«</button>
      <button onclick="pressDigit('0')">0</button>
      <button onclick="submitPass()">â</button>
    </div>
    <div id="passError" role="alert" aria-live="assertive"></div>
  </div>

  <!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
  <div id="app" role="application" aria-hidden="true">
    <div class="topbar" role="region" aria-label="Ø£Ø¯ÙˆØ§Øª">
      <input id="excelFile" type="file" accept=".xlsx,.xls" aria-label="Ø§Ø®ØªØ± Ù…Ù„Ù Ø§ÙƒØ³Ù„">
      <button id="tryDefaultBtn" class="btn ghost" title="Ø­Ø§ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù…Ù† Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù„Ø¯">Ø­Ù…Ù„ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹</button>
      <button id="cameraBtn" class="btn camera">ğŸ“· ØªØ´ØºÙŠÙ„ Ù‚Ø§Ø±Ø¦ QR</button>
      <button id="scaleBtn" class="btn ghost">ğŸ“¶ ÙÙ„ØªØ± ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</button>
      <div id="excelStatus" style="margin-left:8px;color:var(--muted)">Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù</div>
    </div>

    <div class="topbar" role="region" aria-label="Ø¨Ø­Ø«">
      <input id="searchBar" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£Ùˆ ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬">
      <button id="searchBtn" class="btn primary">Ø¨Ø­Ø«</button>
      <button id="clearBtn" class="btn ghost">Ø­Ø°Ù</button>
    </div>

    <div id="reader"></div>

    <div class="tables" role="region" aria-label="Ø§Ù„Ù†ØªØ§Ø¦Ø¬">
      <!-- Ø¬Ø¯ÙˆÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« -->
      <div class="col" aria-label="Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«">
        <h3>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</h3>
        <table id="results">
          <thead>
            <tr>
              <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
              <th>Ø§Ù„Ø³Ø¹Ø±</th>
              <th>ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</th>
              <th>QR Code</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© -->
      <div class="col" aria-label="Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©">
        <h3>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© <button id="clearAllBtn" class="btn warn">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button></h3>
        <table id="finalResults">
          <thead>
            <tr>
              <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
              <th>Ø§Ù„Ø³Ø¹Ø±</th>
              <th>ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</th>
              <th>QR Code</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
/* ============================================================
   Ù…ØªØºÙŠØ±Ø§Øª ÙˆØªÙ‡ÙŠØ¦Ø©
   ============================================================ */
let products = []; // Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§ÙƒØ³Ù„ (objects)
let qrScanner = null;
let scaleFilterActive = false;
const correctPassword = "1234";

/* Ø¹Ù†Ø§ØµØ± DOM */
const statusEl = document.getElementById('status');
const passInput = document.getElementById('passwordInput');
const passErrorBox = document.getElementById('passError');
const loginBox = document.getElementById('loginBox');
const app = document.getElementById('app');

const excelFileInput = document.getElementById('excelFile');
const tryDefaultBtn = document.getElementById('tryDefaultBtn');
const excelStatus = document.getElementById('excelStatus');

const searchBar = document.getElementById('searchBar');
const searchBtn = document.getElementById('searchBtn');
const clearBtn = document.getElementById('clearBtn');

const readerDiv = document.getElementById('reader');

const resultsTbody = document.querySelector('#results tbody');
const finalTbody = document.querySelector('#finalResults tbody');
const cameraBtn = document.getElementById('cameraBtn');
const scaleBtn = document.getElementById('scaleBtn');
const clearAllBtn = document.getElementById('clearAllBtn');

/* ============================================================
   ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„
   - Ù†Ø­Ø§ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§ ØªØ­Ù…ÙŠÙ„ Ø§Ø³Ù… Ø§ÙØªØ±Ø§Ø¶ÙŠ product.template(176).xlsx Ù„Ùˆ ÙˆÙØ¬Ø¯
   - Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙ…ÙƒÙ†Ù‡ Ø±ÙØ¹ Ù…Ù„Ù Ù…Ù† Ø®Ù„Ø§Ù„ input[type=file]
   ============================================================ */

function parseExcelArrayBuffer(arrayBuffer) {
  const workbook = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array' });
  const sheet = workbook.Sheets[workbook.SheetNames[0]];
  // Ù†Ù‚Ø±Ø£ ÙƒÙ…ØµÙÙˆÙØ© ØµÙÙˆÙ (header included)
  const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false });
  // Ù†ØªÙˆÙ‚Ø¹ Ø§Ù„ØµÙŠØºØ©: Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø±Ø¤ÙˆØ³ØŒ Ø«Ù…: [Ø§Ø³Ù…, Ø³Ø¹Ø±, ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†, QR]
  const result = [];
  for (let i = 1; i < rows.length; i++) {
    const r = rows[i];
    if (!r || r.length === 0) continue;
    const name = (r[0] !== undefined && r[0] !== null) ? String(r[0]) : "";
    const price = (r[1] !== undefined && r[1] !== null) ? String(r[1]) : "";
    const scale = (r[2] !== undefined && r[2] !== null) ? String(r[2]) : "";
    const qr = (r[3] !== undefined && r[3] !== null) ? String(r[3]) : "";
    result.push({
      name: name,
      price: price,
      scale: scale,
      qr: qr,
      // normalized versions for comparisons
      _n_name: name.toLowerCase(),
      _n_scale: scale.toString().toLowerCase(),
      _n_qr: qr.toString().toLowerCase()
    });
  }
  return result;
}

function setProductsFromArray(arr) {
  products = arr;
  excelStatus.textContent = `ØªÙ… ØªØ­Ù…ÙŠÙ„ ${products.length} ØµÙ`;
  statusEl.textContent = "Ù…Ù„Ù ÙØ¹Ø§Ù„";
  statusEl.className = "active";
}

/* Ø­Ø§ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù…Ù† Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù„Ø¯ */
function tryLoadDefaultExcel() {
  fetch('product.template(176).xlsx')
    .then(res => {
      if (!res.ok) throw new Error('not found');
      return res.arrayBuffer();
    })
    .then(buf => {
      const arr = parseExcelArrayBuffer(buf);
      setProductsFromArray(arr);
    })
    .catch(err => {
      excelStatus.textContent = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø§ÙØªØ±Ø§Ø¶ÙŠ";
      statusEl.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù ÙØ¹Ø§Ù„";
      statusEl.className = "inactive";
      console.warn('default excel load failed', err);
    });
}

/* Ø±ÙØ¹ Ù…Ù„Ù Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
excelFileInput.addEventListener('change', (e) => {
  const f = e.target.files[0];
  if (!f) return;
  const fr = new FileReader();
  fr.onload = (ev) => {
    try {
      const arr = parseExcelArrayBuffer(ev.target.result);
      setProductsFromArray(arr);
    } catch (ex) {
      alert('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø§ÙƒØ³Ù„: ' + ex.message);
      statusEl.textContent = "Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­";
      statusEl.className = "inactive";
    }
  };
  fr.readAsArrayBuffer(f);
});

tryDefaultBtn.addEventListener('click', tryLoadDefaultExcel);

/* Ù†Ø¬Ø±Ø¨ ØªØ­Ù…ÙŠÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡ (Ù…Ø­Ø§ÙˆÙ„Ø© ÙˆØ§Ø­Ø¯Ø©) */
tryLoadDefaultExcel();

/* ============================================================
   ===== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ (Ù…ÙƒØ§Ù†Ù‡Ø§ Ù‡Ù†Ø§) =====
   - pressDigit, backspacePass, submitPass, showError, clearError
   ============================================================ */

// Ø¯Ø¹Ù… Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù…Ù† Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ Ø§Ù„Ø¹Ø§Ø¯ÙŠ Ù„Ù„Ø¨Ø§Â­Ø³ÙˆØ±Ø¯ + Enter
passInput.addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    submitPass();
  } else {
    clearError();
  }
});
passInput.addEventListener('input', clearError);

function pressDigit(d) {
  passInput.value = (passInput.value || "") + d;
  clearError();
}

function backspacePass() {
  passInput.value = (passInput.value || "").slice(0, -1);
  clearError();
}

function submitPass() {
  if ((passInput.value || "") === correctPassword) {
    loginBox.style.display = "none";
    app.style.display = "block";
    app.setAttribute('aria-hidden', 'false');
    clearError();
    // Ø¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø¹Ø¯ Ø§Ù„ÙØªØ­
    setTimeout(()=>{ if (searchBar) searchBar.focus(); }, 150);
  } else {
    showError("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
  }
}

function showError(msg) {
  passErrorBox.textContent = msg;
  passErrorBox.style.display = "block";
}

function clearError() {
  passErrorBox.textContent = "";
  passErrorBox.style.display = "none";
}

/* ============================================================
   ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¨Ø­Ø« ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
   - search: ÙŠØ¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« (ØªØ´Ø§Ø¨Ù‡) ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙ…ÙŠÙ†
   - Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¥Ù„Ù‰ finalResults ØªØ­Ø¯Ø« ÙÙ‚Ø· Ù„Ùˆ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØ·Ø§Ø¨Ù‚ ÙƒØ§Ù…Ù„
     ÙÙŠ Ø­Ù‚Ù„ QR Ø£Ùˆ ÙÙŠ Ø­Ù‚Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù† (scale) â€” ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª
   - Ø¨Ø¹Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£ÙŠ Ù‚Ø±Ø§Ø¡Ø© QR (Ù…Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§)ØŒ ÙŠØªÙ… ØªÙØ±ÙŠØº searchBar Ø¯Ø§Ø¦Ù…Ø§Ù‹
   ============================================================ */

function renderResultsList(list) {
  resultsTbody.innerHTML = "";
  list.forEach(p => {
    const tr = document.createElement('tr');
    const tdName = document.createElement('td'); tdName.textContent = p.name || ""; tr.appendChild(tdName);
    const tdPrice = document.createElement('td'); tdPrice.textContent = p.price || ""; tr.appendChild(tdPrice);
    const tdScale = document.createElement('td'); tdScale.textContent = p.scale || ""; tr.appendChild(tdScale);
    const tdQR = document.createElement('td'); tdQR.textContent = p.qr || ""; tr.appendChild(tdQR);

    const tdAct = document.createElement('td');
    const btnAdd = document.createElement('button');
    btnAdd.className = 'addBtn';
    btnAdd.textContent = 'Ø¥Ø¶Ø§ÙØ©';
    btnAdd.addEventListener('click', () => {
      const added = addToFinal(p);
      if (added) searchBar.value = ""; // Ø¥Ø°Ø§ ØªÙ…Ù‘ Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙØ¹Ù„Ø§Ù‹ Ù†ÙØ±Øº Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø«
    });
    tdAct.appendChild(btnAdd);
    tr.appendChild(tdAct);

    resultsTbody.appendChild(tr);
  });
}

/* Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙŠØ¯ÙˆÙŠ */
function search(fromScanner = false, scannerValue = '') {
  const rawQuery = fromScanner ? (String(scannerValue || "")).trim() : (searchBar.value || "").trim();
  const query = rawQuery.toLowerCase();
  if (!query) {
    // Ù„Ø§ Ø´ÙŠØ¡ Ù„Ù„Ø¨Ø­Ø«
    return;
  }
  if (!Array.isArray(products) || products.length === 0) {
    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª. Ø§Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ Ø£ÙˆÙ„Ø§Ù‹.');
    return;
  }

  // Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ´Ø§Ø¨Ù‡ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (ÙŠÙ…ÙŠÙ†)
  const matched = products.filter(p => (
    (p._n_name && p._n_name.includes(query)) ||
    (p._n_scale && p._n_scale.includes(query)) ||
    (p._n_qr && p._n_qr.includes(query))
  ));
  renderResultsList(matched);

  // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ÙƒØ§Ù…Ù„ (QR Ø£Ùˆ scale) â€” Ù„Ø¥Ø¶Ø§ÙØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
  const exactMatches = products.filter(p => (p._n_qr === query) || (p._n_scale === query));
  if (exactMatches.length > 0) {
    // Ø£Ø¶Ù ÙƒÙ„ Ø§Ù„ØªØ·Ø§Ø¨Ù‚Ø§Øª (Ø¹Ø§Ø¯Ø© ÙˆØ§Ø­Ø¯)
    exactMatches.forEach(p => addToFinal(p));
    // ÙˆØ£ÙØ±Øº Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« Ø¯Ø§Ø¦Ù…Ø§Ù‹ (Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹)
    searchBar.value = "";
  }
  // Ø¨Ø¹Ø¯ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø·Ø¨Ù‚ ÙÙ„ØªØ± ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù† Ù„Ùˆ Ù…ÙØ¹Ù„
  if (scaleFilterActive) applyScaleFilterToTable(resultsTbody);
}

/* Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
searchBtn.addEventListener('click', () => search(false));
clearBtn.addEventListener('click', () => { searchBar.value = ""; resultsTbody.innerHTML = ""; });

/* Ø¯Ø¹Ù… Enter ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« */
searchBar.addEventListener('keydown', function(e){
  if (e.key === 'Enter') {
    e.preventDefault();
    search(false);
  }
});

/* ============================================================
   Ø¬Ø¯ÙˆÙ„ finalResults (Ø§Ù„Ø¥Ø¶Ø§ÙØ©/Ø§Ù„Ø­Ø°Ù/Ø­Ø°Ù Ø§Ù„ÙƒÙ„)
   ============================================================ */

function addToFinal(p) {
  if (!p) return false;
  // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ø¹ØªÙ…Ø§Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ qr Ø£Ùˆ scale
  const exists = Array.from(finalTbody.rows).some(r => {
    const rQr = (r.cells[3] && r.cells[3].textContent) || "";
    const rScale = (r.cells[2] && r.cells[2].textContent) || "";
    return (rQr === p.qr && p.qr !== "") || (rScale === p.scale && p.scale !== "");
  });
  if (exists) return false;

  const tr = document.createElement('tr');
  const tdName = document.createElement('td'); tdName.textContent = p.name || ""; tr.appendChild(tdName);
  const tdPrice = document.createElement('td'); tdPrice.textContent = p.price || ""; tr.appendChild(tdPrice);
  const tdScale = document.createElement('td'); tdScale.textContent = p.scale || ""; tr.appendChild(tdScale);
  const tdQR = document.createElement('td'); tdQR.textContent = p.qr || ""; tr.appendChild(tdQR);

  const tdAct = document.createElement('td');
  const delBtn = document.createElement('button');
  delBtn.className = 'delBtn';
  delBtn.textContent = 'Ø­Ø°Ù';
  delBtn.addEventListener('click', function() {
    this.closest('tr').remove();
    updateClearAllVisibility();
  });
  tdAct.appendChild(delBtn);
  tr.appendChild(tdAct);

  finalTbody.appendChild(tr);
  updateClearAllVisibility();

  if (scaleFilterActive) applyScaleFilterToTable(finalTbody);
  return true;
}

function clearAllSelected() {
  finalTbody.innerHTML = "";
  updateClearAllVisibility();
}

clearAllBtn.addEventListener('click', clearAllSelected);

function updateClearAllVisibility() {
  if (!finalTbody || finalTbody.rows.length === 0) {
    clearAllBtn.style.display = 'none';
  } else {
    clearAllBtn.style.display = 'inline-block';
  }
}

/* ============================================================
   ÙÙ„ØªØ± ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù† (toggle) â€” ÙŠØ®ÙÙŠ Ø§Ù„ØµÙÙˆÙ Ø§Ù„ØªÙŠ Ù„Ø§ ØªØ­ØªÙˆÙŠ Ù‚ÙŠÙ…Ø© ÙÙŠ Ø¹Ù…ÙˆØ¯ ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†
   ============================================================ */

scaleBtn.addEventListener('click', toggleScaleFilter);

function toggleScaleFilter() {
  scaleFilterActive = !scaleFilterActive;
  scaleBtn.classList.toggle('btn', true);
  scaleBtn.classList.toggle('btn.ghost', false);
  if (scaleFilterActive) {
    scaleBtn.style.background = '#ffc107';
    scaleBtn.style.color = '#111';
  } else {
    scaleBtn.style.background = '';
    scaleBtn.style.color = '';
  }
  applyScaleFilterToTable(resultsTbody);
  applyScaleFilterToTable(finalTbody);
  updateClearAllVisibility();
}

function applyScaleFilterToTable(tbody) {
  if (!tbody) return;
  Array.from(tbody.rows).forEach(row => {
    const cell = row.cells[2]; // index 2 => ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†
    const val = cell ? (cell.textContent || "").trim() : "";
    row.style.display = (scaleFilterActive && val === "") ? 'none' : '';
  });
}

/* ============================================================
   Ù‚Ø§Ø±Ø¦ QR (html5-qrcode) â€” Ø¹Ù†Ø¯ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙŠÙÙ†Ø§Ø¯Ù‰ handleQRCodeInput(code)
   - Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©ØŒ searchBar.value ÙŠÙÙØ±Øº Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØ±Ø§ÙƒÙ…
   ============================================================ */

cameraBtn.addEventListener('click', toggleScanner);

function toggleScanner() {
  if (qrScanner) {
    stopScanner();
  } else {
    startScanner();
  }
}

function startScanner() {
  readerDiv.style.display = 'block';
  qrScanner = new Html5Qrcode("reader");
  const config = { fps: 10, qrbox: 250 };
  qrScanner.start({ facingMode: "environment" }, config,
    (decodedText, decodedResult) => {
      // Ø¹Ù†Ø¯ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©:
      handleQRCodeInput(String(decodedText || "").trim());
      // Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£ÙˆÙ‚Ù Ø§Ù„Ù…Ø§Ø³Ø­ (ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª Ø³Ø§Ø¨Ù‚Ù‹Ø§)
      stopScanner();
    },
    (errorMessage) => {
      // Ø£Ø®Ø·Ø§Ø¡ ØµØºÙŠØ±Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø³Ø­ Ù„Ø§ ØªÙØ¹Ø±Ø¶ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯Ø©
      // console.debug('scan error', errorMessage);
    }
  ).catch(err => {
    alert('ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ' + err);
    readerDiv.style.display = 'none';
    qrScanner = null;
  });
}

function stopScanner() {
  if (!qrScanner) { readerDiv.style.display = 'none'; return; }
  qrScanner.stop().then(() => {
    qrScanner.clear();
    qrScanner = null;
    readerDiv.style.display = 'none';
  }).catch(err => {
    console.warn('Error stopping scanner', err);
    readerDiv.style.display = 'none';
    qrScanner = null;
  });
}

/* handleQRCodeInput: ÙŠØ¨Ø­Ø« Ø¹Ù† ØªØ·Ø§Ø¨Ù‚ ÙƒØ§Ù…Ù„ ÙÙŠ Ø¹Ù…ÙˆØ¯ QR Ø£Ùˆ ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù† ÙˆÙŠØ¶ÙŠÙ Ø¥Ø°Ø§ ÙˆØ¬Ø¯.
   Ø§Ù„Ø£Ù‡Ù…: ÙŠÙØ±Øº searchBar Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© (Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹).
*/
function handleQRCodeInput(code) {
  if (!code) {
    searchBar.value = "";
    return;
  }
  const q = code.toLowerCase();
  // Ù†Ø¨Ø­Ø« Ø¹Ù† ØªØ·Ø§Ø¨Ù‚ ÙƒØ§Ù…Ù„ ÙÙŠ qr Ø£Ùˆ scale
  const found = products.find(p => p._n_qr === q || p._n_scale === q);
  if (found) {
    // Ø£Ø¶Ù Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ù…Ø³Ø¨Ù‚Ø§Ù‹
    const already = Array.from(finalTbody.rows).some(r => (r.cells[3] && r.cells[3].textContent) === found.qr || (r.cells[2] && r.cells[2].textContent) === found.scale);
    if (!already) addToFinal(found);
    // Ù†ÙÙØ±Øº Ø§Ù„Ø¨Ø­Ø« Ø¯Ø§Ø¦Ù…Ø§Ù‹ (Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯)
    searchBar.value = "";
  } else {
    // Ù„Ùˆ Ù„Ù… ÙŠÙØ¹Ø«Ø±ØŒ ÙŠÙ…ÙƒÙ† Ø¥Ø¸Ù‡Ø§Ø± Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù†Øµ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    // Ù„ÙƒÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù†ÙØ±Øº Ø§Ù„Ø­Ù‚Ù„ Ù„Ø¹Ø¯Ù… Ø§Ù„ØªØ±Ø§ÙƒÙ…
    searchBar.value = "";
  }
}

/* ============================================================
   Ø³Ù„ÙˆÙƒ Ø¥Ø¶Ø§ÙÙŠ: Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ÙŠØ¯ÙˆÙŠØŒ Ù„Ùˆ query ÙƒØ§Ù† Ù…Ø·Ø§Ø¨Ù‚Ø§Ù‹ ØªÙ…Ø§Ù…Ø§Ù‹ Ù„ÙƒÙˆØ¯ QR Ø£Ùˆ Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†
   Ù†Ø¶ÙŠÙ Ø§Ù„Ù…Ù†ØªØ¬ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (Ø«Ù… Ù†ÙÙØ±Øº searchBar). Ù‡Ø°Ø§ ÙŠØºØ·ÙŠ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙŠ Ø·Ù„Ø¨ØªÙ‡Ø§.
   ============================================================ */

function manualSearchHandler() {
  const raw = (searchBar.value || "").trim();
  if (!raw) return;
  search(false); // ÙŠØ¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ´Ø§Ø¨Ù‡ ÙˆÙŠØ¶ÙŠÙ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
}

/* Ø§Ù„Ø¯Ø¹Ù… Ù„Ø²Ø± Ø§Ù„Ø¨Ø­Ø« */
searchBtn.addEventListener('click', manualSearchHandler);

/* ============================================================
   Ø¯Ø¹Ù… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:
   - Enter => Ø¨Ø­Ø«
   - Delete => Ø­Ø°Ù Ø¢Ø®Ø± ØµÙ Ù…Ù† finalResults
   ============================================================ */
document.addEventListener('keydown', (e) => {
  // Ù„Ùˆ Ø§Ù„ØµÙØ­Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
  if (app.style.display === 'block') {
    if (e.key === 'Enter' && document.activeElement !== passInput) {
      e.preventDefault();
      manualSearchHandler();
    } else if (e.key === 'Delete') {
      if (finalTbody && finalTbody.rows.length > 0) {
        finalTbody.deleteRow(finalTbody.rows.length - 1);
        updateClearAllVisibility();
      }
    }
  } else {
    // Ù„Ùˆ ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯: Ù†Ø³Ù…Ø­ Ø¨Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø±Ù‚Ù…ÙŠØ© ÙˆØ§Ù„Ù€ Backspace Ùˆ Enter
    if (loginBox.style.display !== 'none') {
      if (e.key >= '0' && e.key <= '9') {
        // Ø§Ø¶Ù Ø±Ù‚Ù…
        // Ù„ÙƒÙ† Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙƒØªØ¨ ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© ÙØ§Ù„Ø£Ø­Ø¯Ø§Ø« ØªØ¯Ø®Ù„Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        // Ù„Ø°Ù„Ùƒ Ù†Ø¶ÙŠÙ ÙÙ‚Ø· Ù„Ùˆ Ø§Ù„Ø­Ù‚Ù„ Ù„ÙŠØ³ ÙÙŠ Ø§Ù„ØªØ±ÙƒÙŠØ²
        if (document.activeElement !== passInput) pressDigit(e.key);
      } else if (e.key === 'Backspace') {
        backspacePass();
      } else if (e.key === 'Enter') {
        submitPass();
      }
    }
  }
});

/* ============================================================
   Ù…Ù„Ø§Ø­Ø¸Ø© Ù†Ù‡Ø§Ø¦ÙŠØ©: Ø±ÙˆØ§Ø¨Ø· ÙˆÙ…Ù„Ø§Ø­Ø¸Ø§Øª ØªÙ‚Ù†ÙŠØ©
   - Ø§Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù ÙƒÙ€ index.html ÙˆØ¶Ø¹ product.template(176).xlsx ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù„Ø¯ 
     Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©.
   - ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙŠØªØ·Ù„Ø¨ ØµÙØ­Ø© served Ø¹Ø¨Ø± http(s) ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ù…ØªØµÙØ­Ø§ØªØ› 
     ÙØªØ­ Ø§Ù„Ù…Ù„Ù Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¹Ø¨Ø± file:// Ù‚Ø¯ ÙŠÙ…Ù†Ø¹ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.
   - Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ùƒ Ø±Ø¤ÙˆØ³ Ø£Ø¹Ù…Ø¯Ø© Ù…Ø®ØªÙ„ÙØ© ÙÙŠ Ø§Ù„Ø¥ÙƒØ³Ù„ ØºÙŠØ± Ø§Ù„ØªØ±ØªÙŠØ¨ (Ø§Ø³Ù…, Ø³Ø¹Ø±, ÙƒÙˆØ¯ Ù…ÙŠØ²Ø§Ù†, QR)
     Ø£Ø®Ø¨Ø±Ù†ÙŠ Ù„Ø£Ø¹Ø¯Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­ÙˆÙŠÙ„ parseExcelArrayBuffer Ù„ØªØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ ØªØ±ØªÙŠØ¨Ùƒ.
   ============================================================ */

</script>
</body>
</html>
