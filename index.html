<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>بحث المنتجات</title>
  <meta name="viewport" content="width=1200" />
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; direction: rtl; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    #tables { display: flex; gap: 20px; }
    .box { width: 50%; }
    .btn { padding: 6px 12px; margin: 3px; cursor: pointer; }
    #status { margin: 10px 0; font-weight: bold; }
    video { width: 100%; max-height: 250px; border: 1px solid #aaa; margin-top: 10px; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
    .modal-content { background: #fff; padding: 20px; border-radius: 8px; min-width: 300px; text-align: center; }
    .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
    .numpad button { padding: 15px; font-size: 18px; cursor: pointer; }
  </style>
</head>
<body>

  <h2>بحث المنتجات</h2>
  <input type="text" id="searchBar" placeholder="ابحث بالاسم / الكود / QR" style="width:300px; padding:5px;" />
  <button class="btn" onclick="searchProducts()">بحث</button>
  <button class="btn" onclick="toggleFilter()">فلتر كود الميزان</button>
  <button class="btn" onclick="startCamera()">📷 الكاميرا</button>
  <div id="status">جارٍ تحميل الملف...</div>
  <video id="preview" autoplay></video>

  <div id="tables">
    <div class="box">
      <h3>المنتجات المختارة</h3>
      <button class="btn" onclick="clearTable('selectedTable')">حذف الكل</button>
      <button class="btn" onclick="exportExcel()">تصدير إكسل</button>
      <table id="selectedTable">
        <thead>
          <tr>
            <th>اسم</th>
            <th>كود الميزان</th>
            <th>QR</th>
            <th>العدد/الوزن</th>
            <th>تعديل</th>
            <th>حذف</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="box">
      <h3>نتائج البحث</h3>
      <button class="btn" onclick="clearTable('resultsTable')">حذف الكل</button>
      <table id="resultsTable">
        <thead>
          <tr>
            <th>اسم</th>
            <th>كود الميزان</th>
            <th>QR</th>
            <th>استلام</th>
            <th>حذف</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- المودال -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h3 id="modalTitle">إدخال العدد/الوزن</h3>
      <input type="text" id="modalInput" style="width:100%; padding:8px; font-size:16px;" />
      <div class="numpad">
        <button onclick="numpad('1')">1</button>
        <button onclick="numpad('2')">2</button>
        <button onclick="numpad('3')">3</button>
        <button onclick="numpad('4')">4</button>
        <button onclick="numpad('5')">5</button>
        <button onclick="numpad('6')">6</button>
        <button onclick="numpad('7')">7</button>
        <button onclick="numpad('8')">8</button>
        <button onclick="numpad('9')">9</button>
        <button onclick="numpad('.')">.</button>
        <button onclick="numpad('0')">0</button>
        <button onclick="numpadBack()">⌫</button>
      </div>
      <button class="btn" onclick="confirmModal()">تم</button>
      <button class="btn" onclick="closeModal()">إلغاء</button>
    </div>
  </div>

  <!-- مكتبة QR -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <!-- مكتبة XLSX -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    let products = [];
    let filterActive = false;
    let modalMode = "add"; // add or edit
    let currentRow = null;
    let html5QrCode;

    // تحميل الاكسل
    fetch("products.xlsx").then(res => res.arrayBuffer())
      .then(data => {
        let workbook = XLSX.read(new Uint8Array(data), { type: "array" });
        let sheet = workbook.Sheets[workbook.SheetNames[0]];
        products = XLSX.utils.sheet_to_json(sheet);
        document.getElementById("status").textContent = "تم تحميل الملف بنجاح ✅";
      })
      .catch(err => {
        document.getElementById("status").textContent = "فشل تحميل الملف ❌";
      });

    // بحث
    function searchProducts() {
      let q = document.getElementById("searchBar").value.trim();
      let body = document.querySelector("#resultsTable tbody");
      body.innerHTML = "";
      products.forEach(p => {
        if (filterActive && !p["كود الميزان"]) return;
        if (
          (p["اسم"] && p["اسم"].includes(q)) ||
          (p["كود الميزان"] && p["كود الميزان"].toString().includes(q)) ||
          (p["QR"] && p["QR"].toString().includes(q))
        ) {
          let tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${p["اسم"]||""}</td>
            <td>${p["كود الميزان"]||""}</td>
            <td>${p["QR"]||""}</td>
            <td><button onclick="openModal('add', this)">استلام</button></td>
            <td><button onclick="tr.remove()">🗑</button></td>`;
          body.appendChild(tr);
        }
      });
      document.getElementById("searchBar").value = "";
    }

    function toggleFilter() {
      filterActive = !filterActive;
      searchProducts();
    }

    function clearTable(id) {
      document.querySelector("#"+id+" tbody").innerHTML = "";
    }

    // مودال
    function openModal(mode, btn) {
      modalMode = mode;
      currentRow = btn.closest("tr");
      let uid = currentRow.children[2].textContent || currentRow.children[1].textContent;
      if (mode === "edit") {
        document.getElementById("modalInput").value = currentRow.children[3].textContent;
      } else {
        let existing = [...document.querySelectorAll("#selectedTable tbody tr")]
          .find(r => (r.children[2].textContent||r.children[1].textContent)===uid);
        document.getElementById("modalInput").value = existing ? existing.children[3].textContent : "";
      }
      document.getElementById("modal").style.display = "flex";
    }
    function closeModal() { document.getElementById("modal").style.display="none"; }
    function numpad(v){ document.getElementById("modalInput").value += v; }
    function numpadBack(){ 
      let inp=document.getElementById("modalInput");
      inp.value=inp.value.slice(0,-1);
    }

    function confirmModal() {
      let val = document.getElementById("modalInput").value.trim();
      if (!val) { alert("أدخل قيمة صحيحة"); return; }
      if (modalMode === "add") {
        let name=currentRow.children[0].textContent;
        let code=currentRow.children[1].textContent;
        let qr=currentRow.children[2].textContent;
        let uid=qr||code;
        let tbody=document.querySelector("#selectedTable tbody");
        let existing = [...tbody.querySelectorAll("tr")]
          .find(r => (r.children[2].textContent||r.children[1].textContent)===uid);
        if (existing) {
          existing.children[3].textContent = val;
        } else {
          let tr=document.createElement("tr");
          tr.innerHTML=`<td>${name}</td><td>${code}</td><td>${qr}</td>
            <td>${val}</td>
            <td><button onclick="openModal('edit', this)">✏️</button></td>
            <td><button onclick="tr.remove()">🗑</button></td>`;
          tbody.appendChild(tr);
        }
      } else if (modalMode === "edit") {
        currentRow.children[3].textContent = val;
      }
      closeModal();
    }

    // تصدير
    function exportExcel(){
      let rows=[["اسم","كود الميزان","QR","العدد/الوزن"]];
      document.querySelectorAll("#selectedTable tbody tr").forEach(r=>{
        rows.push([
          r.children[0].textContent,
          r.children[1].textContent,
          r.children[2].textContent,
          r.children[3].textContent
        ]);
      });
      let ws=XLSX.utils.aoa_to_sheet(rows);
      let wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Selected");
      XLSX.writeFile(wb, "selected.xlsx");
    }

    // الكاميرا
    function startCamera() {
      if (html5QrCode) {
        html5QrCode.stop(); html5QrCode = null;
        document.getElementById("preview").style.display="none";
        return;
      }
      document.getElementById("preview").style.display="block";
      html5QrCode = new Html5Qrcode("preview");
      Html5Qrcode.getCameras().then(devices=>{
        let cam = devices.find(d=>d.label.toLowerCase().includes("back")) || devices[0];
        html5QrCode.start(
          { deviceId: { exact: cam.id } },
          { fps:10, qrbox:250 },
          msg => { document.getElementById("searchBar").value = msg; },
          err => {}
        );
      }).catch(err=>alert("خطأ بالكاميرا: "+err));
    }
  </script>
</body>
</html>
