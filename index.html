<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <!-- Ø¥Ø¬Ø¨Ø§Ø± Ø¹Ø±Ø¶ desktop Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª -->
  <meta name="viewport" content="width=1024" />
  <title>Ø¨Ø­Ø« ÙˆØ§Ø³ØªÙ„Ø§Ù… Ù…Ù†ØªØ¬Ø§Øª (Ù…Ù† Ù…Ù„Ù Excel)</title>

  <!-- Ù…ÙƒØªØ¨Ø§Øª -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#fff;
      --muted:#6c757d;
      --primary:#0d6efd;
      --danger:#dc3545;
      --success:#198754;
    }
    html,body{height:100%; margin:0; background:var(--bg); font-family:Arial, sans-serif; direction:rtl}
    .wrap{max-width:1100px; margin:18px auto; padding:16px;}
    header{display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:12px}
    header h1{font-size:20px; margin:0;}
    .controls{display:flex; gap:8px; align-items:center}
    input[type="text"]{padding:10px 12px; border-radius:8px; border:1px solid #ddd; width:420px; font-size:15px}
    button.btn{padding:9px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:600}
    button.primary{background:var(--primary); color:#fff}
    button.ghost{background:#e9ecef}
    button.warning{background:var(--danger); color:#fff}
    button.success{background:var(--success); color:#fff}
    #status{position:fixed; top:12px; right:12px; padding:8px 12px; border-radius:8px; color:#fff; font-weight:700; z-index:60}
    #status.inactive{background:var(--danger)}
    #status.active{background:var(--success)}
    .main{display:flex; gap:18px; align-items:flex-start; margin-top:8px; flex-wrap:wrap}
    .col{background:var(--card); padding:12px; border-radius:10px; box-shadow:0 1px 6px rgba(0,0,0,0.05); box-sizing:border-box}
    .col.half{width:48%}
    .col.full{width:100%}
    h3{margin:0 0 8px 0; font-size:16px}
    table{width:100%; border-collapse:collapse; table-layout:fixed; word-wrap:break-word}
    thead th{background:#f2f2f2; padding:8px; border:1px solid #e0e0e0; font-weight:700}
    tbody td{padding:8px; border:1px solid #e6e6e6; text-align:center; vertical-align:middle}
    .small{padding:6px 8px; border-radius:6px; cursor:pointer}
    .addBtn{background:var(--success); color:#fff; border:none}
    .delBtn{background:var(--danger); color:#fff; border:none}
    .ghostBtn{background:#f1f1f1}
    .toolbar{display:flex; gap:8px; align-items:center; margin-bottom:8px; justify-content:space-between}
    .left-tools{display:flex; gap:8px; align-items:center}
    .right-tools{display:flex; gap:8px; align-items:center}
    /* QR reader container */
    #reader { width:320px; margin-top:8px; display:none; }
    @media (max-width:900px){
      .col.half{width:100%}
      #reader{width:100%}
    }

    /* Modal */
    .modal-overlay{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.5); z-index:999}
    .modal{background:#fff; border-radius:10px; padding:14px; width:360px; max-width:95%; box-sizing:border-box;}
    .modal h4{margin:0 0 8px}
    .modal .modal-input{width:100%; padding:10px; font-size:20px; text-align:center; border-radius:8px; border:1px solid #ddd}
    .numpad{display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; margin-top:10px}
    .numpad button{padding:12px; font-size:18px; border-radius:8px; border:1px solid #ccc; background:#f4f4f4; cursor:pointer}
    .modal .actions{display:flex; gap:8px; justify-content:center; margin-top:12px}
  </style>
</head>
<body>
  <div id="status" class="inactive">Ø¬Ø§Ø±Ù Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„...</div>

  <div class="wrap">
    <header>
      <h1>Ù†Ø¸Ø§Ù… Ø¨Ø­Ø« ÙˆØ§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ù…Ù† Ù…Ù„Ù Excel)</h1>
      <div class="controls">
        <div style="display:flex; align-items:center; gap:8px;">
          <input id="searchBar" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù† Ø£Ùˆ QR" aria-label="Ø¨Ø­Ø«">
          <button id="searchBtn" class="btn primary">Ø¨Ø­Ø«</button>
          <button id="clearBtn" class="btn ghost">Ø­Ø°Ù</button>
        </div>

        <div style="display:flex; align-items:center; gap:8px; margin-left:8px;">
          <button id="cameraBtn" class="btn ghost">ğŸ“· ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
          <button id="scaleBtn" class="btn ghost">ğŸ“¶ ÙÙ„ØªØ± ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</button>
        </div>
      </div>
    </header>

    <div class="main">
      <!-- ÙŠÙ…ÙŠÙ†: Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« -->
      <div class="col half" aria-label="Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«">
        <div class="toolbar">
          <div class="left-tools">
            <h3>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</h3>
          </div>
          <div class="right-tools">
            <button id="clearResultsBtn" class="small ghostBtn" style="display:none">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
          </div>
        </div>

        <div id="reader"></div>

        <table id="resultsTable" aria-live="polite">
          <thead>
            <tr>
              <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
              <th>ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</th>
              <th>Ø§Ù„Ø¹Ø¯Ø¯/Ø§Ù„ÙˆØ²Ù†</th>
              <th>QR Code</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Ø´Ù…Ø§Ù„: Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© -->
      <div class="col half" aria-label="Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©">
        <div class="toolbar">
          <div class="left-tools">
            <h3>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</h3>
          </div>
          <div class="right-tools">
            <button id="clearAllBtn" class="small ghostBtn" style="display:none">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
            <button id="exportBtn" class="small primary">ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„</button>
          </div>
        </div>

        <table id="finalTable" aria-live="polite">
          <thead>
            <tr>
              <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
              <th>ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</th>
              <th>Ø§Ù„Ø¹Ø¯Ø¯/Ø§Ù„ÙˆØ²Ù†</th>
              <th>QR Code</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div style="margin-top:14px; color:var(--muted); font-size:14px">
      Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙØ³ØªÙ…Ø¯ Ù…Ù† Ù…Ù„Ù Ø¥ÙƒØ³Ù„ (Ù…Ø­Ù„ÙŠ)Ø› Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù ÙŠØªÙ… Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ Ø³ÙŠØ¹Ø±Ø¶ Ø§Ù„Ù…Ø¤Ø´Ø± \"Ù…Ù„Ù ÙØ¹Ø§Ù„\".
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… -->
  <div class="modal-overlay" id="receiveModal" role="dialog" aria-modal="true">
    <div class="modal">
      <h4 id="modalTitle">Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ù†ØªØ¬</h4>
      <div id="modalName" style="text-align:center; font-weight:700; margin-bottom:8px"></div>
      <input id="modalInput" class="modal-input" inputmode="decimal" placeholder="Ø§Ù„Ø¹Ø¯Ø¯ Ø£Ùˆ Ø§Ù„ÙˆØ²Ù† (Ù…Ø«Ø§Ù„: 2 Ø£Ùˆ 0.5)">
      <div class="numpad" aria-hidden="false" style="margin-top:10px">
        <button onclick="modalKey('7')">7</button>
        <button onclick="modalKey('8')">8</button>
        <button onclick="modalKey('9')">9</button>
        <button onclick="modalKey('4')">4</button>
        <button onclick="modalKey('5')">5</button>
        <button onclick="modalKey('6')">6</button>
        <button onclick="modalKey('1')">1</button>
        <button onclick="modalKey('2')">2</button>
        <button onclick="modalKey('3')">3</button>
        <button onclick="modalBack()">âŒ«</button>
        <button onclick="modalKey('0')">0</button>
        <button onclick="modalKey('.')">.</button>
      </div>
      <div class="actions">
        <button class="btn ghost" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn primary" onclick="confirmModal()">ØªÙ…</button>
      </div>
    </div>
  </div>

  <script>
    /**************************************************************************
     * Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ­Ø§Ù„Ø©
     **************************************************************************/
    let rawExcel = [];            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥ÙƒØ³Ù„ ÙƒÙ…Ø§ Ø£ØªØª (array of arrays)
    let uniqueExcel = [];         // ØµÙÙˆÙ ÙØ±ÙŠØ¯Ø© Ù„Ù„Ø¹Ø±Ø¶ (Ø¨Ø¹Ø¯ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±)
    let duplicatesInExcel = false;
    let displayedDuplicateAlert = false;

    const statusEl = document.getElementById('status');
    const searchBar = document.getElementById('searchBar');
    const searchBtn = document.getElementById('searchBtn');
    const clearBtn = document.getElementById('clearBtn');
    const cameraBtn = document.getElementById('cameraBtn');
    const scaleBtn = document.getElementById('scaleBtn');
    const resultsTbody = document.querySelector('#resultsTable tbody');
    const finalTbody = document.querySelector('#finalTable tbody');
    const clearResultsBtn = document.getElementById('clearResultsBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const exportBtn = document.getElementById('exportBtn');

    const receiveModal = document.getElementById('receiveModal');
    const modalInput = document.getElementById('modalInput');
    const modalName = document.getElementById('modalName');

    // Map Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ© ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ù…Ø§Ù„: uid -> {rowEl, qty, rowData}
    const finalMap = new Map();

    // QR scanner
    let html5QrCode = null;
    let scannerRunning = false;
    let lastScan = { text: null, time: 0 };

    // Ø§Ø³Ù…Ø§Ø¡ Ù…Ù…ÙƒÙ†Ø© Ù„Ù…Ù„Ù Ø§Ù„Ø§ÙƒØ³Ù„ (Ø¨Ù…Ø§ ÙÙŠÙ‡Ø§ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù„ÙŠ Ù‚Ù„Øª Ø¹Ù„ÙŠÙ‡)
    const excelCandidates = [
      "Ø¹Ù†Ø¯Ùƒ.xlsx",
      "Ø¹Ù†Ø¯Ùƒ.xls",
      "product.template(176).xlsx",
      "products.xlsx",
      "product.xlsx",
      "data.xlsx",
      "products_template.xlsx"
    ];

    /**************************************************************************
     * Ù…Ø³Ø§Ø¹Ø¯Ø©: Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù…Ù† ØµÙ (QR Ø£ÙˆÙ„Ù‹Ø§ØŒ Ø«Ù… ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ØŒ Ø«Ù… Ø§Ù„Ø§Ø³Ù…)
     **************************************************************************/
    function getUidFromRow(row){
      const qr = (row[3] || "").toString().trim();
      const code = (row[2] || "").toString().trim();
      const name = (row[0] || "").toString().trim();
      if(qr) return "QR::" + qr;
      if(code) return "CODE::" + code;
      return "NAME::" + name;
    }

    /**************************************************************************
     * Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø§ÙƒØ³Ù„ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡
     **************************************************************************/
    function tryLoadExcel(list){
      let idx = 0;
      function attempt(){
        if(idx >= list.length){
          statusEl.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù ÙØ¹Ø§Ù„";
          statusEl.className = "inactive";
          rawExcel = [];
          uniqueExcel = [];
          return;
        }
        const name = list[idx++];
        fetch(name).then(res=>{
          if(!res.ok) throw new Error("not found");
          return res.arrayBuffer();
        }).then(buff=>{
          try{
            const wb = XLSX.read(new Uint8Array(buff), {type:'array'});
            const sheet = wb.SheetNames[0];
            rawExcel = XLSX.utils.sheet_to_json(wb.Sheets[sheet], { header: 1 }); // array of rows
            statusEl.textContent = "Ù…Ù„Ù ÙØ¹Ø§Ù„: " + name;
            statusEl.className = "active";
            processExcelData();
          }catch(e){
            console.error("Ø®Ø·Ø£ Ù‚Ø±Ø§Ø¡Ø©:", e);
            attempt();
          }
        }).catch(err=>{
          // Ø­Ø§ÙˆÙ„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ§Ù„ÙŠ
          attempt();
        });
      }
      attempt();
    }

    /**************************************************************************
     * Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥ÙƒØ³Ù„: Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ ÙˆØ¥Ø¸Ù‡Ø§Ø± ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
     **************************************************************************/
    function processExcelData(){
      uniqueExcel = [];
      const seen = new Set();
      duplicatesInExcel = false;
      // Ù†ÙØªØ±Ø¶ Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ header Ù„Ø°Ø§ Ù†Ø¨Ø¯Ø£ Ù…Ù† index 1 Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
      const start = 1; // Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ù†ÙØªØ±Ø¶ Ù‡Ù†Ø§Ùƒ header Ù„Ø£Ù† Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ù†ØªØ¬ ØºØ§Ù„Ø¨Ù‹Ø§ ØªØ­ØªÙˆÙŠÙ‡
      for(let i = start; i < rawExcel.length; i++){
        const row = rawExcel[i] || [];
        if(row.length === 0) continue;
        const uid = getUidFromRow(row);
        if(seen.has(uid)){
          duplicatesInExcel = true;
          continue;
        }
        seen.add(uid);
        uniqueExcel.push(row);
      }
      if(duplicatesInExcel && !displayedDuplicateAlert){
        displayedDuplicateAlert = true;
        alert("ØªÙ†Ø¨ÙŠÙ‡: ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…ÙƒØ±Ø±Ø© ÙÙŠ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„. Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ù†Ø³Ø®Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ù…Ù† ÙƒÙ„ Ù…Ù†ØªØ¬ ÙÙŠ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«.");
      }
    }

    /**************************************************************************
     * Ø§Ù„Ø¨Ø­Ø« (Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø§Ø³Ù… Ùˆ Ø§Ù„ÙƒÙˆØ¯ Ùˆ QR)
     **************************************************************************/
    function search(fromScanner=false, value=""){
      const q = fromScanner ? (value+"").trim().toLowerCase() : (searchBar.value||"").trim().toLowerCase();
      resultsTbody.innerHTML = "";
      if(!uniqueExcel || uniqueExcel.length === 0) return;
      const shown = new Set();
      uniqueExcel.forEach(row=>{
        const name = (row[0] || "").toString().toLowerCase();
        const code = (row[2] || "").toString().toLowerCase();
        const qr = (row[3] || "").toString().toLowerCase();
        const uid = getUidFromRow(row);
        if(shown.has(uid)) return;
        if(name.includes(q) || code.includes(q) || qr.includes(q)){
          shown.add(uid);
          const tr = document.createElement('tr');

          const tdName = document.createElement('td'); tdName.textContent = row[0] || ""; tr.appendChild(tdName);
          const tdCode = document.createElement('td'); tdCode.textContent = row[2] || ""; tr.appendChild(tdCode);
          const tdQty = document.createElement('td'); tdQty.textContent = ""; tr.appendChild(tdQty);
          const tdQr = document.createElement('td'); tdQr.textContent = row[3] || ""; tr.appendChild(tdQr);

          const tdAction = document.createElement('td');
          const receiveBtn = document.createElement('button');
          receiveBtn.className = 'small addBtn';
          receiveBtn.textContent = 'Ø§Ø³ØªÙ„Ø§Ù…';
          receiveBtn.addEventListener('click', ()=> openReceiveModal(row));
          tdAction.appendChild(receiveBtn);

          const delBtn = document.createElement('button');
          delBtn.className = 'small delBtn';
          delBtn.textContent = 'Ø­Ø°Ù';
          delBtn.addEventListener('click', ()=> { tr.remove(); checkClearResultsVisibility(); });
          tdAction.appendChild(delBtn);

          tr.appendChild(tdAction);

          // attach rowData for reference (not visible)
          tr.dataset.uid = uid;

          resultsTbody.appendChild(tr);
        }
      });

      applyScaleFilterTo(resultsTbody);
      checkClearResultsVisibility();
    }

    function clearSearch(){
      searchBar.value = "";
      resultsTbody.innerHTML = "";
      checkClearResultsVisibility();
    }

    /**************************************************************************
     * ÙÙ„ØªØ± ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†
     **************************************************************************/
    let scaleFilterActive = false;
    function toggleScaleFilter(){
      scaleFilterActive = !scaleFilterActive;
      scaleBtn.classList.toggle('active', scaleFilterActive);
      applyScaleFilterTo(resultsTbody);
      applyScaleFilterTo(finalTbody);
    }
    function applyScaleFilterTo(tbody){
      if(!tbody) return;
      Array.from(tbody.rows).forEach(row=>{
        const codeCell = row.cells[1]; // index 1 => ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†
        const val = codeCell ? (codeCell.textContent||"").trim() : "";
        row.style.display = (scaleFilterActive && val === "") ? 'none' : '';
      });
    }

    /**************************************************************************
     * Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…: ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚/Ù…ÙØªØ§Ø­/ØªØ£ÙƒÙŠØ¯
     **************************************************************************/
    let modalCurrentRowData = null; // array rowData

    function openReceiveModal(rowData){
      modalCurrentRowData = rowData;
      const uid = getUidFromRow(rowData);
      modalName.textContent = rowData[0] || '';
      // Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ finalMap Ù†Ù…Ù„Ø£ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      if(finalMap.has(uid)){
        modalInput.value = finalMap.get(uid).qty || "";
      } else {
        modalInput.value = "";
      }
      receiveModal.style.display = 'flex';
      setTimeout(()=> modalInput.focus(), 120);
    }

    function closeModal(){
      receiveModal.style.display = 'none';
      modalCurrentRowData = null;
      modalInput.value = "";
    }

    function modalKey(ch){
      // Ù…Ù†Ø¹ Ù†Ù‚Ø·ØªÙŠÙ†
      if(ch === '.' && (modalInput.value||'').includes('.')) return;
      modalInput.value = (modalInput.value || '') + ch;
      modalInput.focus();
    }

    function modalBack(){
      modalInput.value = (modalInput.value || '').slice(0,-1);
      modalInput.focus();
    }

    function confirmModal(){
      const v = (modalInput.value || '').trim();
      if(v === ''){
        alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ±Ùƒ Ø§Ù„Ø­Ù‚Ù„ ÙØ§Ø±ØºØ§Ù‹');
        modalInput.focus();
        return;
      }
      // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¹Ø´Ø±Ø§Øª: ØªØ­Ù‚Ù‚ Ø±Ù‚Ù…ÙŠ
      const num = Number(v);
      if(!isFinite(num)){
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ§Ù„Ø­ Ù„Ù„Ø¹Ø¯Ø¯/Ø§Ù„ÙˆØ²Ù†');
        modalInput.focus();
        return;
      }
      // Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ù…Ø§Ù„ (Ù†Ø³Ø®Ø© ÙÙ‚Ø·)
      addOrUpdateFinal(modalCurrentRowData, v);
      closeModal();
    }

    /**************************************************************************
     * Ø¥Ø¯Ø§Ø±Ø© Ø¬Ø¯ÙˆÙ„ final (Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©)
     **************************************************************************/
    function addOrUpdateFinal(rowData, qty){
      const uid = getUidFromRow(rowData);
      // Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯ -> Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù‚ÙŠÙ…Ø© ÙÙ‚Ø·
      if(finalMap.has(uid)){
        const entry = finalMap.get(uid);
        entry.qty = qty;
        if(entry.rowEl){
          entry.rowEl.cells[2].textContent = qty; // Ø§Ù„Ø¹Ø¯Ø¯/Ø§Ù„ÙˆØ²Ù† Ù‡Ùˆ Ø§Ù„Ø®Ù„ÙŠØ© index 2
        }
        return;
      }
      // Ø¥Ù†Ø´Ø§Ø¡ ØµÙ Ø¬Ø¯ÙŠØ¯
      const tr = document.createElement('tr');
      const tdName = document.createElement('td'); tdName.textContent = rowData[0] || ""; tr.appendChild(tdName);
      const tdCode = document.createElement('td'); tdCode.textContent = rowData[2] || ""; tr.appendChild(tdCode);
      const tdQty = document.createElement('td'); tdQty.textContent = qty; tr.appendChild(tdQty);
      const tdQr = document.createElement('td'); tdQr.textContent = rowData[3] || ""; tr.appendChild(tdQr);

      const tdAction = document.createElement('td');
      const delBtn = document.createElement('button');
      delBtn.className = 'small delBtn';
      delBtn.textContent = 'Ø­Ø°Ù';
      delBtn.addEventListener('click', ()=>{
        tr.remove();
        finalMap.delete(uid);
        checkClearAllVisibility();
      });
      tdAction.appendChild(delBtn);
      tr.appendChild(tdAction);

      finalTbody.appendChild(tr);
      finalMap.set(uid, { rowEl: tr, qty: qty, rowData: rowData });
      applyScaleFilterTo(finalTbody);
      checkClearAllVisibility();
    }

    function clearAllSelected(){
      finalTbody.innerHTML = "";
      finalMap.clear();
      checkClearAllVisibility();
    }

    function checkClearAllVisibility(){
      clearAllBtn.style.display = (finalTbody.rows.length === 0) ? 'none' : 'inline-block';
    }

    function checkClearResultsVisibility(){
      clearResultsBtn.style.display = (resultsTbody.rows.length === 0) ? 'none' : 'inline-block';
    }

    /**************************************************************************
     * Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ø±Ø¶ - ØªÙ… Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡ ÙÙŠ uniqueExcel
     * Ù„ÙƒÙ† Ø£ÙŠØ¶Ø§Ù‹ Ù†ØªØ£ÙƒØ¯ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø£Ù† finalMap Ù„Ø§ ØªØ³Ù…Ø­ Ø¨ØªÙƒØ±Ø§Ø±
     **************************************************************************/

    /**************************************************************************
     * ØªØµØ¯ÙŠØ± Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø´Ù…Ø§Ù„ Ø¥Ù„Ù‰ Ø¥ÙƒØ³Ù„
     **************************************************************************/
    function exportFinalToExcel(){
      // Ù†Ø¬Ù‡Ø² Ù…ØµÙÙˆÙØ© AOA: header + rows
      const aoa = [["Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬", "ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†", "Ø§Ù„Ø¹Ø¯Ø¯/Ø§Ù„ÙˆØ²Ù†", "QR Code"]];
      Array.from(finalTbody.rows).forEach(r=>{
        const name = (r.cells[0] && r.cells[0].textContent) || "";
        const code = (r.cells[1] && r.cells[1].textContent) || "";
        const qty = (r.cells[2] && r.cells[2].textContent) || "";
        const qr = (r.cells[3] && r.cells[3].textContent) || "";
        aoa.push([name, code, qty, qr]);
      });
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(aoa);
      XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª");
      XLSX.writeFile(wb, "exported_products.xlsx");
    }

    /**************************************************************************
     * Ù‚Ø§Ø±Ø¦ QR: ÙŠØ¶Ø¹ Ø§Ù„Ù‚ÙŠÙ…Ø© ÙÙŠ searchBar ÙÙ‚Ø· (Ù„Ø§ ÙŠØ¶ÙŠÙ ÙˆÙ„Ø§ ÙŠØ¨Ø­Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)
     **************************************************************************/
    function toggleScanner(){
      if(scannerRunning){
        stopScanner();
      } else {
        startScanner();
      }
    }

    async function startScanner(){
      const readerEl = document.getElementById('reader');
      readerEl.style.display = 'block';
      cameraBtn.textContent = 'â¹ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§';
      try{
        html5QrCode = new Html5Qrcode("reader");
        const devices = await Html5Qrcode.getCameras();
        const cameraId = (devices && devices.length) ? devices[0].id : null;
        await html5QrCode.start(
          cameraId ? cameraId : { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          (decodedText, decodedResult) => {
            const now = Date.now();
            if(decodedText === lastScan.text && (now - lastScan.time) < 600) {
              lastScan.time = now;
              return;
            }
            lastScan.text = decodedText;
            lastScan.time = now;
            // ÙÙ‚Ø· Ù†Ù†Ø³Ø® Ø§Ù„Ù†Øµ Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« ÙˆÙ„Ø§ Ù†Ø¨Ø­Ø« Ø£Ùˆ Ù†Ø¶ÙŠÙ
            searchBar.value = decodedText;
            searchBar.focus();
            // Ø¨Ø¹Ø¯ ÙˆØ¶Ø¹ Ø§Ù„Ù‚ÙŠÙ…Ø© Ù†ÙˆÙ‚Ù Ø§Ù„Ù…Ø§Ø³Ø­ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„ÙŠÙ‚Ø±Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ØªÙ‰ ÙŠØ´ØºÙ„Ù‡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
            stopScanner();
          },
          (errorMessage) => {
            // ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ÙØ±ÙŠÙ…Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø©
          }
        );
        scannerRunning = true;
      }catch(err){
        alert('ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ' + err);
        readerEl.style.display = 'none';
        cameraBtn.textContent = 'ğŸ“· ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§';
        scannerRunning = false;
      }
    }

    function stopScanner(){
      const readerEl = document.getElementById('reader');
      if(html5QrCode){
        html5QrCode.stop().then(()=> {
          try{ html5QrCode.clear(); }catch(e){}
          html5QrCode = null;
        }).catch(()=>{ html5QrCode = null; });
      }
      readerEl.style.display = 'none';
      cameraBtn.textContent = 'ğŸ“· ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§';
      scannerRunning = false;
    }

    /**************************************************************************
     * ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
     **************************************************************************/
    // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…
    searchBtn.addEventListener('click', ()=> search(false));
    clearBtn.addEventListener('click', clearSearch);
    cameraBtn.addEventListener('click', toggleScanner);
    scaleBtn.addEventListener('click', toggleScaleFilter);
    clearResultsBtn.addEventListener('click', ()=> { resultsTbody.innerHTML = ""; checkClearResultsVisibility(); });
    clearAllBtn.addEventListener('click', clearAllSelected);
    exportBtn.addEventListener('click', exportFinalToExcel);

    // ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Enter Ø¹Ù„Ù‰ Ø§Ù„ØµÙ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ù…Ù† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« (Ø¯Ø¹Ù… Ù„ÙˆØ­Ø© Ù…ÙØ§ØªÙŠØ­)
    document.addEventListener('keydown', function(e){
      if(e.key === 'Enter' && document.activeElement !== modalInput) {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ Ù†ØªÙŠØ¬Ø© Ù…Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ²ØŒ Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„Ø¨Ø­Ø«
        if(document.activeElement === searchBar) {
          e.preventDefault();
          search(false);
        }
      }
      if(e.key === 'Delete') {
        // Ø­Ø°Ù Ø¢Ø®Ø± ØµÙ ÙÙŠ final
        if(finalTbody.rows.length > 0){
          finalTbody.deleteRow(finalTbody.rows.length - 1);
          // Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
          rebuildFinalMapFromDom();
          checkClearAllVisibility();
        }
      }
    });

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªÙÙˆÙŠØ¶ Ù„Ø§Ù„ØªÙ‚Ø§Ø· Ø²Ø± Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… ÙÙŠ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« (Ø¨Ù…Ø§ Ø£Ù† Ø§Ù„ØµÙÙˆÙ ØªÙÙ†Ø´Ø£ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹)
    resultsTbody.addEventListener('click', function(e){
      const btn = e.target.closest('button');
      if(!btn) return;
      if(btn.textContent && btn.textContent.indexOf('Ø§Ø³ØªÙ„Ø§Ù…') !== -1){
        // Ø¥ÙŠØ¬Ø§Ø¯ ØµÙ Ø£Ø¨
        const tr = btn.closest('tr');
        // Ù†Ø­ØªØ§Ø¬ Ù„Ø¥ÙŠØ¬Ø§Ø¯ rowData ÙÙŠ uniqueExcel Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… uid
        // uid Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ tr.dataset.uid? (Ù„Ù… Ù†Ø¶Ø¹Ù‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©). ÙÙ„Ù†Ø­Ø³Ø¨ uid Ù…Ù† Ø§Ù„Ø®Ù„Ø§ÙŠØ§
        const name = (tr.cells[0] && tr.cells[0].textContent) || "";
        const code = (tr.cells[1] && tr.cells[1].textContent) || "";
        const qr = (tr.cells[3] && tr.cells[3].textContent) || "";
        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ uniqueExcel Ø¹Ù† ØµÙ ÙŠØ·Ø§Ø¨Ù‚ Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const rowData = uniqueExcel.find(r => {
          const rn = (r[0]||"").toString(), rc = (r[2]||"").toString(), rq = (r[3]||"").toString();
          return rn === name && rc === code && rq === qr;
        });
        if(rowData){
          openReceiveModal(rowData);
        } else {
          // ÙƒØ§Ø­ØªÙŠØ§Ø·ØŒ Ù†Ø¨Ù†ÙŠ ØµÙ Ù…Ø¤Ù‚Øª Ù…Ù† Ø§Ù„Ø®Ù„Ø§ÙŠØ§
          openReceiveModal([name, '', code, qr]);
        }
      }
    });

    // Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ finalMap Ø¥Ø°Ø§ ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙÙŠ DOM
    function rebuildFinalMapFromDom(){
      finalMap.clear();
      Array.from(finalTbody.rows).forEach(r=>{
        const name = (r.cells[0] && r.cells[0].textContent) || "";
        const code = (r.cells[1] && r.cells[1].textContent) || "";
        const qty = (r.cells[2] && r.cells[2].textContent) || "";
        const qr = (r.cells[3] && r.cells[3].textContent) || "";
        const rowData = [name, '', code, qr];
        const uid = getUidFromRow(rowData);
        finalMap.set(uid, { rowEl: r, qty: qty, rowData: rowData });
      });
    }

    /**************************************************************************
     * ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¹Ù†Ø¯ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© ÙˆØªØ¬Ù‡ÙŠØ² Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
     **************************************************************************/
    window.addEventListener('load', function(){
      tryLoadExcel(excelCandidates);
      // ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø«
      setTimeout(()=>{ try{ searchBar.focus(); }catch(e){} }, 200);
      checkClearAllVisibility();
      checkClearResultsVisibility();
    });

    /**************************************************************************
     * Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„: Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
     **************************************************************************/
    receiveModal.addEventListener('click', function(e){
      if(e.target === receiveModal) closeModal();
    });

    /**************************************************************************
     * Ù…Ø³Ø§Ø¹Ø¯Ø©: Ø¥Ø¹Ø§Ø¯Ø© ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø¨Ø¹Ø¯ Ø£ÙŠ ØªØºÙŠÙŠØ± DOM
     **************************************************************************/
    const observerFinal = new MutationObserver(()=> applyScaleFilterTo(finalTbody));
    observerFinal.observe(finalTbody, { childList:true, subtree:true });

  </script>
</body>
</html>