<!DOCTYPE html><html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=1024" />
  <title>Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>  <!-- Ù…ÙƒØªØ¨Ø§Øª -->  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>  <script src="https://unpkg.com/html5-qrcode@2.3.8"></script>  <style>
    :root {
      --card-bg: #ffffff;
      --muted: #6c757d;
      --primary: #0d6efd;
      --success: #28a745;
      --danger: #dc3545;
      --accent: #20c997;
    }
    body {
      font-family: Arial, sans-serif;
      background: #f6f7fb;
      color: #222;
      margin: 0;
      padding: 18px;
      box-sizing: border-box;
      direction: rtl;
    }
    h2 { text-align: center; margin: 6px 0 12px; }

    /* Ù…Ø¤Ø´Ø± Ø­Ø§Ù„Ø© Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ */
    #status {
      position: fixed;
      top: 12px;
      right: 12px;
      padding: 8px 12px;
      border-radius: 6px;
      color: #fff;
      font-weight: 700;
      z-index: 60;
    }
    #status.active { background: var(--success); }
    #status.inactive { background: var(--danger); }

    /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ */
    #loginBox {
      background: var(--card-bg);
      padding: 14px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      max-width: 420px;
      margin: 10px auto;
      text-align: center;
    }
    #passwordInput {
      width: 100%;
      max-width: 260px;
      padding: 10px;
      font-size: 20px;
      text-align: center;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .numpad {
      width: 260px;
      margin: 12px auto 0;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    .numpad button {
      padding: 12px;
      font-size: 18px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #f3f3f3;
      cursor: pointer;
    }
    #passError {
      display: none;
      margin-top: 10px;
      color: #842029;
      background: #f8d7da;
      border: 1px solid #f5c2c7;
      padding: 8px 10px;
      border-radius: 6px;
      width: 90%;
      max-width: 320px;
      margin-inline: auto;
      box-sizing: border-box;
    }

    /* Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
    #app {
      display: none;
      margin-top: 14px;
    }
    .searchRow {
      text-align: center;
      margin-bottom: 12px;
    }
    #searchBar {
      width: 60%;
      max-width: 520px;
      padding: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ddd;
      box-sizing: border-box;
      display: inline-block;
    }
    .btn {
      padding: 10px 14px;
      margin: 0 6px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 15px;
    }
    .btn.primary { background: var(--primary); color: #fff; }
    .btn.ghost { background: #e9ecef; }
    .btn.camera { background: var(--accent); color: #fff; }
    .btn.scale-active { background: #ffc107; color: #111; }

    #reader {
      width: 320px;
      margin: 10px auto;
      display: none;
    }

    .tables {
      display: flex;
      gap: 18px;
      justify-content: space-between;
      align-items: flex-start;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    .col {
      width: 48%;
      background: var(--card-bg);
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.04);
      box-sizing: border-box;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      word-wrap: break-word;
    }
    thead th {
      background: #f2f2f2;
      padding: 8px;
      border: 1px solid #ddd;
      font-weight: 600;
    }
    tbody td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: center;
      vertical-align: middle;
    }

    /* Ø£Ø¹Ù…Ø¯Ø© Ø¨Ø¹Ø±Ø¶ Ø«Ø§Ø¨Øª (Ù†Ø³Ø¨) */
    table th:nth-child(1), table td:nth-child(1) { width: 36%; }
    table th:nth-child(2), table td:nth-child(2) { width: 18%; }
    table th:nth-child(3), table td:nth-child(3) { width: 18%; }
    table th:nth-child(4), table td:nth-child(4) { width: 28%; }

    .addBtn { background: #198754; color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
    .delBtn { background: var(--danger); color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
    .smallBtn { padding:6px 8px; border-radius:6px; border:none; cursor:pointer; }
    #clearAllBtn { background: var(--danger); color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; margin-bottom:8px; display:none; }
    #clearResultsBtn { background: var(--danger); color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; margin-bottom:8px; display:none; }
    #exportBtn { background: var(--primary); color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; margin-bottom:8px; }

    /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .modal { background: #fff; border-radius: 10px; padding: 16px; width: 360px; max-width: 95%; box-sizing: border-box; }
    .modal h4 { margin: 0 0 10px; text-align: center; }
    .modal .modal-input { width: 100%; padding: 10px; font-size: 20px; text-align: center; border: 1px solid #ddd; border-radius: 8px; }
    .modal .numpad-modal { margin-top: 12px; display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; }
    .modal .numpad-modal button { padding: 12px; font-size: 18px; border-radius: 8px; border: 1px solid #ccc; background: #f3f3f3; cursor: pointer; }
    .modal .modal-actions { margin-top: 12px; display:flex; gap:8px; justify-content: center; }

    @media (max-width: 900px) {
      .tables { flex-direction: column; }
      .col { width: 100%; }
      #reader { width: 100%; }
      #searchBar { width: 85%; }
    }
  </style></head>
<body>
  <h2>Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>  <!-- Ù…Ø¤Ø´Ø± Ø­Ø§Ù„Ø© Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ -->  <div id="status" class="inactive">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥ÙƒØ³Ù„...</div>  <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ -->  <div id="loginBox" aria-live="polite">
    <input id="passwordInput" type="password" placeholder="Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" aria-label="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <div class="numpad" style="margin-top:12px;">
      <button onclick="pressDigit('1')">1</button>
      <button onclick="pressDigit('2')">2</button>
      <button onclick="pressDigit('3')">3</button>
      <button onclick="pressDigit('4')">4</button>
      <button onclick="pressDigit('5')">5</button>
      <button onclick="pressDigit('6')">6</button>
      <button onclick="pressDigit('7')">7</button>
      <button onclick="pressDigit('8')">8</button>
      <button onclick="pressDigit('9')">9</button>
      <button onclick="backspacePass()">âŒ«</button>
      <button onclick="pressDigit('0')">0</button>
      <button onclick="submitPass()">â</button>
    </div><!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø© -->
<div id="passError" role="alert" aria-live="assertive"></div>

  </div>  <!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->  <div id="app">
    <div class="searchRow" role="region" aria-label="Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø«">
      <input id="searchBar" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£Ùˆ ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬" aria-label="Ø¨Ø­Ø«">
      <button id="searchBtn" class="btn primary" onclick="search(false)">Ø¨Ø­Ø«</button>
      <button id="clearBtn" class="btn ghost" onclick="clearSearch()">Ø­Ø°Ù</button>
      <button id="cameraBtn" class="btn camera" onclick="toggleScanner('qr')">ğŸ“· QR</button>
      <button id="scaleBtn" class="btn camera" onclick="toggleScaleFilter()">ğŸ“¶ ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</button>
    </div><!-- Ù‚Ø§Ø±Ø¦ QR ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
<div id="reader" aria-hidden="true"></div>

<div class="tables">
  <!-- Ø¬Ø¯ÙˆÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« (ÙŠÙ…ÙŠÙ†) -->
  <div class="col" aria-label="Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«">
    <h3>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</h3>
    <div style="text-align:left; margin-bottom:6px;">
      <button id="clearResultsBtn" onclick="clearResults()">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
    </div>
    <table id="results" aria-live="polite">
      <thead>
        <tr>
          <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
          <th>ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</th>
          <th>Ø§Ù„Ø¹Ø¯Ø¯/Ø§Ù„ÙˆØ²Ù†</th>
          <th>QR Code</th>
          <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© (Ø´Ù…Ø§Ù„) -->
  <div class="col" aria-label="Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©">
    <h3>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</h3>
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
      <div>
        <button id="clearAllBtn" onclick="clearAllSelected()">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
      </div>
      <div>
        <button id="exportBtn" onclick="exportFinalToExcel()">ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„</button>
      </div>
    </div>
    <table id="finalResults" aria-live="polite">
      <thead>
        <tr>
          <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
          <th>ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</th>
          <th>Ø§Ù„Ø¹Ø¯Ø¯/Ø§Ù„ÙˆØ²Ù†</th>
          <th>QR Code</th>
          <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

  </div>  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… -->  <div class="modal-overlay" id="receiveModal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h4 id="modalTitle">Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù†ØªØ¬</h4>
      <div style="margin-bottom:8px; text-align:center; font-weight:600;" id="modalProductName"></div>
      <input id="modalQty" class="modal-input" inputmode="decimal" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø£Ùˆ Ø§Ù„ÙˆØ²Ù† (Ù…Ø«Ø§Ù„: 2 Ø£Ùˆ 0.5)">
      <div class="numpad-modal" style="margin-top:12px;">
        <button onclick="modalPress('7')">7</button>
        <button onclick="modalPress('8')">8</button>
        <button onclick="modalPress('9')">9</button>
        <button onclick="modalPress('4')">4</button>
        <button onclick="modalPress('5')">5</button>
        <button onclick="modalPress('6')">6</button>
        <button onclick="modalPress('1')">1</button>
        <button onclick="modalPress('2')">2</button>
        <button onclick="modalPress('3')">3</button>
        <button onclick="modalBackspace()">âŒ«</button>
        <button onclick="modalPress('0')">0</button>
        <button onclick="modalPress('.')">.</button>
      </div>
      <div class="modal-actions">
        <button class="smallBtn" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="smallBtn" onclick="confirmModal()">ØªÙ…</button>
      </div>
    </div>
  </div>  <script>
    /**************************************************************************
     * Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
     **************************************************************************/
    let excelData = [];        // raw rows
    let uniqueExcelData = [];  // filtered unique rows for display
    let qrScanner = null;      // Ù…Ø«ÙŠÙ„ html5-qrcode
    let scanningMode = null;   // 'qr' Ø£Ùˆ null
    let scaleFilterActive = false;
    const correctPassword = "10100"; // Ø¹Ø¯Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ùˆ ØªØ­ØªØ§Ø¬

    /* Ø¹Ù†Ø§ØµØ± DOM Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
    const statusEl = document.getElementById('status');
    const loginBox = document.getElementById('loginBox');
    const passwordInput = document.getElementById('passwordInput');
    const passErrorBox = document.getElementById('passError');
    const app = document.getElementById('app');

    const searchBar = document.getElementById('searchBar');
    const resultsTbody = document.querySelector('#results tbody');
    const finalTbody = document.querySelector('#finalResults tbody');
    const reader = document.getElementById('reader');
    const clearAllBtnEl = document.getElementById('clearAllBtn');
    const clearResultsBtnEl = document.getElementById('clearResultsBtn');
    const scaleBtnEl = document.getElementById('scaleBtn');

    const headers = ["Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬", "Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬", "ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†", "QR Code"]; // for parsing assumption

    // maps for fast lookup
    const finalMap = new Map(); // uniqueId -> {rowEl, qty}

    /**************************************************************************
     * ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ (Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù„Ø¹Ø¯Ø© Ø£Ø³Ù…Ø§Ø¡)
     **************************************************************************/
    const excelCandidates = [
      "product.template(176).xlsx",
      "products.xlsx",
      "product.xlsx",
      "data.xlsx",
      "products_template.xlsx"
    ];

    function tryLoadExcelList(list) {
      let idx = 0;
      function tryNext() {
        if (idx >= list.length) {
          statusEl.textContent = "ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø£ÙŠ Ù…Ù„Ù Ø¥ÙƒØ³Ù„";
          statusEl.className = 'inactive';
          return;
        }
        const name = list[idx++];
        fetch(name).then(res => {
          if (!res.ok) throw new Error('not found');
          return res.arrayBuffer();
        }).then(data => {
          try {
            const workbook = XLSX.read(new Uint8Array(data), { type: 'array' });
            const firstSheet = workbook.SheetNames[0];
            excelData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet], { header: 1 });
            statusEl.textContent = "Ù…Ù„Ù ÙØ¹Ø§Ù„: " + name;
            statusEl.className = 'active';
            processExcelData();
          } catch (err) {
            console.error('Ø®Ø·Ø£ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥ÙƒØ³Ù„:', err);
            tryNext();
          }
        }).catch(err => {
          console.warn('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰:', name);
          tryNext();
        });
      }
      tryNext();
    }

    tryLoadExcelList(excelCandidates);

    /**************************************************************************
     * Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥ÙƒØ³Ù„: Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª Ù…Ù† Ø§Ù„Ø¹Ø±Ø¶ ÙˆØªÙ†Ø¨ÙŠÙ‡ ÙˆØ§Ø­Ø¯ Ù„Ùˆ ÙÙŠ ØªÙƒØ±Ø§Ø±Ø§Øª
     **************************************************************************/
    function getUniqueIdFromRow(row) {
      const qr = (row[3] || "").toString().trim();
      const code = (row[2] || "").toString().trim();
      if (qr) return 'QR::' + qr;
      if (code) return 'CODE::' + code;
      // fallback: use name
      const name = (row[0] || "").toString().trim();
      return 'NAME::' + name;
    }

    function processExcelData() {
      uniqueExcelData = [];
      const seen = new Map();
      let duplicatesFound = false;
      for (let i = 1; i < excelData.length; i++) {
        const row = excelData[i] || [];
        if (!row || row.length === 0) continue;
        const uid = getUniqueIdFromRow(row);
        if (seen.has(uid)) {
          duplicatesFound = true;
          continue; // skip adding duplicate for display
        }
        seen.set(uid, true);
        uniqueExcelData.push(row);
      }
      if (duplicatesFound) {
        alert('Ù…Ù„Ø§Ø­Ø¸Ø©: ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…ÙƒØ±Ø±Ø© ÙÙŠ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„. Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ù†Ø³Ø®Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ù…Ù† ÙƒÙ„ Ù…Ù†ØªØ¬ ÙÙŠ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«.');
      }
      statusEl.textContent = statusEl.className.includes('active') ? statusEl.textContent + ' (Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨Ø­Ø«)' : statusEl.textContent;
    }

    /**************************************************************************
     * --------------------  Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ (Ù…ÙƒØ§Ù†Ù‡Ø§ Ù‡Ù†Ø§)  -----------------------
     **************************************************************************/

    passwordInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        submitPass();
      } else {
        clearError();
      }
    });

    passwordInput.addEventListener('input', function() {
      clearError();
    });

    function pressDigit(d) {
      passwordInput.focus();
      passwordInput.value = (passwordInput.value || "") + d;
      clearError();
    }

    function backspacePass() {
      passwordInput.focus();
      passwordInput.value = (passwordInput.value || "").slice(0, -1);
      clearError();
    }

    function submitPass() {
      if ((passwordInput.value || "") === correctPassword) {
        loginBox.style.display = "none";
        app.style.display = "block";
        clearError();
        setTimeout(() => { if (searchBar) searchBar.focus(); }, 150);
      } else {
        showError("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
      }
    }

    function showError(msg) {
      if (!passErrorBox) return;
      passErrorBox.textContent = msg;
      passErrorBox.style.display = "block";
    }

    function clearError() {
      if (!passErrorBox) return;
      passErrorBox.textContent = "";
      passErrorBox.style.display = "none";
    }

    /**************************************************************************
     * Ø¯Ø¹Ù… Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ Ø§Ù„Ø¹Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© (Enter Ù„Ù„Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŒ Delete Ù„Ø­Ø°Ù Ø¢Ø®Ø± ØµÙ)
     **************************************************************************/
    document.addEventListener('keydown', function(e) {
      if (app.style.display === 'block') {
        if (e.key === 'Enter') {
          if (document.activeElement === passwordInput) return;
          e.preventDefault();
          search(false);
        } else if (e.key === 'Delete') {
          if (finalTbody && finalTbody.rows.length > 0) {
            finalTbody.deleteRow(finalTbody.rows.length - 1);
            syncFinalMapFromDom();
            checkClearAllVisibility();
          }
        }
      }
    });

    /**************************************************************************
     * Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¨Ø­Ø« ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
     **************************************************************************/
    function search(fromScanner = false, scannerType = '', value = '') {
      const query = fromScanner ? (value + "").trim().toLowerCase() : (searchBar.value || "").trim().toLowerCase();
      if (!query) {
        if (fromScanner) {
          searchBar.value = "";
          searchBar.dispatchEvent(new Event('input'));
        }
        return;
      }
      if (!Array.isArray(uniqueExcelData) || uniqueExcelData.length === 0) return;

      resultsTbody.innerHTML = "";

      const shownUids = new Set();
      uniqueExcelData.forEach((row) => {
        const a = (row[0] || "").toString().toLowerCase(); // Ø§Ø³Ù…
        const b = (row[1] || "").toString();               // Ø³Ø¹Ø± (ignored)
        const c = (row[2] || "").toString().toLowerCase(); // ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†
        const d = (row[3] || "").toString().toLowerCase(); // QR

        const uid = getUniqueIdFromRow(row);
        if (shownUids.has(uid)) return; // already shown

        if (a.includes(query) || c.includes(query) || d.includes(query)) {
          shownUids.add(uid);

          const tr = document.createElement('tr');
          const td0 = document.createElement('td'); td0.textContent = row[0] || ""; tr.appendChild(td0);
          const td1 = document.createElement('td'); td1.textContent = row[2] || ""; tr.appendChild(td1); // ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†
          const td2 = document.createElement('td'); td2.textContent = ""; tr.appendChild(td2); // Ø§Ù„Ø¹Ø¯Ø¯/Ø§Ù„ÙˆØ²Ù† ÙØ§Ø±Øº Ø§ÙØªØ±Ø§Ø¶ÙŠ
          const td3 = document.createElement('td'); td3.textContent = row[3] || ""; tr.appendChild(td3);

          const tdAction = document.createElement('td');
          const receiveBtn = document.createElement('button');
          receiveBtn.className = 'addBtn';
          receiveBtn.textContent = 'Ø§Ø³ØªÙ„Ø§Ù…';
          receiveBtn.addEventListener('click', function() {
            openReceiveModal(row);
          });
          tdAction.appendChild(receiveBtn);
          const delBtn = document.createElement('button');
          delBtn.className = 'delBtn';
          delBtn.textContent = 'Ø­Ø°Ù';
          delBtn.addEventListener('click', function() { this.closest('tr').remove(); checkClearResultsVisibility(); });
          tdAction.appendChild(delBtn);

          tr.appendChild(tdAction);
          resultsTbody.appendChild(tr);
        }
      });

      if (scaleFilterActive) {
        applyScaleFilterToTable(resultsTbody);
      }

      // Ù„Ùˆ Ø§Ù„Ø¨Ø­Ø« Ø¬Ø§Ø¡ Ù…Ù† Ø§Ù„Ù…Ø§Ø³Ø­ (QR) Ù†Ø¶Ù…Ù† Ø§Ù„ØªÙØ±ÙŠØº Ø£ÙŠØ¶Ø§Ù‹ Ù„ÙƒÙ† Ø¯ÙˆÙ† Ø£ÙŠ Ø¥Ø¶Ø§ÙØ©
      if (fromScanner) {
        searchBar.value = "";
        searchBar.dispatchEvent(new Event('input'));
      }

      checkClearResultsVisibility();
    }

    function clearSearch() {
      searchBar.value = "";
      resultsTbody.innerHTML = "";
      checkClearResultsVisibility();
    }

    function clearResults() {
      resultsTbody.innerHTML = "";
      checkClearResultsVisibility();
    }

    function checkClearResultsVisibility() {
      if (!resultsTbody || resultsTbody.rows.length === 0) {
        clearResultsBtnEl.style.display = 'none';
     