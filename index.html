<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=1200" />
  <title>Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>

  <!-- Ù…ÙƒØªØ¨Ø§Øª -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8"></script>

  <style>
    :root {
      --card-bg: #ffffff;
      --muted: #6c757d;
      --primary: #0d6efd;
      --success: #28a745;
      --danger: #dc3545;
      --accent: #20c997;
    }
    body {
      font-family: Arial, sans-serif;
      background: #f6f7fb;
      color: #222;
      margin: 0;
      padding: 18px;
      box-sizing: border-box;
      direction: rtl;
    }
    h2 { text-align: center; margin: 6px 0 12px; }

    /* Ù…Ø¤Ø´Ø± Ø­Ø§Ù„Ø© Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ */
    #status {
      position: fixed;
      top: 12px;
      right: 12px;
      padding: 8px 12px;
      border-radius: 6px;
      color: #fff;
      font-weight: 700;
      z-index: 60;
    }
    #status.active { background: var(--success); }
    #status.inactive { background: var(--danger); }

    /* Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
    #app {
      margin-top: 6px;
    }
    .searchRow {
      text-align: center;
      margin-bottom: 12px;
    }
    #searchBar {
      width: 60%;
      max-width: 520px;
      padding: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ddd;
      box-sizing: border-box;
      display: inline-block;
    }
    .btn {
      padding: 10px 14px;
      margin: 0 6px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 15px;
    }
    .btn.primary { background: var(--primary); color: #fff; }
    .btn.ghost { background: #e9ecef; }
    .btn.camera { background: var(--accent); color: #fff; }
    .btn.scale-active { background: #ffc107; color: #111; }

    #reader {
      width: 320px;
      margin: 10px auto;
      display: none;
      border-radius: 8px;
      overflow: hidden;
      background: #000;
    }
    /* Ensure html5-qrcode elements match container */
    #reader video, #reader canvas { width: 320px !important; height: auto !important; object-fit: cover; display: block; }

    .tables {
      display: flex;
      gap: 18px;
      justify-content: space-between;
      align-items: flex-start;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    .col {
      width: 48%;
      background: var(--card-bg);
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.04);
      box-sizing: border-box;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      word-wrap: break-word;
    }
    thead th {
      background: #f2f2f2;
      padding: 8px;
      border: 1px solid #ddd;
      font-weight: 600;
    }
    tbody td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: center;
      vertical-align: middle;
    }

    /* Ø£Ø¹Ù…Ø¯Ø© Ø¨Ø¹Ø±Ø¶ Ø«Ø§Ø¨Øª (Ù†Ø³Ø¨) */
    table th:nth-child(1), table td:nth-child(1) { width: 30%; }
    table th:nth-child(2), table td:nth-child(2) { width: 18%; }
    table th:nth-child(3), table td:nth-child(3) { width: 18%; }
    table th:nth-child(4), table td:nth-child(4) { width: 18%; }
    table th:nth-child(5), table td:nth-child(5) { width: 16%; }

    .addBtn { background: #198754; color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
    .delBtn { background: var(--danger); color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
    #clearAllBtn { background: var(--danger); color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; margin-bottom:8px; display:none; }

    /* Ù…ÙˆØ¯Ø§Ù„ */
    .modal-overlay{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); z-index:999;}
    .modal{background:#fff; border-radius:10px; padding:14px; width:420px; max-width:95%; box-sizing:border-box;}
    .modal h4{margin:0 0 8px}
    .modal .modal-input{width:100%; padding:10px; font-size:20px; text-align:center; border-radius:8px; border:1px solid #ddd}
    .numpad{display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; margin-top:10px}
    .numpad button{padding:12px; font-size:18px; border-radius:8px; border:1px solid #ccc; background:#f3f3f3; cursor:pointer}
    .modal .actions{display:flex; gap:8px; justify-content:center; margin-top:12px}
    .dup-warning { background: #fff3cd; color: #664d03; padding:8px; border-radius:6px; margin:8px auto; max-width:520px; display:none; text-align:center; }

    @media (max-width: 900px) {
      .tables { flex-direction: column; }
      .col { width: 100%; }
      #reader { width: 100%; }
      #searchBar { width: 85%; }
    }
  </style>
</head>
<body>
  <h2>Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>

  <div id="status" class="inactive">Ø¬Ø§Ø±Ù Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„...</div>

  <div id="app">
    <div class="searchRow" role="region" aria-label="Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø«">
      <input id="searchBar" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£Ùˆ ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬" aria-label="Ø¨Ø­Ø«">
      <button id="searchBtn" class="btn primary">Ø¨Ø­Ø«</button>
      <button id="clearBtn" class="btn ghost">Ø­Ø°Ù</button>
      <button id="cameraBtn" class="btn camera">ğŸ“· QR</button>
      <button id="scaleBtn" class="btn camera">ğŸ“¶ ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</button>
    </div>

    <div class="dup-warning" id="dupWarning" role="alert"></div>

    <div id="reader" aria-hidden="true"></div>

    <div class="tables">
      <div class="col" aria-label="Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«">
        <h3>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</h3>
        <div style="text-align:left; margin-bottom:6px;">
          <button id="clearResultsBtn" style="display:none;" class="btn ghost">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
        </div>
        <table id="results" aria-live="polite">
          <thead>
            <tr>
              <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
              <th>Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬</th>
              <th>ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</th>
              <th>QR Code</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="col" aria-label="Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©">
        <h3>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</h3>
        <div style="text-align:left; margin-bottom:6px;">
          <button id="clearAllBtn" onclick="clearAllSelected()">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
        </div>
        <table id="finalResults" aria-live="polite">
          <thead>
            <tr>
              <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
              <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
              <th>ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</th>
              <th>QR Code</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div style="margin-top:8px; text-align:left;">
          <button id="exportBtn" class="btn primary">ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… -->
  <div class="modal-overlay" id="receiveModal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h4 id="modalTitle">Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ù†ØªØ¬</h4>
      <div id="modalName" style="text-align:center; font-weight:700; margin-bottom:8px"></div>
      <input id="modalInput" class="modal-input" inputmode="decimal" placeholder="Ø§Ù„Ø¹Ø¯Ø¯ Ø£Ùˆ Ø§Ù„ÙˆØ²Ù† (Ù…Ø«Ø§Ù„: 2 Ø£Ùˆ 0.5)" autocomplete="off" />
      <div class="numpad" aria-hidden="false">
        <button type="button" data-key="7">7</button>
        <button type="button" data-key="8">8</button>
        <button type="button" data-key="9">9</button>
        <button type="button" data-key="4">4</button>
        <button type="button" data-key="5">5</button>
        <button type="button" data-key="6">6</button>
        <button type="button" data-key="1">1</button>
        <button type="button" data-key="2">2</button>
        <button type="button" data-key="3">3</button>
        <button type="button" id="modalBack">âŒ«</button>
        <button type="button" data-key="0">0</button>
        <button type="button" data-key=".">.</button>
      </div>
      <div class="actions">
        <button class="btn ghost" id="modalCancel">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn primary" id="modalConfirm">ØªÙ…</button>
      </div>
    </div>
  </div>

  <script>
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¥ÙƒØ³Ù„: [0]=Ø§Ø³Ù…, [1]=Ø³Ø¹Ø±, [2]=ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†, [3]=QR
    const NAME_IDX = 0, PRICE_IDX = 1, CODE_IDX = 2, QR_IDX = 3;

    // DOM
    const statusEl = document.getElementById('status');
    const dupWarningEl = document.getElementById('dupWarning');
    const searchBar = document.getElementById('searchBar');
    const searchBtn = document.getElementById('searchBtn');
    const clearBtn = document.getElementById('clearBtn');
    const cameraBtn = document.getElementById('cameraBtn');
    const scaleBtn = document.getElementById('scaleBtn');
    const reader = document.getElementById('reader');

    const resultsTbody = document.querySelector('#results tbody');
    const finalTbody = document.querySelector('#finalResults tbody');
    const clearResultsBtn = document.getElementById('clearResultsBtn');
    const clearAllBtnEl = document.getElementById('clearAllBtn');
    const exportBtn = document.getElementById('exportBtn');

    const receiveModalOverlay = document.getElementById('receiveModal');
    const modalInput = document.getElementById('modalInput');
    const modalName = document.getElementById('modalName');
    const modalBack = document.getElementById('modalBack');
    const modalCancel = document.getElementById('modalCancel');
    const modalConfirm = document.getElementById('modalConfirm');

    // Excel data
    let excelData = []; // array of rows (arrays)
    let startIndex = 1; // detect header if present

    // final map to prevent duplicates (UID -> {rowEl, qty, rowArray})
    const finalMap = new Map();

    // scanner state
    let qrScanner = null;
    let scannerRunning = false;
    let lastScan = { text: null, time: 0, tol: 800 };

    // modal state
    let modalCurrentSourceIndex = null; // index in excelData
    let modalEditingUid = null;
    let modalOpen = false;

    // Excel candidate filenames to try
    const excelCandidates = [
      "products.xlsx",
      "product.template(176).xlsx",
      "product.xlsx",
      "products.xls",
      "data.xlsx",
      "Ø¹Ù†Ø¯Ùƒ.xlsx",
      "Ø¹Ù†Ø¯Ùƒ.xls"
    ];

    // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù…Ù„ÙØ§Øª Ù…Ø­ØªÙ…Ù„Ø©
    function tryLoadExcelCandidates(list){
      let i = 0;
      function next(){
        if(i >= list.length){
          statusEl.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù ÙØ¹Ø§Ù„. Ø§Ø±ÙØ¹ Ù…Ù„ÙÙ‹Ø§ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª.";
          statusEl.className = "inactive";
          return;
        }
        const name = list[i++];
        fetch(name).then(res=>{
          if(!res.ok) throw new Error("not found");
          return res.arrayBuffer();
        }).then(buf=>{
          parseWorkbook(buf, name);
        }).catch(()=> next());
      }
      next();
    }

    // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø§ÙØ± ÙˆØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ© ØµÙÙˆÙ
    function parseWorkbook(arrayBuffer, sourceName){
      try {
        const wb = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array' });
        const first = wb.SheetNames[0];
        excelData = XLSX.utils.sheet_to_json(wb.Sheets[first], { header: 1 });
        // detect header row with text
        if(excelData.length > 0){
          const text = (excelData[0] || []).join(" ");
          startIndex = (/[a-zA-Z\u0600-\u06FF]/.test(text)) ? 1 : 0;
        } else startIndex = 0;
        statusEl.textContent = "Ù…Ù„Ù ÙØ¹Ø§Ù„: " + (sourceName || first);
        statusEl.className = "active";
      } catch(err){
        console.error(err);
        statusEl.textContent = "ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥ÙƒØ³Ù„";
        statusEl.className = "inactive";
        excelData = [];
      }
    }

    // Ø±ÙØ¹ Ù…Ù„Ù Ù…Ø­Ù„ÙŠ
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.xlsx,.xls';
    fileInput.style.display = 'none';
    fileInput.addEventListener('change', (e)=>{
      const f = e.target.files[0];
      if(!f) return;
      const r = new FileReader();
      r.onload = (ev)=> parseWorkbook(ev.target.result, f.name);
      r.onerror = ()=> { statusEl.textContent = "ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­Ù„ÙŠ"; statusEl.className = "inactive"; };
      r.readAsArrayBuffer(f);
    });
    document.body.appendChild(fileInput);

    // Helpers
    function getCell(row, idx){ if(!row) return ""; const v = row[idx]; return (v === undefined || v === null) ? "" : String(v); }
    function uidFromRow(row){
      const qr = getCell(row, QR_IDX).trim();
      const code = getCell(row, CODE_IDX).trim();
      const name = getCell(row, NAME_IDX).trim();
      if(qr) return "QR::" + qr;
      if(code) return "CODE::" + code;
      return "NAME::" + name;
    }

    // Ø§Ù„Ø¨Ø­Ø« ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (dedupe per search; show warning once if duplicates in source)
    function search(fromScanner=false, value=""){
      const q = (fromScanner ? String(value) : (searchBar.value || "")).trim().toLowerCase();
      resultsTbody.innerHTML = "";
      dupWarningEl.style.display = 'none';
      if(!Array.isArray(excelData) || excelData.length <= startIndex) { checkClearResults(); return; }
      if(!q) { checkClearResults(); return; }

      const seenUids = new Set();
      let dupFound = false;

      for(let i = startIndex; i < excelData.length; i++){
        const row = excelData[i] || [];
        if(row.length === 0) continue;
        const name = getCell(row, NAME_IDX).toLowerCase();
        const price = getCell(row, PRICE_IDX);
        const code = getCell(row, CODE_IDX).toLowerCase();
        const qr = getCell(row, QR_IDX).toLowerCase();

        if(name.includes(q) || code.includes(q) || qr.includes(q)){
          const uid = uidFromRow(row);
          if(seenUids.has(uid)){
            dupFound = true;
            continue; // display only one copy
          }
          seenUids.add(uid);

          const tr = document.createElement('tr');
          const td0 = document.createElement('td'); td0.textContent = getCell(row, NAME_IDX); tr.appendChild(td0);
          const td1 = document.createElement('td'); td1.textContent = price; tr.appendChild(td1);
          const td2 = document.createElement('td'); td2.textContent = getCell(row, CODE_IDX); tr.appendChild(td2);
          const td3 = document.createElement('td'); td3.textContent = getCell(row, QR_IDX); tr.appendChild(td3);

          const tdAction = document.createElement('td');
          const receiveBtn = document.createElement('button');
          receiveBtn.className = 'addBtn';
          receiveBtn.textContent = 'Ø§Ø³ØªÙ„Ø§Ù…';
          receiveBtn.addEventListener('click', ()=> openReceiveModal(i));
          tdAction.appendChild(receiveBtn);

          const delBtn = document.createElement('button');
          delBtn.className = 'delBtn';
          delBtn.textContent = 'Ø­Ø°Ù';
          delBtn.addEventListener('click', ()=> { tr.remove(); checkClearResults(); });
          tdAction.appendChild(delBtn);

          tr.appendChild(tdAction);
          tr.dataset.sourceIndex = i;
          tr.dataset.uid = uid;

          resultsTbody.appendChild(tr);
        }
      }

      if(dupFound){
        dupWarningEl.textContent = "ØªØ­Ø°ÙŠØ±: ÙŠÙˆØ¬Ø¯ ØªÙƒØ±Ø§Ø± Ù„Ù†ÙØ³ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ â€” ØªÙ… Ø¹Ø±Ø¶ Ù†Ø³Ø®Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·.";
        dupWarningEl.style.display = 'block';
      } else {
        dupWarningEl.style.display = 'none';
      }

      applyScaleFilter(resultsTbody);
      checkClearResults();

      // if triggered by scanner, auto-open modal for best match (exact QR or code preferred)
      if(fromScanner && value){
        const matchIndex = findRowByValue(value);
        if(matchIndex !== null){
          // avoid reopening if modal already open
          if(!modalOpen) openReceiveModal(matchIndex);
        }
      }
    }

    function findRowByValue(val){
      if(!Array.isArray(excelData) || excelData.length <= startIndex) return null;
      const v = String(val || "").trim();
      if(!v) return null;
      // exact QR
      for(let i = startIndex; i < excelData.length; i++){
        const row = excelData[i] || [];
        if(getCell(row, QR_IDX).trim() === v) return i;
      }
      // exact code
      for(let i = startIndex; i < excelData.length; i++){
        const row = excelData[i] || [];
        if(getCell(row, CODE_IDX).trim() === v) return i;
      }
      // name contains
      for(let i = startIndex; i < excelData.length; i++){
        const row = excelData[i] || [];
        if(getCell(row, NAME_IDX).toLowerCase().includes(v.toLowerCase())) return i;
      }
      return null;
    }

    function clearSearch(){ searchBar.value = ""; resultsTbody.innerHTML = ""; dupWarningEl.style.display = 'none'; checkClearResults(); }
    function checkClearResults(){ clearResultsBtn.style.display = (resultsTbody.rows.length === 0) ? 'none' : 'inline-block'; }

    // Scale filter
    let scaleFilterActive = false;
    function toggleScaleFilter(){
      scaleFilterActive = !scaleFilterActive;
      scaleBtn.classList.toggle('scale-active', scaleFilterActive);
      applyScaleFilter(resultsTbody);
      applyScaleFilter(finalTbody);
    }
    function applyScaleFilter(tbody){
      if(!tbody) return;
      Array.from(tbody.rows).forEach(row=>{
        const codeCell = row.cells[2];
        const val = codeCell ? (codeCell.textContent || "").trim() : "";
        row.style.display = (scaleFilterActive && val === "") ? 'none' : '';
      });
    }

    // Modal functions
    function openReceiveModal(sourceIndex){
      modalCurrentSourceIndex = sourceIndex;
      modalEditingUid = null;
      modalOpen = true;
      const row = excelData[sourceIndex] || [];
      modalName.textContent = getCell(row, NAME_IDX) || "";
      const uid = uidFromRow(row);
      if(finalMap.has(uid)) modalInput.value = finalMap.get(uid).qty || ""; else modalInput.value = "";
      receiveModalOverlay.style.display = 'flex';
      setTimeout(()=> { try{ modalInput.focus(); modalInput.select && modalInput.select(); }catch(e){} }, 120);
    }

    function openEditFinal(uid){
      if(!finalMap.has(uid)) return;
      modalEditingUid = uid;
      modalCurrentSourceIndex = null;
      modalOpen = true;
      const entry = finalMap.get(uid);
      modalName.textContent = getCell(entry.rowArray, NAME_IDX) || (entry.rowEl && entry.rowEl.cells[0] && entry.rowEl.cells[0].textContent) || "";
      modalInput.value = entry.qty || "";
      receiveModalOverlay.style.display = 'flex';
      setTimeout(()=> { try{ modalInput.focus(); modalInput.select && modalInput.select(); }catch(e){} }, 120);
    }

    function closeModal(){
      receiveModalOverlay.style.display = 'none';
      modalInput.value = "";
      modalCurrentSourceIndex = null;
      modalEditingUid = null;
      modalOpen = false;
    }

    // numpad interactions
    document.querySelectorAll('.numpad button[data-key]').forEach(btn=>{
      btn.addEventListener('click', ()=> {
        const k = btn.getAttribute('data-key');
        insertAtCaret(modalInput, k);
        modalInput.focus();
      });
    });
    modalBack.addEventListener('click', ()=> { backspaceAtCaret(modalInput); modalInput.focus(); });

    function insertAtCaret(input, text){
      try{
        const start = input.selectionStart || 0;
        const end = input.selectionEnd || 0;
        const val = input.value || "";
        input.value = val.slice(0,start) + text + val.slice(end);
        const pos = start + text.length;
        input.setSelectionRange(pos,pos);
      }catch(e){ input.value = (input.value || "") + text; }
    }
    function backspaceAtCaret(input){
      try{
        const start = input.selectionStart || 0;
        const end = input.selectionEnd || 0;
        if(start === end && start > 0){
          const val = input.value || "";
          input.value = val.slice(0, start-1) + val.slice(end);
          const pos = start-1;
          input.setSelectionRange(pos,pos);
        } else {
          const val = input.value || "";
          input.value = val.slice(0,start) + val.slice(end);
          input.setSelectionRange(start,start);
        }
      }catch(e){ input.value = (input.value || "").slice(0,-1); }
    }

    // Keyboard handling to allow typing numbers from physical keyboard into modalInput
    document.addEventListener('keydown', function(e){
      if(modalOpen){
        if(e.key === 'Enter'){ e.preventDefault(); modalConfirmHandler(); return; }
        if(e.key === 'Escape'){ e.preventDefault(); closeModal(); return; }
        if((e.key >= '0' && e.key <= '9') || e.key === '.'){
          if(document.activeElement !== modalInput){
            insertAtCaret(modalInput, e.key); e.preventDefault();
          }
          return;
        }
        if(e.key === 'Backspace'){
          if(document.activeElement !== modalInput){
            backspaceAtCaret(modalInput); e.preventDefault();
          }
          return;
        }
      } else {
        if(e.key === 'Enter' && document.activeElement === searchBar){
          e.preventDefault(); search(false);
        }
      }
    });

    modalInput.addEventListener('keydown', function(e){
      if(e.key === 'Enter'){ e.preventDefault(); modalConfirmHandler(); }
      else if(e.key === 'Escape'){ e.preventDefault(); closeModal(); }
    });

    modalCancel.addEventListener('click', closeModal);
    modalConfirm.addEventListener('click', modalConfirmHandler);

    function modalConfirmHandler(){
      const v = (modalInput.value || '').trim();
      if(v === ''){ alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ±Ùƒ Ø§Ù„Ø­Ù‚Ù„ ÙØ§Ø±ØºØ§Ù‹'); modalInput.focus(); return; }
      const num = Number(v);
      if(!isFinite(num)){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ§Ù„Ø­'); modalInput.focus(); return; }

      if(modalEditingUid){
        const entry = finalMap.get(modalEditingUid);
        if(entry && entry.rowEl){
          entry.qty = v;
          entry.rowEl.cells[1].textContent = v;
        }
        searchBar.value = "";
        try{ searchBar.focus(); }catch(e){}
        closeModal();
        return;
      }

      if(modalCurrentSourceIndex == null){
        alert('Ø®Ø·Ø£: Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØµØ¯Ø±');
        closeModal(); return;
      }

      const rowArray = excelData[modalCurrentSourceIndex] || [];
      addOrUpdateFinal(rowArray, v);

      // clear search bar and focus for next scan/search
      searchBar.value = "";
      try{ searchBar.focus(); }catch(e){}
      closeModal();
    }

    // Add/update final table
    function addOrUpdateFinal(rowArray, qty){
      const uid = uidFromRow(rowArray);
      if(finalMap.has(uid)){
        const entry = finalMap.get(uid);
        entry.qty = qty;
        if(entry.rowEl) entry.rowEl.cells[1].textContent = qty;
        return 'updated';
      }
      const tr = document.createElement('tr');
      const td0 = document.createElement('td'); td0.textContent = getCell(rowArray, NAME_IDX); tr.appendChild(td0);
      const td1 = document.createElement('td'); td1.textContent = qty; tr.appendChild(td1);
      const td2 = document.createElement('td'); td2.textContent = getCell(rowArray, CODE_IDX); tr.appendChild(td2);
      const td3 = document.createElement('td'); td3.textContent = getCell(rowArray, QR_IDX); tr.appendChild(td3);

      const tdAction = document.createElement('td');
      const editBtn = document.createElement('button');
      editBtn.className = 'addBtn';
      editBtn.textContent = 'ØªØ¹Ø¯ÙŠÙ„';
      editBtn.style.background = '#ffc107'; editBtn.style.color = '#111';
      editBtn.addEventListener('click', ()=> openEditFinal(uid));
      tdAction.appendChild(editBtn);
      tr.appendChild(tdAction);

      const tdDel = document.createElement('td');
      const delBtn = document.createElement('button');
      delBtn.className = 'delBtn';
      delBtn.textContent = 'Ø­Ø°Ù';
      delBtn.addEventListener('click', ()=> { tr.remove(); finalMap.delete(uid); checkClearAll(); });
      tdDel.appendChild(delBtn);
      tr.appendChild(tdDel);

      finalTbody.appendChild(tr);
      finalMap.set(uid, { rowEl: tr, qty: qty, rowArray: rowArray });
      applyScaleFilter(finalTbody);
      checkClearAll();
      return 'added';
    }

    function checkClearAll(){ clearAllBtnEl.style.display = (finalTbody.rows.length === 0) ? 'none' : 'inline-block'; }
    function clearAllSelected(){ finalTbody.innerHTML = ""; finalMap.clear(); checkClearAll(); }

    // Export final table to Excel (neat headers)
    function exportToExcel(){
      const rows = [];
      rows.push(["Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬","ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†","Ø§Ù„Ø¹Ø¯Ø¯/Ø§Ù„ÙˆØ²Ù†","QR"]);
      for(const [uid, entry] of finalMap){
        const r = entry.rowArray || [];
        const name = getCell(r, NAME_IDX) || (entry.rowEl && entry.rowEl.cells[0] && entry.rowEl.cells[0].textContent) || "";
        const code = getCell(r, CODE_IDX) || (entry.rowEl && entry.rowEl.cells[2] && entry.rowEl.cells[2].textContent) || "";
        const qty = entry.qty || (entry.rowEl && entry.rowEl.cells[1] && entry.rowEl.cells[1].textContent) || "";
        const qr = getCell(r, QR_IDX) || (entry.rowEl && entry.rowEl.cells[3] && entry.rowEl.cells[3].textContent) || "";
        rows.push([name, code, qty, qr]);
      }

      const headerColors = ['#cfe2ff','#d1e7dd','#fff3cd','#f8d7da'];

      let html = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" lang="ar"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/></head><body>';
      html += '<table border="1" style="border-collapse:collapse; font-family: Arial, sans-serif;">';
      html += '<thead><tr>';
      rows[0].forEach((h, idx) => {
        const bg = headerColors[idx % headerColors.length];
        html += `<th style="background:${bg}; font-weight:bold; padding:8px 12px; text-align:center;">${h}</th>`;
      });
      html += '</tr></thead><tbody>';
      for(let i = 1; i < rows.length; i++){
        html += '<tr>';
        rows[i].forEach(cell => {
          html += `<td style="padding:6px 10px; text-align:center;">${cell}</td>`;
        });
        html += '</tr>';
      }
      html += '</tbody></table></body></html>';

      const blob = new Blob([html], { type: 'application/vnd.ms-excel;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'export_selected.xls';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // QR Scanner (html5-qrcode)
    function chooseBackCamera(devices){
      if(!devices || devices.length === 0) return null;
      const keywords = ["back","rear","env","environment","back camera","rear camera","Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø®Ù„ÙÙŠØ©","Ø®Ù„ÙÙŠ"];
      for(const d of devices){
        const label = (d.label || "").toString().toLowerCase();
        for(const k of keywords) if(label.includes(k)) return d.id || d.deviceId || (d.id ?? d.deviceId);
      }
      if(devices.length > 1){
        const last = devices[devices.length - 1];
        return last.id || last.deviceId || (last.id ?? last.deviceId);
      }
      const first = devices[0];
      return first.id || first.deviceId || (first.id ?? first.deviceId);
    }

    async function toggleScanner(){
      if(scannerRunning){
        stopScanner();
      } else {
        startScanner();
      }
    }

    async function stopScanner(){
      if(!qrScanner) return;
      try{ await qrScanner.stop(); }catch(e){}
      try{ qrScanner.clear(); }catch(e){}
      qrScanner = null;
      reader.style.display = 'none';
      scannerRunning = false;
      cameraBtn.textContent = 'ğŸ“· QR';
    }

    async function startScanner(){
      reader.style.display = 'block';
      cameraBtn.textContent = 'â¹ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø§Ø³Ø­';
      try{
        qrScanner = new Html5Qrcode("reader");
        const devices = await Html5Qrcode.getCameras().catch(()=>[]);
        const chosen = chooseBackCamera(devices);
        const cameraIdOrConfig = chosen ? chosen : { facingMode: "environment" }; // either deviceId string or single-key object

        await qrScanner.start(
          cameraIdOrConfig,
          { fps: 10, qrbox: 250 },
          (decodedText, decodedResult) => {
            try {
              const now = Date.now();
              if(decodedText === lastScan.text && (now - lastScan.time) < lastScan.tol){
                lastScan.time = now; return;
              }
              lastScan.text = decodedText; lastScan.time = now;

              if(modalOpen) return; // don't interrupt if modal open

              // paste into search bar and auto-search -> modal opening handled by search()
              searchBar.value = decodedText;
              try{ searchBar.focus(); }catch(e){}
              search(true, decodedText);

            } catch(err){
              console.error('scan callback err', err);
            }
          },
          (errMsg) => { /* ignore frame errors */ }
        );
        scannerRunning = true;
        cameraBtn.textContent = 'â¹ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø§Ø³Ø­';
      }catch(err){
        alert('ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ' + (err && err.message ? err.message : err));
        reader.style.display = 'none';
        scannerRunning = false;
        cameraBtn.textContent = 'ğŸ“· QR';
      }
    }

    // UI bindings
    searchBtn.addEventListener('click', ()=> search(false));
    clearBtn.addEventListener('click', clearSearch);
    cameraBtn.addEventListener('click', toggleScanner);
    scaleBtn.addEventListener('click', toggleScaleFilter);
    clearResultsBtn.addEventListener('click', ()=> { resultsTbody.innerHTML = ""; checkClearResults(); });
    clearAllBtnEl.addEventListener('click', clearAllSelected);
    exportBtn.addEventListener('click', exportToExcel);

    searchBar.addEventListener('keydown', function(e){
      if(e.key === 'Enter'){ e.preventDefault(); search(false); }
    });

    // Delete removes last final row
    document.addEventListener('keydown', function(e){
      if(e.key === 'Delete'){
        if(finalTbody.rows.length > 0){
          finalTbody.deleteRow(finalTbody.rows.length - 1);
          rebuildFinalMap();
          checkClearAll();
        }
      }
    });

    receiveModalOverlay.addEventListener('click', function(e){ if(e.target === receiveModalOverlay) closeModal(); });

    function rebuildFinalMap(){
      finalMap.clear();
      Array.from(finalTbody.rows).forEach(r=>{
        const name = r.cells[0] ? r.cells[0].textContent : "";
        const qty = r.cells[1] ? r.cells[1].textContent : "";
        const code = r.cells[2] ? r.cells[2].textContent : "";
        const qr = r.cells[3] ? r.cells[3].textContent : "";
        const arr = [name, "", code, qr];
        const uid = uidFromRow(arr);
        finalMap.set(uid, { rowEl: r, qty: qty, rowArray: arr });
      });
    }

    // Load candidates on startup
    window.addEventListener('load', function(){
      tryLoadExcelCandidates(excelCandidates);
      setTimeout(()=>{ try{ searchBar.focus(); }catch(e){} }, 200);
      checkClearAll();
      checkClearResults();
    });

    // Provide a simple way to upload file (double-click the status to upload)
    statusEl.addEventListener('dblclick', ()=> fileInput.click());

  </script>
</body>
</html>
