<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>

  <!-- Ù…ÙƒØªØ¨Ø§Øª -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8"></script>

  <style>
    :root {
      --card-bg: #ffffff;
      --muted: #6c757d;
      --primary: #0d6efd;
      --success: #28a745;
      --danger: #dc3545;
      --accent: #20c997;
    }
    body {
      font-family: Arial, sans-serif;
      background: #f6f7fb;
      color: #222;
      margin: 0;
      padding: 18px;
      box-sizing: border-box;
      direction: rtl;
    }
    h2 { text-align: center; margin: 6px 0 12px; }

    /* Ù…Ø¤Ø´Ø± Ø­Ø§Ù„Ø© Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ */
    #status {
      position: fixed;
      top: 12px;
      right: 12px;
      padding: 8px 12px;
      border-radius: 6px;
      color: #fff;
      font-weight: 700;
      z-index: 60;
    }
    #status.active { background: var(--success); }
    #status.inactive { background: var(--danger); }

    /* Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¸Ù‡Ø± ÙÙˆØ±Ø§Ù‹ */
    #app {
      display: block; /* ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¯ÙˆÙ† Ø´Ø§Ø´Ø© Ø¨Ø§Ø³ÙˆØ±Ø¯ */
      margin-top: 14px;
    }

    .searchRow {
      text-align: center;
      margin-bottom: 12px;
    }
    #searchBar {
      width: 60%;
      max-width: 520px;
      padding: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ddd;
      box-sizing: border-box;
      display: inline-block;
    }
    .btn {
      padding: 10px 14px;
      margin: 0 6px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 15px;
    }
    .btn.primary { background: var(--primary); color: #fff; }
    .btn.ghost { background: #e9ecef; }
    .btn.camera { background: var(--accent); color: #fff; }

    /* Ø²Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØµØºÙŠØ± Ù…Ø±Ø¨Ø¹ */
    #cameraBtn {
      width: 44px;
      height: 44px;
      padding: 0;
      border-radius: 8px;
      font-size: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .btn.scale-active { background: #ffc107; color: #111; }

    /* Ù‚Ø§Ø±Ø¦ QR ØµØºÙŠØ± Ù…Ø±Ø¨Ø¹ */
    #reader {
      width: 88px;
      height: 88px;
      margin: 10px;
      display: none;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      box-shadow: 0 1px 6px rgba(0,0,0,0.08);
      background: #000;
      z-index: 80;
    }
    /* Ù†Ø¬Ø¨Ø± Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø¹Ù„Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØµØºÙŠØ±Ø© */
    #reader video, #reader canvas, #reader .html5-qrcode-viewport, #reader .html5-qrcode-scanner {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover !important;
    }
    /* Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†Ø§ØµØ± dashboard/controls Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ù…Ù† Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø¥Ø°Ø§ Ø£Ø¶Ø§ÙØªÙ‡Ø§ */
    #reader .html5-qrcode-button, #reader .html5-qrcode-status, #reader .html5-qrcode-button-svg {
      display: none !important;
    }

    .tables {
      display: flex;
      gap: 18px;
      justify-content: space-between;
      align-items: flex-start;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    .col {
      width: 48%;
      background: var(--card-bg);
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.04);
      box-sizing: border-box;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      word-wrap: break-word;
    }
    thead th {
      background: #f2f2f2;
      padding: 8px;
      border: 1px solid #ddd;
      font-weight: 600;
    }
    tbody td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: center;
      vertical-align: middle;
    }

    /* Ø£Ø¹Ù…Ø¯Ø© Ø¨Ø¹Ø±Ø¶ Ø«Ø§Ø¨Øª (Ù†Ø³Ø¨) */
    table th:nth-child(1), table td:nth-child(1) { width: 30%; }
    table th:nth-child(2), table td:nth-child(2) { width: 18%; }
    table th:nth-child(3), table td:nth-child(3) { width: 18%; }
    table th:nth-child(4), table td:nth-child(4) { width: 14%; }
    table th:nth-child(5), table td:nth-child(5) { width: 20%; }

    .addBtn { background: #198754; color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
    .delBtn { background: var(--danger); color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
    #clearAllBtn { background: var(--danger); color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; margin-bottom:8px; display:none; }

    .muted { color: var(--muted); font-size: 13px; }

    .flash { background: #fff3cd; color: #856404; padding: 4px 8px; border-radius: 6px; display: inline-block; }

    /* Modal for quantity */
    #modalOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }
    #modal {
      background: var(--card-bg);
      padding: 16px;
      border-radius: 10px;
      width: 320px;
      max-width: 92%;
      box-shadow: 0 8px 30px rgba(0,0,0,0.25);
      text-align: center;
    }
    #modal h4 { margin: 0 0 8px 0; }
    #modal input[type="number"] {
      width: 100%;
      padding: 10px;
      font-size: 18px;
      border-radius: 8px;
      border: 1px solid #ddd;
      box-sizing: border-box;
      text-align: center;
    }
    #modal .modal-actions { margin-top: 10px; display:flex; gap:8px; justify-content:center; }
    #modal .modal-actions button { padding: 8px 12px; border-radius:8px; border:none; cursor:pointer; }
    #modal .confirm { background: var(--primary); color:#fff; }
    #modal .cancel { background: #e9ecef; }

    .no-value { opacity: 0.6; }

    @media (max-width: 900px) {
      .tables { flex-direction: column; }
      .col { width: 100%; }
      #reader { width: 88px; }
      #searchBar { width: 85%; }
    }
  </style>
</head>
<body>
  <h2>Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>

  <!-- Ù…Ø¤Ø´Ø± Ø­Ø§Ù„Ø© Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ -->
  <div id="status" class="inactive">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù ÙØ¹Ø§Ù„</div>

  <!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¸Ù‡Ø± ÙÙˆØ±Ø§Ù‹ -->
  <div id="app">
    <div class="searchRow" role="region" aria-label="Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø«">
      <input id="searchBar" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£Ùˆ ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬" aria-label="Ø¨Ø­Ø«">
      <button id="searchBtn" class="btn primary">Ø¨Ø­Ø«</button>
      <button id="clearBtn" class="btn ghost">Ø­Ø°Ù</button>
      <button id="cameraBtn" class="btn camera" title="ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§">ğŸ“·</button>
      <button id="scaleBtn" class="btn camera">ğŸ“¶ ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</button>
    </div>

    <!-- Ù‚Ø§Ø±Ø¦ QR ØµØºÙŠØ± ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
    <div id="reader" aria-hidden="true"></div>

    <div class="tables">
      <!-- Ø¬Ø¯ÙˆÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« (ÙŠÙ…ÙŠÙ†) -->
      <div class="col" aria-label="Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«">
        <h3>Ø³Ø¬Ù„ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… (Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«)</h3>
        <table id="results" aria-live="polite">
          <thead>
            <tr>
              <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
              <th>Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬</th>
              <th>ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</th>
              <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div style="margin-top:8px; text-align:left;">
          <button id="moveAllBtn" class="btn primary" style="display:inline-block;">Ù†Ù‚Ù„ Ø§Ù„ÙƒÙ„</button>
        </div>
      </div>

      <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© (Ø´Ù…Ø§Ù„) -->
      <div class="col" aria-label="Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©">
        <h3>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</h3>
        <div style="text-align:left; margin-bottom:6px;">
          <button id="clearAllBtn" onclick="clearAllSelected()">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
          <button id="exportBtn" class="btn primary" style="margin-left:8px;">ØªØµØ¯ÙŠØ± Excel</button>
        </div>
        <table id="finalResults" aria-live="polite">
          <thead>
            <tr>
              <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
              <th>Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬</th>
              <th>ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</th>
              <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© -->
  <div id="modalOverlay" aria-hidden="true">
    <div id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h4 id="modalTitle">Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© (ÙƒØ¬Ù…)</h4>
      <input id="modalInput" type="number" min="0" step="0.001" placeholder="Ù…Ø«Ø§Ù„: 0.250">
      <div style="margin-top:8px; font-size:13px; color:var(--muted);" id="modalNote">Ø§Ø¶ØºØ· ØªØ£ÙƒÙŠØ¯ Ù„Ø­ÙØ¸ Ø§Ù„ÙƒÙ…ÙŠØ©</div>
      <div class="modal-actions">
        <button id="confirmModal" class="confirm">ØªØ£ÙƒÙŠØ¯</button>
        <button id="cancelModal" class="cancel">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <script>
    /**************************************************************************
     * Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¹Ø¯ Ø­Ø°Ù Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ ÙˆÙ†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯
     **************************************************************************/
    let excelData = [];        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥ÙƒØ³Ù„ ÙƒÙ€ array of arrays
    let qrScanner = null;      // Ù…Ø«ÙŠÙ„ html5-qrcode
    let scanningMode = null;   // 'qr' Ø£Ùˆ null
    let scaleFilterActive = false;
    let lastScan = { text: null, time: 0 };
    const SCAN_DEBOUNCE_MS = 1000;

    /* Ø¹Ù†Ø§ØµØ± DOM Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
    const statusEl = document.getElementById('status');
    const app = document.getElementById('app');

    const searchBar = document.getElementById('searchBar');
    const resultsTbody = document.querySelector('#results tbody');
    const finalTbody = document.querySelector('#finalResults tbody');
    const reader = document.getElementById('reader');
    const clearAllBtnEl = document.getElementById('clearAllBtn');
    const scaleBtnEl = document.getElementById('scaleBtn');
    const cameraBtnEl = document.getElementById('cameraBtn');

    const modalOverlay = document.getElementById('modalOverlay');
    const modalInput = document.getElementById('modalInput');
    const confirmModalBtn = document.getElementById('confirmModal');
    const cancelModalBtn = document.getElementById('cancelModal');

    const moveAllBtn = document.getElementById('moveAllBtn');
    const exportBtn = document.getElementById('exportBtn');

    const headers = ["Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬", "Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬", "ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†", "QR Code", "Ø§Ù„ÙƒÙ…ÙŠØ©"];

    /**************************************************************************
     * ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„
     **************************************************************************/
    fetch("product.template(176).xlsx")
      .then(res => res.arrayBuffer())
      .then(data => {
        try {
          const workbook = XLSX.read(new Uint8Array(data), { type: 'array' });
          const firstSheet = workbook.SheetNames[0];
          excelData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet], { header: 1 });
          statusEl.textContent = "Ù…Ù„Ù ÙØ¹Ø§Ù„";
          statusEl.className = "active";
        } catch (err) {
          console.error("Ø®Ø·Ø£ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥ÙƒØ³Ù„:", err);
          statusEl.textContent = "Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­";
          statusEl.className = "inactive";
        }
      })
      .catch(err => {
        console.warn("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„:", err);
        statusEl.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù ÙØ¹Ø§Ù„";
        statusEl.className = "inactive";
      });

    /**************************************************************************
     * Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
     **************************************************************************/
    function escapeHtml(str) {
      if (typeof str !== 'string') return str;
      return str.replace(/[&<>"'`=\/]/g, function(s) {
        return ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;',
          '/': '&#x2F;',
          '=': '&#x3D;',
          '`': '&#x60;'
        })[s];
      });
    }

    function flashRowMessage(row, msg) {
      const cell = document.createElement('td');
      cell.colSpan = row.children.length || 5;
      cell.className = 'flash';
      cell.textContent = msg;
      // Ø£Ø¶Ù ØµÙ Ù…Ø¤Ù‚Øª
      const tr = document.createElement('tr');
      tr.appendChild(cell);
      row.parentElement.insertBefore(tr, row.nextSibling);
      setTimeout(() => tr.remove(), 1200);
    }

    /**************************************************************************
     * Ø§Ù„Ø¨Ø­Ø«: ÙŠØ¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙÙŠ Ø¬Ø¯ÙˆÙ„ "Ø³Ø¬Ù„ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…" (results)
     * - fromScanner: Ù„Ùˆ Ø§Ù„Ø¨Ø­Ø« Ø¬Ø§Ø¡ Ù…Ù† Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ
     * - value: Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ù…Ø³ÙˆØ­Ø© (Ù„Ùˆ Ù…Ù† Ø§Ù„Ù…Ø§Ø³Ø­)
     * ÙŠØ¹ÙŠØ¯ Ù…ØµÙÙˆÙØ© Ù…Ù† Ø§Ù„ÙƒØ§Ø¦Ù†Ø§Øª Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© (Ù…Ø¹ Ø±Ù‚Ù… Ø§Ù„ØµÙ Ø§Ù„Ø£ØµÙ„ÙŠ idx)
     **************************************************************************/
    function search(fromScanner = false, value = '') {
      const query = fromScanner ? (value + "").trim().toLowerCase() : (searchBar.value || "").trim().toLowerCase();
      if (!query) {
        if (fromScanner) {
          searchBar.value = "";
          searchBar.dispatchEvent(new Event('input'));
        }
        return [];
      }
      if (!Array.isArray(excelData) || excelData.length === 0) return [];

      resultsTbody.innerHTML = "";
      const matches = [];

      excelData.forEach((row, idx) => {
        if (idx === 0) return; // ØªØ®Ø·ÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
        const name = (row[0] || "").toString();
        const price = (row[1] || "").toString();
        const code = (row[2] || "").toString();
        const qr = (row[3] || "").toString();

        const a = name.toLowerCase();
        const c = code.toLowerCase();
        const d = qr.toLowerCase();

        if (a.includes(query) || c.includes(query) || d.includes(query)) {
          const tr = document.createElement('tr');

          const td0 = document.createElement('td'); td0.textContent = name; tr.appendChild(td0);
          const td1 = document.createElement('td'); td1.textContent = price; tr.appendChild(td1);
          const td2 = document.createElement('td'); td2.textContent = code; tr.appendChild(td2);
          const tdQty = document.createElement('td'); tdQty.textContent = ""; tdQty.className = "no-value"; tr.appendChild(tdQty);

          const tdAction = document.createElement('td');

          // Ø²Ø± Ø§Ø³ØªÙ„Ø§Ù… Ù„ÙØªØ­ modal Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©
          const receiveBtn = document.createElement('button');
          receiveBtn.className = 'addBtn';
          receiveBtn.textContent = 'Ø§Ø³ØªÙ„Ø§Ù…';
          receiveBtn.addEventListener('click', () => {
            openQtyModalForRow(tr, { name, price, code, qr, rowIndex: idx });
          });
          tdAction.appendChild(receiveBtn);

          // Ø²Ø± Ù†Ù‚Ù„ (Ù…Ø¹Ø·Ù„ Ù…Ø¨Ø¯Ø¦ÙŠØ§Ù‹)
          const moveBtn = document.createElement('button');
          moveBtn.className = 'btn ghost';
          moveBtn.textContent = 'Ù†Ù‚Ù„';
          moveBtn.disabled = true;
          moveBtn.style.marginLeft = '6px';
          moveBtn.addEventListener('click', () => {
            moveRowToCompleted(tr);
          });
          tdAction.appendChild(moveBtn);

          tr.appendChild(tdAction);
          resultsTbody.appendChild(tr);

          // Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ù…Ø·Ø§Ø¨Ù‚Ø§Øª Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù„Ø§Ø­Ù‚Ø§Ù‹
          matches.push({ tr, data: { name, price, code, qr, rowIndex: idx }, moveBtn, tdQty });

          // Ø¥Ø°Ø§ ÙƒØ§Ù† ØªØ·Ø§Ø¨Ù‚Ù‹Ø§ Ø¯Ù‚ÙŠÙ‚Ù‹Ø§ (qr Ø£Ùˆ code) ÙˆÙ…Ù† Ù…ØµØ¯Ø± Ø§Ù„Ù…Ø§Ø³Ø­: Ø§ÙØªØ­ modal ÙÙˆØ±Ø§Ù‹
          const exactMatch = fromScanner && ((d && d === query) || (c && c === query));
          if (exactMatch) {
            // Ù†ÙØªØ­ modal Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„ØµÙ Ù…Ø¨Ø§Ø´Ø±Ø©
            setTimeout(() => openQtyModalForRow(tr, { name, price, code, qr, rowIndex: idx }), 80);
          }
        }
      });

      if (scaleFilterActive) applyScaleFilterToTable(resultsTbody);

      // Ù„Ùˆ Ø¬Ø§Ø¡ Ù…Ù† Ø§Ù„Ù…Ø§Ø³Ø­ Ù†Ø¶Ù…Ù† Ø§Ù„ØªÙØ±ÙŠØº Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ø­Ù‚Ù„
      if (fromScanner) {
        searchBar.value = "";
        searchBar.dispatchEvent(new Event('input'));
      }

      return matches;
    }

    function clearSearch() {
      searchBar.value = "";
      resultsTbody.innerHTML = "";
    }

    /**************************************************************************
     * ÙÙ„ØªØ± ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†
     **************************************************************************/
    function toggleScaleFilter() {
      scaleFilterActive = !scaleFilterActive;
      scaleBtnEl.classList.toggle('scale-active', scaleFilterActive);
      applyScaleFilterToTable(resultsTbody);
      applyScaleFilterToTable(finalTbody);
      checkClearAllVisibility();
    }

    function applyScaleFilterToTable(tbody) {
      if (!tbody) return;
      const rows = Array.from(tbody.rows);
      rows.forEach(row => {
        const cell = row.cells[2]; // ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù† (index 2)
        const val = cell ? (cell.textContent || "").trim() : "";
        row.style.display = (scaleFilterActive && val === "") ? 'none' : '';
      });
    }

    /**************************************************************************
     * Ø¥Ø¯Ø§Ø±Ø© modal Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©
     * - ÙØªØ­ modal Ù…Ø±ØªØ¨Ø· Ø¨ØµÙ Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
     * - ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù‚ÙŠÙ…Ø© ÙÙŠ td (data-qty) ÙˆØ¹Ø±Ø¶Ù‡Ø§ ÙƒÙ€ "X ÙƒØ¬Ù…"
     * - ØªÙØ¹ÙŠÙ„ Ø²Ø± "Ù†Ù‚Ù„" Ø¹Ù†Ø¯Ù…Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø©
     **************************************************************************/
    let currentModalRow = null;
    let currentModalData = null;

    function openQtyModalForRow(rowElement, dataObj) {
      currentModalRow = rowElement;
      currentModalData = dataObj;
      modalOverlay.style.display = 'flex';
      modalOverlay.setAttribute('aria-hidden', 'false');

      // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ù‚ÙŠÙ…Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ø®Ù„ÙŠØ©
      const qtyCell = rowElement.cells[3];
      const existing = (qtyCell && qtyCell.dataset && qtyCell.dataset.qty) ? qtyCell.dataset.qty : '';
      modalInput.value = existing || '';
      setTimeout(() => modalInput.focus(), 80);
    }

    function closeModal() {
      modalOverlay.style.display = 'none';
      modalOverlay.setAttribute('aria-hidden', 'true');
      currentModalRow = null;
      currentModalData = null;
      modalInput.value = '';
    }

    confirmModalBtn.addEventListener('click', () => {
      if (!currentModalRow) { closeModal(); return; }
      const v = modalInput.value;
      const num = parseFloat(v);
      const qtyCell = currentModalRow.cells[3];
      if (!v || isNaN(num) || num <= 0) {
        // ÙˆØ¶Ø¹ ÙˆØ³Ù… no-value ÙˆØ¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ù†Ù‚Ù„
        qtyCell.textContent = "";
        qtyCell.classList.add('no-value');
        const moveBtn = getMoveButtonFromRow(currentModalRow);
        if (moveBtn) { moveBtn.disabled = true; }
        // Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ù„ØºÙ‰ Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©ØŒ Ù†ØµÙŠØ­Ø© Ù‚ØµÙŠØ±Ø© Ø«Ù… Ø§ØºÙ„Ø§Ù‚
        closeModal();
        return;
      }

      // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø£Ùˆ Ø§Ù„Ù…ÙƒØªÙ…Ù„ (Ù†Ù‚ÙˆÙ… Ø¨Ù…Ù†Ø¹ Ø¥Ø¶Ø§ÙØ© Ù†ÙØ³ qr Ø£Ùˆ code)
      const codeVal = (currentModalData.code || "") + "";
      const qrVal = (currentModalData.qr || "") + "";

      // Ù†Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ù‚ÙŠÙ…Ø© ÙÙŠ finalResults Ø­Ø³Ø¨ Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ QR
      const existsInFinal = Array.from(finalTbody.rows).some(r => {
        const rCode = (r.cells[2] && r.cells[2].textContent) || "";
        const rQty = (r.cells[3] && r.cells[3].dataset && r.cells[3].dataset.qty) || "";
        return (rCode === codeVal && codeVal !== "");
      });
      if (existsInFinal) {
        flashRowMessage(currentModalRow, 'Ù…ÙƒØ±Ø± ÙÙŠ Ø§Ù„Ù…ÙƒØªÙ…Ù„');
        closeModal();
        return;
      }

      // Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ…Ø© ÙÙŠ Ø§Ù„Ø®Ù„ÙŠØ© ÙƒÙ€ data-qty ÙˆÙ†Øµ Ù…Ø±Ø¦ÙŠ
      qtyCell.dataset.qty = String(num);
      qtyCell.textContent = num + " ÙƒØ¬Ù…";
      qtyCell.classList.remove('no-value');

      // Ø¥Ø¸Ù‡Ø§Ø± badge Ù…Ø¤Ù‚Øª Ù„Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ø§Ø­Ù‚Ù‹Ø§ (Ù„Ù… Ù†Ù‚Ù… Ø¨ØªØªØ¨Ø¹ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù‡Ù†Ø§ Ø¨Ø¹Ø±Ø¶ Ù…Ù†ÙØµÙ„)
      const moveBtn = getMoveButtonFromRow(currentModalRow);
      if (moveBtn) { moveBtn.disabled = false; }

      closeModal();
    });

    cancelModalBtn.addEventListener('click', () => {
      closeModal();
    });

    function getMoveButtonFromRow(tr) {
      if (!tr) return null;
      const actionCell = tr.cells[tr.cells.length - 1];
      if (!actionCell) return null;
      const buttons = actionCell.querySelectorAll('button');
      // Ø§ÙØªØ±Ø§Ø¶ Ø£Ù† Ø§Ù„Ø²Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ Ù‡Ùˆ moveBtn ÙƒÙ…Ø§ Ø¨ÙÙ†ÙŠ Ø³Ø§Ø¨Ù‚Ø§Ù‹
      return buttons && buttons[1] ? buttons[1] : null;
    }

    /**************************************************************************
     * Ù†Ù‚Ù„ Ø§Ù„ØµÙ Ø¥Ù„Ù‰ finalResults
     * - ÙŠØªØ£ÙƒØ¯ Ø£Ù† Ù‡Ù†Ø§Ùƒ qty ØµØ§Ù„Ø­
     * - ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± ÙÙŠ fin