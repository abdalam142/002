<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Ø¨Ø­Ø« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>
  <meta name="viewport" content="width=1200" />
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; direction: rtl; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    #tables { display: flex; gap: 20px; }
    .box { width: 50%; }
    .btn { padding: 6px 12px; margin: 3px; cursor: pointer; }
    #status { margin: 10px 0; font-weight: bold; }
    video { width: 100%; max-height: 250px; border: 1px solid #aaa; margin-top: 10px; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
    .modal-content { background: #fff; padding: 20px; border-radius: 8px; min-width: 300px; text-align: center; }
    .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
    .numpad button { padding: 15px; font-size: 18px; cursor: pointer; }
  </style>
</head>
<body>

  <h2>Ø¨Ø­Ø« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
  <input type="text" id="searchBar" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… / Ø§Ù„ÙƒÙˆØ¯ / QR" style="width:300px; padding:5px;" />
  <button class="btn" onclick="searchProducts()">Ø¨Ø­Ø«</button>
  <button class="btn" onclick="toggleFilter()">ÙÙ„ØªØ± ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</button>
  <button class="btn" onclick="startCamera()">ğŸ“· Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
  <div id="status">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù...</div>
  <video id="preview" autoplay></video>

  <div id="tables">
    <div class="box">
      <h3>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</h3>
      <button class="btn" onclick="clearTable('selectedTable')">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
      <button class="btn" onclick="exportExcel()">ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„</button>
      <table id="selectedTable">
        <thead>
          <tr>
            <th>Ø§Ø³Ù…</th>
            <th>ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</th>
            <th>QR</th>
            <th>Ø§Ù„Ø¹Ø¯Ø¯/Ø§Ù„ÙˆØ²Ù†</th>
            <th>ØªØ¹Ø¯ÙŠÙ„</th>
            <th>Ø­Ø°Ù</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="box">
      <h3>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</h3>
      <button class="btn" onclick="clearTable('resultsTable')">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
      <table id="resultsTable">
        <thead>
          <tr>
            <th>Ø§Ø³Ù…</th>
            <th>ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</th>
            <th>QR</th>
            <th>Ø§Ø³ØªÙ„Ø§Ù…</th>
            <th>Ø­Ø°Ù</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h3 id="modalTitle">Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ø¯Ø¯/Ø§Ù„ÙˆØ²Ù†</h3>
      <input type="text" id="modalInput" style="width:100%; padding:8px; font-size:16px;" />
      <div class="numpad">
        <button onclick="numpad('1')">1</button>
        <button onclick="numpad('2')">2</button>
        <button onclick="numpad('3')">3</button>
        <button onclick="numpad('4')">4</button>
        <button onclick="numpad('5')">5</button>
        <button onclick="numpad('6')">6</button>
        <button onclick="numpad('7')">7</button>
        <button onclick="numpad('8')">8</button>
        <button onclick="numpad('9')">9</button>
        <button onclick="numpad('.')">.</button>
        <button onclick="numpad('0')">0</button>
        <button onclick="numpadBack()">âŒ«</button>
      </div>
      <button class="btn" onclick="confirmModal()">ØªÙ…</button>
      <button class="btn" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>

  <!-- Ù…ÙƒØªØ¨Ø© QR -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <!-- Ù…ÙƒØªØ¨Ø© XLSX -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    let products = [];
    let filterActive = false;
    let modalMode = "add"; // add or edit
    let currentRow = null;
    let html5QrCode;

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§ÙƒØ³Ù„
    fetch("products.xlsx").then(res => res.arrayBuffer())
      .then(data => {
        let workbook = XLSX.read(new Uint8Array(data), { type: "array" });
        let sheet = workbook.Sheets[workbook.SheetNames[0]];
        products = XLSX.utils.sheet_to_json(sheet);
        document.getElementById("status").textContent = "ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­ âœ…";
      })
      .catch(err => {
        document.getElementById("status").textContent = "ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù âŒ";
      });

    // Ø¨Ø­Ø«
    function searchProducts() {
      let q = document.getElementById("searchBar").value.trim();
      let body = document.querySelector("#resultsTable tbody");
      body.innerHTML = "";
      products.forEach(p => {
        if (filterActive && !p["ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†"]) return;
        if (
          (p["Ø§Ø³Ù…"] && p["Ø§Ø³Ù…"].includes(q)) ||
          (p["ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†"] && p["ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†"].toString().includes(q)) ||
          (p["QR"] && p["QR"].toString().includes(q))
        ) {
          let tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${p["Ø§Ø³Ù…"]||""}</td>
            <td>${p["ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†"]||""}</td>
            <td>${p["QR"]||""}</td>
            <td><button onclick="openModal('add', this)">Ø§Ø³ØªÙ„Ø§Ù…</button></td>
            <td><button onclick="tr.remove()">ğŸ—‘</button></td>`;
          body.appendChild(tr);
        }
      });
      document.getElementById("searchBar").value = "";
    }

    function toggleFilter() {
      filterActive = !filterActive;
      searchProducts();
    }

    function clearTable(id) {
      document.querySelector("#"+id+" tbody").innerHTML = "";
    }

    // Ù…ÙˆØ¯Ø§Ù„
    function openModal(mode, btn) {
      modalMode = mode;
      currentRow = btn.closest("tr");
      let uid = currentRow.children[2].textContent || currentRow.children[1].textContent;
      if (mode === "edit") {
        document.getElementById("modalInput").value = currentRow.children[3].textContent;
      } else {
        let existing = [...document.querySelectorAll("#selectedTable tbody tr")]
          .find(r => (r.children[2].textContent||r.children[1].textContent)===uid);
        document.getElementById("modalInput").value = existing ? existing.children[3].textContent : "";
      }
      document.getElementById("modal").style.display = "flex";
    }
    function closeModal() { document.getElementById("modal").style.display="none"; }
    function numpad(v){ document.getElementById("modalInput").value += v; }
    function numpadBack(){ 
      let inp=document.getElementById("modalInput");
      inp.value=inp.value.slice(0,-1);
    }

    function confirmModal() {
      let val = document.getElementById("modalInput").value.trim();
      if (!val) { alert("Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø©"); return; }
      if (modalMode === "add") {
        let name=currentRow.children[0].textContent;
        let code=currentRow.children[1].textContent;
        let qr=currentRow.children[2].textContent;
        let uid=qr||code;
        let tbody=document.querySelector("#selectedTable tbody");
        let existing = [...tbody.querySelectorAll("tr")]
          .find(r => (r.children[2].textContent||r.children[1].textContent)===uid);
        if (existing) {
          existing.children[3].textContent = val;
        } else {
          let tr=document.createElement("tr");
          tr.innerHTML=`<td>${name}</td><td>${code}</td><td>${qr}</td>
            <td>${val}</td>
            <td><button onclick="openModal('edit', this)">âœï¸</button></td>
            <td><button onclick="tr.remove()">ğŸ—‘</button></td>`;
          tbody.appendChild(tr);
        }
      } else if (modalMode === "edit") {
        currentRow.children[3].textContent = val;
      }
      closeModal();
    }

    // ØªØµØ¯ÙŠØ±
    function exportExcel(){
      let rows=[["Ø§Ø³Ù…","ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†","QR","Ø§Ù„Ø¹Ø¯Ø¯/Ø§Ù„ÙˆØ²Ù†"]];
      document.querySelectorAll("#selectedTable tbody tr").forEach(r=>{
        rows.push([
          r.children[0].textContent,
          r.children[1].textContent,
          r.children[2].textContent,
          r.children[3].textContent
        ]);
      });
      let ws=XLSX.utils.aoa_to_sheet(rows);
      let wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Selected");
      XLSX.writeFile(wb, "selected.xlsx");
    }

    // Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
    function startCamera() {
      if (html5QrCode) {
        html5QrCode.stop(); html5QrCode = null;
        document.getElementById("preview").style.display="none";
        return;
      }
      document.getElementById("preview").style.display="block";
      html5QrCode = new Html5Qrcode("preview");
      Html5Qrcode.getCameras().then(devices=>{
        let cam = devices.find(d=>d.label.toLowerCase().includes("back")) || devices[0];
        html5QrCode.start(
          { deviceId: { exact: cam.id } },
          { fps:10, qrbox:250 },
          msg => { document.getElementById("searchBar").value = msg; },
          err => {}
        );
      }).catch(err=>alert("Ø®Ø·Ø£ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: "+err));
    }
  </script>
</body>
</html>
