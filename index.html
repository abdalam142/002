<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø­Ø«</title>

  <!-- Ù…ÙƒØªØ¨Ø© Ù‚Ø±Ø§Ø¡Ø© Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Ù…ÙƒØªØ¨Ø© QR -->
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>

  <style>
    body { font-family: Tahoma, sans-serif; margin:0; padding:0; background:#f5f5f5; }
    #loginBox, #app { display:none; padding:20px; }
    #loginBox { display:block; max-width:300px; margin:80px auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 0 8px rgba(0,0,0,0.2); }
    .error-msg { color:red; margin-top:10px; font-size:14px; display:none; }

    .keyboard button { width:60px; height:60px; margin:5px; font-size:20px; }
    .flex { display:flex; gap:20px; }
    table { border-collapse:collapse; width:100%; margin-top:10px; background:#fff; }
    th, td { border:1px solid #ccc; padding:8px; text-align:center; }
    th { background:#eee; }
    .actions button { margin:2px; }
    .top-bar { margin-bottom:10px; display:flex; gap:10px; align-items:center; }
  </style>
</head>
<body>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ -->
<div id="loginBox">
  <h3>Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
  <input type="password" id="passwordInput" readonly style="width:100%;padding:8px;margin-bottom:10px;font-size:18px;" />
  <div class="keyboard">
    <div>
      <button onclick="pressDigit('1')">1</button>
      <button onclick="pressDigit('2')">2</button>
      <button onclick="pressDigit('3')">3</button>
    </div>
    <div>
      <button onclick="pressDigit('4')">4</button>
      <button onclick="pressDigit('5')">5</button>
      <button onclick="pressDigit('6')">6</button>
    </div>
    <div>
      <button onclick="pressDigit('7')">7</button>
      <button onclick="pressDigit('8')">8</button>
      <button onclick="pressDigit('9')">9</button>
    </div>
    <div>
      <button onclick="backspacePass()">âŒ«</button>
      <button onclick="pressDigit('0')">0</button>
      <button onclick="submitPass()">â</button>
    </div>
  </div>
  <div id="errorMsg" class="error-msg">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©</div>
</div>

<!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
<div id="app">
  <div class="top-bar">
    <input type="file" id="excelFile" />
    <button onclick="startCamera()">ğŸ“· ÙƒØ§Ù…ÙŠØ±Ø§ QR</button>
    <button onclick="filterByScale()">ğŸ” ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</button>
  </div>
  <div id="excelStatus">Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø¥ÙƒØ³Ù„</div>

  <div class="top-bar">
    <input type="text" id="searchBar" placeholder="Ø§Ø¨Ø­Ø« Ù‡Ù†Ø§" />
    <button onclick="manualSearch()">Ø¨Ø­Ø«</button>
    <button onclick="clearSearch()">Ø­Ø°Ù</button>
  </div>

  <div class="flex">
    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø« -->
    <div style="flex:1">
      <h3>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</h3>
      <table id="searchTable">
        <thead><tr><th>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© -->
    <div style="flex:1">
      <h3>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© <button onclick="clearResults()">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button></h3>
      <table id="resultsTable">
        <thead><tr><th>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="reader" style="width:300px;margin:auto;display:none;"></div>
</div>

<script>
  // ================== Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© ==================
  const correctPassword = "1234";
  const passwordInput = document.getElementById("passwordInput");
  const errorMsg = document.getElementById("errorMsg");
  const loginBox = document.getElementById("loginBox");
  const app = document.getElementById("app");
  const searchBar = document.getElementById("searchBar");
  const searchTable = document.getElementById("searchTable").querySelector("tbody");
  const resultsTable = document.getElementById("resultsTable").querySelector("tbody");
  let products = [];

  // ================== Ø¨Ø§Ø³ÙˆØ±Ø¯ ==================
  function pressDigit(d) { passwordInput.value = (passwordInput.value || "") + d; }
  function backspacePass() { passwordInput.value = (passwordInput.value || "").slice(0, -1); }
  function submitPass() {
    if ((passwordInput.value || "") === correctPassword) {
      loginBox.style.display = "none";
      app.style.display = "block";
      errorMsg.style.display = "none";
      setTimeout(()=>searchBar.focus(), 150);
    } else {
      errorMsg.style.display = "block";
    }
  }
  document.addEventListener("keydown", e=>{
    if(loginBox.style.display === "block"){
      if(e.key >= "0" && e.key <= "9"){ pressDigit(e.key); }
      if(e.key === "Backspace"){ backspacePass(); }
      if(e.key === "Enter"){ submitPass(); }
    }
  });

  // ================== ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel ==================
  document.getElementById("excelFile").addEventListener("change", function(e){
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e){
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, {type:"array"});
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      products = XLSX.utils.sheet_to_json(sheet);
      document.getElementById("excelStatus").innerText = "ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø¥ÙƒØ³Ù„ Ø¨Ù†Ø¬Ø§Ø­ âœ…";
    };
    reader.readAsArrayBuffer(file);
  });

  // ================== Ø§Ù„Ø¨Ø­Ø« ==================
  function renderSearchResults(list){
    searchTable.innerHTML = "";
    list.forEach(p=>{
      let row = searchTable.insertRow();
      row.insertCell().innerText = p.barcode;
      row.insertCell().innerText = p.name;
      row.insertCell().innerText = p.scale || "";
      let act = row.insertCell();
      let btn = document.createElement("button");
      btn.innerText = "Ø¥Ø¶Ø§ÙØ©";
      btn.onclick = ()=>addToResults(p);
      act.appendChild(btn);
    });
  }
  function manualSearch(){
    let q = searchBar.value.trim();
    if(!q) return;
    let res = products.filter(p=>
      (p.barcode && p.barcode.includes(q)) ||
      (p.name && p.name.includes(q))
    );
    renderSearchResults(res);
    searchBar.value = "";
  }
  function clearSearch(){ searchBar.value=""; searchTable.innerHTML=""; }

  // ================== Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù†ØªØ§Ø¦Ø¬ ==================
  function addToResults(p){
    // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø±
    let exists = Array.from(resultsTable.rows).some(r=>r.cells[0].innerText === p.barcode);
    if(exists) return;
    let row = resultsTable.insertRow();
    row.insertCell().innerText = p.barcode;
    row.insertCell().innerText = p.name;
    row.insertCell().innerText = p.scale || "";
    let act = row.insertCell();
    let btn = document.createElement("button");
    btn.innerText = "Ø­Ø°Ù";
    btn.onclick = ()=>row.remove();
    act.appendChild(btn);
  }
  function clearResults(){ resultsTable.innerHTML=""; }

  // ================== QR ==================
  function startCamera(){
    document.getElementById("reader").style.display="block";
    let qr = new Html5Qrcode("reader");
    qr.start({facingMode:"environment"}, {fps:10, qrbox:250},
      code=>{
        handleQRCodeInput(code);
        qr.stop().then(()=>{document.getElementById("reader").style.display="none";});
      }
    );
  }
  function handleQRCodeInput(code){
    let found = products.find(p=>p.barcode === code);
    if(found){
      let already = Array.from(resultsTable.rows).some(r=>r.cells[0].innerText === found.barcode);
      if(!already){ addToResults(found); }
    }
    // âœ¨ ØªÙØ±ÙŠØº Ø§Ù„Ø¨Ø­Ø« Ø¯Ø§Ø¦Ù…Ù‹Ø§
    searchBar.value = "";
  }

  // ================== ÙÙ„ØªØ±Ø© ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù† ==================
  function filterByScale(){
    [searchTable, resultsTable].forEach(tbl=>{
      Array.from(tbl.rows).forEach(r=>{
        let scale = r.cells[2].innerText.trim();
        r.style.display = scale ? "" : "none";
      });
    });
  }

  // ================== Ø¯Ø¹Ù… Enter Ù„Ù„Ø¨Ø­Ø« ==================
  searchBar.addEventListener("keydown", e=>{
    if(e.key==="Enter"){ manualSearch(); }
  });
</script>
</body>
</html>
