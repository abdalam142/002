<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù†ØªØ¬Ø§Øª</title>

  <!-- Ù…ÙƒØªØ¨Ø§Øª -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8"></script>

  <style>
    :root {
      --card-bg: #ffffff;
      --muted: #6c757d;
      --primary: #0d6efd;
      --success: #28a745;
      --danger: #dc3545;
      --accent: #20c997;
      --warning: #ffc107;
    }
    body {
      font-family: Arial, sans-serif;
      background: #f6f7fb;
      color: #222;
      margin: 0;
      padding: 18px;
      box-sizing: border-box;
      direction: rtl;
    }
    h2 { text-align: center; margin: 6px 0 12px; }

    /* Ù…Ø¤Ø´Ø± Ø­Ø§Ù„Ø© Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ */
    #status {
      position: fixed;
      top: 12px;
      right: 12px;
      padding: 8px 12px;
      border-radius: 6px;
      color: #fff;
      font-weight: 700;
      z-index: 60;
    }
    #status.active { background: var(--success); }
    #status.inactive { background: var(--danger); }

    /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ */
    #loginBox {
      background: var(--card-bg);
      padding: 14px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      max-width: 420px;
      margin: 10px auto;
      text-align: center;
    }
    #passwordInput {
      width: 100%;
      max-width: 260px;
      padding: 10px;
      font-size: 20px;
      text-align: center;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .numpad {
      width: 260px;
      margin: 12px auto 0;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    .numpad button {
      padding: 12px;
      font-size: 18px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #f3f3f3;
      cursor: pointer;
    }
    #passError {
      display: none;
      margin-top: 10px;
      color: #842029;
      background: #f8d7da;
      border: 1px solid #f5c2c7;
      padding: 8px 10px;
      border-radius: 6px;
      width: 90%;
      max-width: 320px;
      margin-inline: auto;
      box-sizing: border-box;
    }

    /* Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
    #app {
      display: none;
      margin-top: 14px;
    }
    .searchRow {
      text-align: center;
      margin-bottom: 12px;
      position: relative;
    }
    #searchBar {
      width: 60%;
      max-width: 520px;
      padding: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ddd;
      box-sizing: border-box;
      display: inline-block;
    }
    .btn {
      padding: 10px 14px;
      margin: 0 6px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 15px;
    }
    .btn.primary { background: var(--primary); color: #fff; }
    .btn.ghost { background: #e9ecef; }
    .btn.camera { background: var(--accent); color: #fff; }
    .btn.scale-active { background: #ffc107; color: #111; }

    /* Ù‚Ø§Ø±Ø¦ QR - ØµØºÙŠØ± ÙˆÙ…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠØ³Ø§Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠ */
    #reader {
      width: 160px;
      height: 120px;
      position: fixed;
      top: 12px;
      left: 12px;
      right: auto;
      display: none;
      z-index: 9999;
      background: #fff;
      border-radius: 8px;
      padding: 4px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.12);
      overflow: hidden;
    }
    /* Ø¶Ø¨Ø· Ø¹Ù†Ø§ØµØ± video/canvas Ø¯Ø§Ø®Ù„ html5-qrcode Ù„ÙŠØ·Ø§Ø¨Ù‚ Ø­Ø¬Ù… Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØµØºÙŠØ±Ø© */
    #reader .html5-qrcode-video, 
    #reader video, 
    #reader canvas {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover;
      display: block;
    }
    #reader .html5-qrcode-region {
      width: 100% !important;
      height: 100% !important;
    }

    .tables {
      display: flex;
      gap: 18px;
      justify-content: space-between;
      align-items: flex-start;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    .col {
      width: 48%;
      background: var(--card-bg);
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.04);
      box-sizing: border-box;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      word-wrap: break-word;
    }
    thead th {
      background: #f2f2f2;
      padding: 8px;
      border: 1px solid #ddd;
      font-weight: 600;
    }
    tbody td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: center;
      vertical-align: middle;
    }

    /* Ø£Ø¹Ù…Ø¯Ø© Ø¨Ø¹Ø±Ø¶ Ø«Ø§Ø¨Øª (Ù†Ø³Ø¨) */
    table th:nth-child(1), table td:nth-child(1) { width: 40%; } /* Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ */
    table th:nth-child(2), table td:nth-child(2) { width: 18%; } /* ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù† */
    table th:nth-child(3), table td:nth-child(3) { width: 18%; } /* QR */
    table th:nth-child(4), table td:nth-child(4) { width: 12%; } /* ÙƒÙ…ÙŠØ© */
    table th:nth-child(5), table td:nth-child(5) { width: 12%; } /* Ø¥Ø¬Ø±Ø§Ø¡ */

    .addBtn { background: #198754; color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
    .delBtn { background: var(--danger); color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
    .moveBtn { background: var(--primary); color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
    #clearAllBtn { background: var(--danger); color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; margin-bottom:8px; display:none; }

    /* ØµÙ Ø¨Ø¯ÙˆÙ† Ù‚ÙŠÙ…Ø© - Ù…Ø¹Ù„Ù… Ø¨Ø§Ù„Ø£Ø­Ù…Ø± */
    .no-value { background: #ffe5e5 !important; }

    /* Ù†Ø§ÙØ°Ø© Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      z-index: 200;
      align-items: center;
      justify-content: center;
    }
    .modal {
      background: #fff;
      border-radius: 10px;
      padding: 14px;
      width: 320px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      text-align: center;
    }
    .modal h4 { margin: 6px 0 10px; }
    .num-input {
      width: 100%;
      padding: 10px;
      font-size: 20px;
      border-radius: 6px;
      border: 1px solid #ddd;
      text-align: center;
      margin-bottom: 8px;
    }
    .modal .numpad { width: 100%; grid-template-columns: repeat(3, 1fr); gap: 8px; margin: 8px 0; }
    .small-note { font-size: 12px; color: var(--muted); margin-top: 6px; }

    /* ØµØºÙŠØ± Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
    .old-value-badge {
      font-size: 12px;
      color: #fff;
      background: #6c757d;
      padding: 2px 6px;
      border-radius: 6px;
      margin-right: 6px;
    }

    @media (max-width: 900px) {
      .tables { flex-direction: column; }
      .col { width: 100%; }
      #reader { width: calc(100% - 24px); left: 12px; right: 12px; top: 12px; height: 220px; }
      #searchBar { width: 85%; }
    }
  </style>
</head>
<body>
  <h2>Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù†ØªØ¬Ø§Øª</h2>

  <!-- Ù…Ø¤Ø´Ø± Ø­Ø§Ù„Ø© Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ -->
  <div id="status" class="inactive">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù ÙØ¹Ø§Ù„</div>

  <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ -->
  <div id="loginBox" aria-live="polite">
    <input id="passwordInput" type="password" placeholder="Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" aria-label="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <div class="numpad" style="margin-top:12px;">
      <button onclick="pressDigit('1')">1</button>
      <button onclick="pressDigit('2')">2</button>
      <button onclick="pressDigit('3')">3</button>
      <button onclick="pressDigit('4')">4</button>
      <button onclick="pressDigit('5')">5</button>
      <button onclick="pressDigit('6')">6</button>
      <button onclick="pressDigit('7')">7</button>
      <button onclick="pressDigit('8')">8</button>
      <button onclick="pressDigit('9')">9</button>
      <button onclick="backspacePass()">âŒ«</button>
      <button onclick="pressDigit('0')">0</button>
      <button onclick="submitPass()">â</button>
    </div>

    <!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø© -->
    <div id="passError" role="alert" aria-live="assertive"></div>
  </div>

  <!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
  <div id="app">
    <div class="searchRow" role="region" aria-label="Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø«">
      <input id="searchBar" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø£Ùˆ ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬" aria-label="Ø¨Ø­Ø«">
      <button id="searchBtn" class="btn primary" onclick="search(false)">Ø¨Ø­Ø«</button>
      <button id="clearBtn" class="btn ghost" onclick="clearSearch()">Ø­Ø°Ù</button>
      <button id="cameraBtn" class="btn camera" onclick="toggleScanner()">ğŸ“· ÙƒØ§Ù…ÙŠØ±Ø§</button>
      <button id="moveAllBtn" class="btn" style="background:#0b5ed7;color:#fff;" onclick="moveAllToCompleted()">Ù†Ù‚Ù„ ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
    </div>

    <!-- Ù‚Ø§Ø±Ø¦ QR ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± -->
    <div id="reader" aria-hidden="true"></div>

    <div class="tables">
      <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙ…ÙŠÙ†: Ø³Ø¬Ù„ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… (Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ) -->
      <div class="col" aria-label="Ø³Ø¬Ù„ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…">
        <h3>Ø³Ø¬Ù„ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… (ØªØ³Ø¬ÙŠÙ„)</h3>
        <div style="text-align:left; margin-bottom:6px;">
          <button id="clearAllBtn" onclick="clearAllCompleted()" style="display:none;">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
        </div>
        <table id="results" aria-live="polite">
          <thead>
            <tr>
              <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
              <th>ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</th>
              <th>QR Code</th>
              <th>Ø§Ù„ÙƒÙ…ÙŠØ© (ÙƒØ¬Ù…)</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠØ³Ø§Ø±: Ø§Ù„Ù…ÙƒØªÙ…Ù„ -->
      <div class="col" aria-label="Ø§Ù„Ù…ÙƒØªÙ…Ù„">
        <h3>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</h3>
        <div style="text-align:left; margin-bottom:6px;">
          <button id="exportBtn" class="btn primary" onclick="exportCompleted()">Ø­ÙØ¸/ØªØµØ¯ÙŠØ± (Excel)</button>
          <button id="deleteAllCompleted" class="btn ghost" onclick="clearCompleted()">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
        </div>
        <table id="finalResults" aria-live="polite">
          <thead>
            <tr>
              <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
              <th>ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</th>
              <th>QR Code</th>
              <th>Ø§Ù„ÙƒÙ…ÙŠØ© (ÙƒØ¬Ù…)</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø±Ù‚Ù…ÙŠØ© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©/Ø§Ù„ÙˆØ²Ù† -->
  <div id="modalOverlay" class="modal-overlay" role="dialog" aria-modal="true">
    <div class="modal" role="document">
      <h4 id="modalTitle">Ø§Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© / Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)</h4>
      <input id="modalInput" class="num-input" type="text" inputmode="decimal" placeholder="Ù…Ø«Ø§Ù„: 1.25" />
      <div class="numpad" id="modalNumpad">
        <button onclick="modalDigit('1')">1</button><button onclick="modalDigit('2')">2</button><button onclick="modalDigit('3')">3</button>
        <button onclick="modalDigit('4')">4</button><button onclick="modalDigit('5')">5</button><button onclick="modalDigit('6')">6</button>
        <button onclick="modalDigit('7')">7</button><button onclick="modalDigit('8')">8</button><button onclick="modalDigit('9')">9</button>
        <button onclick="modalBack()">âŒ«</button><button onclick="modalDigit('0')">0</button><button onclick="modalDot()">.</button>
      </div>
      <div style="margin-top:10px;">
        <button class="btn primary" onclick="confirmModal()">ØªÙ…</button>
        <button class="btn ghost" onclick="cancelModal()">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
      <div class="small-note">Ø§Ù„Ù‚ÙŠÙ…Ø© ØªÙØ®Ø²Ù‘Ù† ÙˆØªØ¹Ø±Ø¶ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¨Ø§Ù„ÙƒÙŠÙ„Ùˆ Ø¬Ø±Ø§Ù… (ÙƒØ¬Ù…)</div>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© ØµØºÙŠØ±Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Ø³ØªØ¸Ù‡Ø± Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø®Ø§Ù†Ø©) -->
  <div id="oldValuePopup" style="position:fixed; display:none; z-index:220; background:#333; color:#fff; padding:6px 8px; border-radius:6px; font-size:13px;"></div>

  <script>
    /**************************************************************************
     * Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
     **************************************************************************/
    let excelData = [];        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥ÙƒØ³Ù„ ÙƒÙ€ array of arrays
    let qrScanner = null;      // Ù…Ø«ÙŠÙ„ html5-qrcode
    let scanningMode = null;   // 'qr' Ø£Ùˆ null
    let lastScan = { text: null, time: 0 };
    const correctPassword = "10100"; // ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙƒÙ…Ø§ ÙƒØ§Ù†Øª

    /* Ø¹Ù†Ø§ØµØ± DOM */
    const statusEl = document.getElementById('status');
    const loginBox = document.getElementById('loginBox');
    const passwordInput = document.getElementById('passwordInput');
    const passErrorBox = document.getElementById('passError');
    const app = document.getElementById('app');

    const searchBar = document.getElementById('searchBar');
    const resultsTbody = document.querySelector('#results tbody');
    const finalTbody = document.querySelector('#finalResults tbody');
    const reader = document.getElementById('reader');
    const cameraBtn = document.getElementById('cameraBtn');

    const modalOverlay = document.getElementById('modalOverlay');
    const modalInput = document.getElementById('modalInput');
    const oldValuePopup = document.getElementById('oldValuePopup');

    // Ø®Ø±ÙŠØ·Ø© Ù„ØªØªØ¨Ø¹ Ø§Ù„ØµÙ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§Ù„Ø°ÙŠ Ù†Ø·Ù„Ø¨ Ù„Ù‡ Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…Ù† Ø§Ù„Ù†Ø§ÙØ°Ø©
    let pendingRowForValue = null; // {rowEl, rowIndex, sourceRowData}

    // Ø§Ø³Ù… Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ Ø§Ù„Ù…ØµØ¯Ø± (ÙŠÙ‚Ø±Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©)
    const sourceXlsxName = "product.template(176).xlsx";

    /**************************************************************************
     * Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ (ÙƒÙ…Ø§ ÙƒØ§Ù†)
     **************************************************************************/
    fetch(sourceXlsxName)
      .then(res => res.arrayBuffer())
      .then(data => {
        try {
          const workbook = XLSX.read(new Uint8Array(data), { type: 'array' });
          const firstSheet = workbook.SheetNames[0];
          excelData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet], { header: 1 });
          statusEl.textContent = "Ù…Ù„Ù ÙØ¹Ø§Ù„";
          statusEl.className = "active";
        } catch (err) {
          console.error("Ø®Ø·Ø£ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥ÙƒØ³Ù„:", err);
          statusEl.textContent = "Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­";
          statusEl.className = "inactive";
        }
      })
      .catch(err => {
        console.warn("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„:", err);
        statusEl.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù ÙØ¹Ø§Ù„";
        statusEl.className = "inactive";
      });

    /**************************************************************************
     * Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ ÙˆØ§Ù„ÙƒÙŠØ¨ÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ
     **************************************************************************/
    passwordInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        submitPass();
      } else {
        clearError();
      }
    });
    passwordInput.addEventListener('input', function() { clearError(); });

    function pressDigit(d) {
      passwordInput.value = (passwordInput.value || "") + d;
      clearError();
    }
    function backspacePass() {
      passwordInput.value = (passwordInput.value || "").slice(0, -1);
      clearError();
    }
    function submitPass() {
      if ((passwordInput.value || "") === correctPassword) {
        loginBox.style.display = "none";
        app.style.display = "block";
        clearError();
        setTimeout(() => { if (searchBar) searchBar.focus(); }, 150);
      } else {
        showError("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
      }
    }
    function showError(msg) {
      if (!passErrorBox) return;
      passErrorBox.textContent = msg;
      passErrorBox.style.display = "block";
    }
    function clearError() {
      if (!passErrorBox) return;
      passErrorBox.textContent = "";
      passErrorBox.style.display = "none";
    }

    /**************************************************************************
     * Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¨Ø­Ø« ÙˆØ¥Ø¸Ù‡Ø§Ø± Ù†ØªØ§Ø¦Ø¬ (Ø§Ù„ÙŠÙ…ÙŠÙ†) â€” Ø­Ø°Ù Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø³Ø¹Ø± Ù…Ù† Ø§Ù„Ø¹Ø±Ø¶
     **************************************************************************/
    function search(fromScanner = false, value = '') {
      const query = fromScanner ? (String(value || "")).trim().toLowerCase() : (searchBar.value || "").trim().toLowerCase();
      if (!query) {
        if (fromScanner) {
          searchBar.value = "";
          searchBar.dispatchEvent(new Event('input'));
        }
        return;
      }
      if (!Array.isArray(excelData) || excelData.length === 0) return;

      resultsTbody.innerHTML = "";

      excelData.forEach((row, idx) => {
        if (idx === 0) return; // header
        const name = (row[0] || "").toString();
        const price = (row[1] || "").toString(); // Ø³Ù†Ù‚Ø±Ø£ Ù„ÙƒÙ† Ù„Ø§ Ù†Ø¸Ù‡Ø±Ù‡
        const scaleCode = (row[2] || "").toString();
        const qr = (row[3] || "").toString();

        const a = name.toLowerCase();
        const c = scaleCode.toLowerCase();
        const d = qr.toLowerCase();

        if (a.includes(query) || c.includes(query) || d.includes(query)) {
          // ØªØ£ÙƒØ¯ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…ÙƒØ±Ø± ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙ…ÙŠÙ† (Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±)
          const exists = Array.from(resultsTbody.rows).some(r => {
            const rQr = (r.cells[2] && r.cells[2].textContent) || "";
            const rCode = (r.cells[1] && r.cells[1].textContent) || "";
            return (rQr && rQr === qr) || (rCode && rCode === scaleCode);
          });
          if (exists) {
            // Ù†Ø¹Ø±Ø¶ ØµÙ Ù…Ø®ØªØµØ± ÙŠÙ†Ø¨Ù‡ Ù„Ù„Ù…ÙƒØ±Ø±
            const tr = document.createElement('tr');
            const td0 = document.createElement('td'); td0.textContent = name; tr.appendChild(td0);
            const td1 = document.createElement('td'); td1.textContent = scaleCode; tr.appendChild(td1);
            const td2 = document.createElement('td'); td2.textContent = qr; tr.appendChild(td2);
            const td3 = document.createElement('td'); td3.textContent = ''; tr.appendChild(td3);
            const td4 = document.createElement('td'); td4.textContent = 'Ù…ÙƒØ±Ø±'; tr.appendChild(td4);
            resultsTbody.appendChild(tr);
            return;
          }

          const tr = document.createElement('tr');
          const td0 = document.createElement('td'); td0.textContent = name || ""; tr.appendChild(td0);
          const td1 = document.createElement('td'); td1.textContent = scaleCode || ""; tr.appendChild(td1);
          const td2 = document.createElement('td'); td2.textContent = qr || ""; tr.appendChild(td2);

          const tdQty = document.createElement('td');
          tdQty.textContent = ''; // Ø³ÙŠÙØ³ØªÙƒÙ…Ù„ Ø¹Ø¨Ø± Ø§Ù„Ù†Ø§ÙØ°Ø©
          tr.appendChild(tdQty);

          const tdAction = document.createElement('td');

          const receiveBtn = document.createElement('button');
          receiveBtn.className = 'addBtn';
          receiveBtn.textContent = 'Ø§Ø³ØªÙ„Ø§Ù…';
          receiveBtn.addEventListener('click', () => {
            openQuantityModal(tr);
          });
          tdAction.appendChild(receiveBtn);

          const moveBtn = document.createElement('button');
          moveBtn.className = 'moveBtn';
          moveBtn.style.marginRight = '6px';
          moveBtn.textContent = 'Ù†Ù‚Ù„';
          moveBtn.addEventListener('click', () => moveRowToCompleted(tr));
          tdAction.appendChild(moveBtn);

          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'delBtn';
          deleteBtn.style.marginRight = '6px';
          deleteBtn.textContent = 'Ø­Ø°Ù';
          deleteBtn.addEventListener('click', () => { tr.remove(); checkClearAllVisibility(); });
          tdAction.appendChild(deleteBtn);

          tr.appendChild(tdAction);
          resultsTbody.appendChild(tr);

          // Ù„Ùˆ Ø§Ù„Ø¨Ø­Ø« Ø¬Ø§Ø¡ Ù…Ù† Ø§Ù„Ù…Ø§Ø³Ø­ WITH exact match: Ù†ÙØªØ­ Ù…Ø¨Ø§Ø´Ø±Ø© Ù†Ø§ÙØ°Ø© Ø§Ù„ÙƒÙ…ÙŠØ©
          const exactMatch = ((d && d === query) || (c && c === query));
          if (fromScanner && exactMatch) {
            openQuantityModal(tr);
          }
        }
      });

      // ØªÙØ±ÙŠØº Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« Ù„Ùˆ Ø¬Ø§Ø¡ Ù…Ù† Ø§Ù„Ù…Ø§Ø³Ø­
      if (fromScanner) {
        searchBar.value = "";
        searchBar.dispatchEvent(new Event('input'));
      }
    }

    function clearSearch() {
      searchBar.value = "";
      resultsTbody.innerHTML = "";
    }

    /**************************************************************************
     * Ù„ÙˆØ­Ø© Ø±Ù‚Ù…ÙŠØ© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©/Ø§Ù„ÙˆØ²Ù† (Ø§Ù„Ù‚ÙŠÙ…Ø© ØªØ¹Ø±Ø¶ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¨Ø§Ù„ÙƒØ¬Ù…)
     **************************************************************************/
    fun