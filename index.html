<!-- زر ونافذة لعرض ونسخ كود الملف -->
<style>
  #copyCodeBtn {
    position: fixed;
    bottom: 18px;
    left: 18px;
    z-index: 400;
    background:#0d6efd;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;
  }
  #codeModalOverlay {
    display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:450; align-items:center; justify-content:center;
  }
  #codeModal {
    width: min(960px, 96%); max-height: 86%; overflow:auto;
    background:#fff; border-radius:8px; padding:12px; box-shadow:0 6px 30px rgba(0,0,0,0.25); direction:ltr;
  }
  #codeArea { width:100%; height:420px; font-family: monospace; font-size:12px; white-space:pre; overflow:auto; }
  .modal-actions { margin-top:8px; text-align:right; }
  .modal-actions button { margin-left:8px; padding:8px 12px; border-radius:6px; cursor:pointer; }
</style>

<button id="copyCodeBtn" title="عرض ونسخ كود الصفحة">نسخ الكود</button>

<div id="codeModalOverlay" role="dialog" aria-modal="true">
  <div id="codeModal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
      <strong>كود الصفحة (index.html)</strong>
      <button onclick="closeCodeModal()" style="background:#dc3545;color:#fff;border:none;padding:6px 8px;border-radius:6px;cursor:pointer;">إغلاق</button>
    </div>
    <textarea id="codeArea" readonly></textarea>
    <div class="modal-actions">
      <button id="copyToClipboardBtn" style="background:#0d6efd;color:#fff;border:none;">نسخ للحافظة</button>
      <button id="downloadCodeBtn" style="background:#198754;color:#fff;border:none;">تحميل كملف</button>
    </div>
    <div style="font-size:12px;margin-top:8px;color:#666;">انسخ النص ثم ألصقه هنا في الشات لإرساله.</div>
  </div>
</div>

<script>
  const copyCodeBtn = document.getElementById('copyCodeBtn');
  const codeModalOverlay = document.getElementById('codeModalOverlay');
  const codeArea = document.getElementById('codeArea');
  const copyToClipboardBtn = document.getElementById('copyToClipboardBtn');
  const downloadCodeBtn = document.getElementById('downloadCodeBtn');

  // محاولة جلب النص الأصلي من raw.githubusercontent، وإلا نستخدم DOM الحالي
  async function fetchSource() {
    try {
      // غيّر owner/repo/branch/path لو كان مختلف
      const rawUrl = 'https://raw.githubusercontent.com/abdalam142/002/main/index.html';
      const res = await fetch(rawUrl);
      if (res.ok) {
        return await res.text();
      }
    } catch(e) {
      // تجاهل الخطأ واستعمل DOM
    }
    // احتياطي: نسخة من DOM الحالية (قد تختلف عن الملف الأصلي)
    return '<!-- نسخة من DOM الحالي -->\n' + document.documentElement.outerHTML;
  }

  async function openCodeModal() {
    codeArea.value = '...جارٍ التحميل';
    codeModalOverlay.style.display = 'flex';
    const src = await fetchSource();
    codeArea.value = src;
    // اجعل النص محدد لتسهيل النسخ
    codeArea.select();
  }

  function closeCodeModal() {
    codeModalOverlay.style.display = 'none';
  }

  copyCodeBtn.addEventListener('click', openCodeModal);
  copyToClipboardBtn.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(codeArea.value);
      copyToClipboardBtn.textContent = 'تم النسخ ✓';
      setTimeout(() => copyToClipboardBtn.textContent = 'نسخ للحافظة', 1400);
    } catch(e) {
      alert('فشل النسخ. يمكنك تحديد النص ونسخه يدوياً.');
    }
  });

  downloadCodeBtn.addEventListener('click', () => {
    const blob = new Blob([codeArea.value], {type:'text/html;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'index.html';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // إغلاق بالنقر خارج النافذة
  codeModalOverlay.addEventListener('click', (ev) => {
    if (ev.target === codeModalOverlay) closeCodeModal();
  });
</script>