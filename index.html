<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=1200" />
  <title>Ù†Ø¸Ø§Ù… Ø¨Ø­Ø« ÙˆØ§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Excel + QR)</title>

  <!-- Ù…ÙƒØªØ¨Ø§Øª -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8"></script>

  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --muted:#6c757d;
      --primary:#0d6efd; --danger:#dc3545; --success:#198754;
      --header-fill:#cfe2ff;
    }
    html,body{height:100%; margin:0; background:var(--bg); font-family:Arial, sans-serif; direction:rtl}
    .wrap{max-width:1200px; margin:18px auto; padding:16px;}
    header{display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:12px}
    header h1{font-size:20px; margin:0;}
    .controls{display:flex; gap:8px; align-items:center}
    input[type="text"]{padding:10px 12px; border-radius:8px; border:1px solid #ddd; width:420px; font-size:15px}
    .btn{padding:9px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:600}
    .primary{background:var(--primary); color:#fff}
    .ghost{background:#e9ecef}
    .small{padding:6px 8px; border-radius:6px; cursor:pointer}
    .col{background:var(--card); padding:12px; border-radius:10px; box-shadow:0 1px 6px rgba(0,0,0,0.05); box-sizing:border-box}
    .col.half{flex: 0 0 48%;}
    .columns{display:flex; gap:18px; align-items:flex-start; flex-wrap:wrap;}
    .table-wrapper{max-height:60vh; overflow:auto; border-radius:6px; background:var(--card); padding:6px}
    table{width:100%; border-collapse:collapse; table-layout:fixed; word-wrap:break-word}
    thead th{background:var(--header-fill); padding:8px; border:1px solid #e0e0e0; font-weight:700}
    tbody td{padding:8px; border:1px solid #e6e6e6; text-align:center; vertical-align:middle}
    .addBtn{background:var(--success); color:#fff; border:none; padding:6px 10px; border-radius:6px}
    .delBtn{background:var(--danger); color:#fff; border:none; padding:6px 10px; border-radius:6px}
    .editBtn{background:#ffc107; color:#111; border:none; padding:6px 10px; border-radius:6px}
    #status{position:fixed; top:12px; right:12px; padding:8px 12px; border-radius:8px; color:#fff; font-weight:700; z-index:60}
    #status.inactive{background:var(--danger)} #status.active{background:var(--success)}
    #reader { width:100%; max-width:420px; margin-top:8px; }
    @media (max-width:900px){ .col.half{flex: 0 0 100%} #reader{width:100%} .controls{flex-direction:column; align-items:flex-start} }

    /* Ù…ÙˆØ¯Ø§Ù„ */
    .modal-overlay{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.45); z-index:999}
    .modal{background:#fff; border-radius:10px; padding:14px; width:420px; max-width:95%; box-sizing:border-box;}
    .modal h4{margin:0 0 8px}
    .modal .modal-input{width:100%; padding:10px; font-size:20px; text-align:center; border-radius:8px; border:1px solid #ddd}
    .numpad{display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; margin-top:10px}
    .numpad button{padding:12px; font-size:18px; border-radius:8px; border:1px solid #ccc; background:#f4f4f4; cursor:pointer}
    .modal .actions{display:flex; gap:8px; justify-content:center; margin-top:12px}
    .note{color:var(--muted); font-size:13px; margin-top:8px}
  </style>
</head>
<body>
  <div id="status" class="inactive">Ø¬Ø§Ø±Ù Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„...</div>

  <div class="wrap">
    <header>
      <h1>Ù†Ø¸Ø§Ù… Ø¨Ø­Ø« ÙˆØ§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ù…Ù† Ù…Ù„Ù Excel)</h1>
      <div class="controls">
        <div style="display:flex; align-items:center; gap:8px;">
          <input id="searchBar" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù† Ø£Ùˆ QR" aria-label="Ø¨Ø­Ø«">
          <button id="searchBtn" class="btn primary">Ø¨Ø­Ø«</button>
          <button id="clearBtn" class="btn ghost">Ø­Ø°Ù</button>
        </div>
        <div style="display:flex; align-items:center; gap:8px; margin-left:8px;">
          <button id="cameraBtn" class="btn ghost">ğŸ“· Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
          <button id="scaleBtn" class="btn ghost">ğŸ“¶ ÙÙ„ØªØ± ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</button>
        </div>
      </div>
    </header>

    <div style="margin-bottom:10px;">
      <label for="fileInput">Ø±ÙØ¹ Ù…Ù„Ù Ø¥ÙƒØ³Ù„ Ù…Ø­Ù„ÙŠ (Ø¥Ø°Ø§ Ù„Ù… ÙŠÙÙ‚Ø±Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹): </label>
      <input id="fileInput" type="file" accept=".xlsx,.xls" />
      <span class="note">Ø§Ù„ØªØ±ØªÙŠØ¨ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥ÙƒØ³Ù„ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ†: Ø§Ø³Ù… - Ø³Ø¹Ø± - ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù† - QR</span>
    </div>

    <div class="columns">
      <!-- Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« -->
      <div class="col half" aria-label="Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <h3 style="margin:0">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</h3>
          <div><button id="clearResultsBtn" class="small ghost" style="display:none">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button></div>
        </div>

        <div id="reader" aria-hidden="true"></div>

        <div class="table-wrapper">
          <table id="resultsTable" aria-live="polite">
            <thead>
              <tr>
                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
                <th>ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</th>
                <th>Ø§Ù„Ø¹Ø¯Ø¯/Ø§Ù„ÙˆØ²Ù†</th>
                <th>QR Code</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© -->
      <div class="col half" aria-label="Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <h3 style="margin:0">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</h3>
          <div>
            <button id="clearAllBtn" class="small ghost" style="display:none">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
            <button id="exportBtn" class="small primary">ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„</button>
          </div>
        </div>

        <div class="table-wrapper">
          <table id="finalTable" aria-live="polite">
            <thead>
              <tr>
                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
                <th>Ø§Ù„Ø³Ø¹Ø±</th>
                <th>Ø§Ù„Ø¹Ø¯Ø¯/Ø§Ù„ÙˆØ²Ù†</th>
                <th>ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</th>
                <th>QR</th>
                <th>Ø­Ø°Ù</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div style="margin-top:14px; color:var(--muted); font-size:14px">
      Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ØµÙ„ÙŠ Ø³ÙŠÙÙ‚Ø±Ø£ ÙÙ‚Ø· ÙˆÙ„Ø§ ÙŠÙØ¹Ø¯Ù‘Ù„. Ø¥Ø°Ø§ Ù„Ù… ÙŠÙØ¹Ø«Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø§Ø³ØªØ®Ø¯Ù… Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­Ù„ÙŠ Ø£Ø¹Ù„Ø§Ù‡.
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… -->
  <div class="modal-overlay" id="receiveModal" role="dialog" aria-modal="true">
    <div class="modal" role="document" aria-labelledby="modalTitle">
      <h4 id="modalTitle">Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ù†ØªØ¬</h4>
      <div id="modalName" style="text-align:center; font-weight:700; margin-bottom:8px"></div>
      <!-- input ÙŠØ¯Ø¹Ù… Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ Ø§Ù„ÙØ¹Ù„ÙŠ ÙˆÙŠØ¯Ø¹Ù… numpad Ø§Ù„Ù…Ø¯Ù…Ø¬ -->
      <input id="modalInput" class="modal-input" inputmode="decimal" placeholder="Ø§Ù„Ø¹Ø¯Ø¯ Ø£Ùˆ Ø§Ù„ÙˆØ²Ù† (Ù…Ø«Ø§Ù„: 2 Ø£Ùˆ 0.5)" autocomplete="off" />
      <div class="numpad" aria-hidden="false">
        <button type="button" data-key="7">7</button>
        <button type="button" data-key="8">8</button>
        <button type="button" data-key="9">9</button>
        <button type="button" data-key="4">4</button>
        <button type="button" data-key="5">5</button>
        <button type="button" data-key="6">6</button>
        <button type="button" data-key="1">1</button>
        <button type="button" data-key="2">2</button>
        <button type="button" data-key="3">3</button>
        <button type="button" id="modalBack">âŒ«</button>
        <button type="button" data-key="0">0</button>
        <button type="button" data-key=".">.</button>
      </div>
      <div class="actions">
        <button class="btn ghost" id="modalCancel">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn primary" id="modalConfirm">ØªÙ…</button>
      </div>
    </div>
  </div>

  <script>
    /**************************************************************************
     * Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆÙ…ØªØ­ÙˆÙ„Ø§Øª Ø¹Ø§Ù…Ø©
     * ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ Ø§Ù„Ø¥ÙƒØ³Ù„: [0]=Ø§Ø³Ù…, [1]=Ø³Ø¹Ø±, [2]=ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†, [3]=QR
     **************************************************************************/
    const excelCandidates = [
      "products.xlsx",
      "product.template(176).xlsx",
      "product.xlsx",
      "products.xls",
      "data.xlsx",
      "Ø¹Ù†Ø¯Ùƒ.xlsx",
      "Ø¹Ù†Ø¯Ùƒ.xls"
    ];

    let rawExcel = []; // array of arrays (sheet_to_json header:1)
    let startIndex = 1; // default assume header in first row
    const NAME_IDX = 0, PRICE_IDX = 1, CODE_IDX = 2, QR_IDX = 3;

    // Ø¹Ù†Ø§ØµØ± DOM
    const statusEl = document.getElementById('status');
    const fileInput = document.getElementById('fileInput');
    const searchBar = document.getElementById('searchBar');
    const searchBtn = document.getElementById('searchBtn');
    const clearBtn = document.getElementById('clearBtn');
    const cameraBtn = document.getElementById('cameraBtn');
    const scaleBtn = document.getElementById('scaleBtn');
    const resultsTbody = document.querySelector('#resultsTable tbody');
    const finalTbody = document.querySelector('#finalTable tbody');
    const clearResultsBtn = document.getElementById('clearResultsBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const exportBtn = document.getElementById('exportBtn');
    const readerDiv = document.getElementById('reader');

    const receiveModalOverlay = document.getElementById('receiveModal');
    const modalInput = document.getElementById('modalInput');
    const modalName = document.getElementById('modalName');
    const modalBackBtn = document.getElementById('modalBack');
    const modalCancelBtn = document.getElementById('modalCancel');
    const modalConfirmBtn = document.getElementById('modalConfirm');

    // Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±: uid -> { rowEl, qty, rowArray }
    const finalMap = new Map();

    // QR scanner state
    let html5QrCode = null;
    let scannerRunning = false;
    let lastScan = { text: null, time: 0, tolerance: 800 };

    // modal state
    let modalCurrentSourceIndex = null; // index in rawExcel
    let modalEditingFinalUid = null;    // uid when editing final
    let modalOpen = false;
    let lastModalUid = null;
    let lastModalTime = 0;
    const MODAL_COOLDOWN = 600; // ms

    // duplicate source detection
    let duplicatesInSource = false;
    let shownDuplicateAlert = false;

    /**************************************************************************
     * Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥ÙƒØ³Ù„ ÙˆØ§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø®Ù„Ø§ÙŠØ§
     **************************************************************************/
    function parseWorkbookArrayBuffer(buff, sourceName){
      try {
        const wb = XLSX.read(new Uint8Array(buff), { type: 'array' });
        const firstSheet = wb.SheetNames[0];
        rawExcel = XLSX.utils.sheet_to_json(wb.Sheets[firstSheet], { header: 1 });
        // ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ header Ù†ØµÙŠ ÙÙŠ Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„
        if(rawExcel.length > 0){
          const firstRowText = (rawExcel[0] || []).join(" ").toString();
          if(/[a-zA-Z\u0600-\u06FF]/.test(firstRowText)) startIndex = 1; else startIndex = 0;
        } else startIndex = 0;

        statusEl.textContent = "Ù…Ù„Ù ÙØ¹Ø§Ù„: " + (sourceName || firstSheet);
        statusEl.className = "active";

        detectDuplicatesInSource();
        console.debug("Excel loaded:", { rows: rawExcel.length, startIndex, NAME_IDX, PRICE_IDX, CODE_IDX, QR_IDX });
      } catch (e) {
        console.error("Ø®Ø·Ø£ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥ÙƒØ³Ù„:", e);
        statusEl.textContent = "ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥ÙƒØ³Ù„";
        statusEl.className = "inactive";
        rawExcel = [];
      }
    }

    function tryLoadExcelCandidates(list){
      let idx = 0;
      function attempt(){
        if(idx >= list.length){
          statusEl.textContent = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. Ø§Ø³ØªØ®Ø¯Ù… Ø±ÙØ¹ Ù…Ù„Ù Ù…Ø­Ù„ÙŠ.";
          statusEl.className = "inactive";
          return;
        }
        const name = list[idx++];
        fetch(name).then(res=>{
          if(!res.ok) throw new Error("not found");
          return res.arrayBuffer();
        }).then(buff=>{
          parseWorkbookArrayBuffer(buff, name);
        }).catch(err=>{
          console.warn("fetch failed", name, err);
          attempt();
        });
      }
      attempt();
    }

    // Ø±ÙØ¹ Ù…Ù„Ù Ù…Ø­Ù„ÙŠ
    fileInput.addEventListener('change', function(e){
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = function(ev){ parseWorkbookArrayBuffer(ev.target.result, f.name); };
      reader.onerror = function(err){ console.error("FileReader error", err); statusEl.textContent = "ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­Ù„ÙŠ"; statusEl.className = "inactive"; };
      reader.readAsArrayBuffer(f);
    });

    function getCell(row, idx){
      if(!row) return "";
      const v = row[idx];
      if(v === undefined || v === null) return "";
      return String(v);
    }

    function uidFromRowArray(row){
      const qr = getCell(row, QR_IDX).toString().trim();
      const code = getCell(row, CODE_IDX).toString().trim();
      const name = getCell(row, NAME_IDX).toString().trim();
      if(qr) return "QR::" + qr;
      if(code) return "CODE::" + code;
      return "NAME::" + name;
    }

    function detectDuplicatesInSource(){
      duplicatesInSource = false;
      shownDuplicateAlert = false;
      if(!Array.isArray(rawExcel) || rawExcel.length <= startIndex) return;
      const seen = new Set();
      for(let i = startIndex; i < rawExcel.length; i++){
        const row = rawExcel[i] || [];
        if(row.length === 0) continue;
        const uid = uidFromRowArray(row);
        if(seen.has(uid)){ duplicatesInSource = true; break; }
        seen.add(uid);
      }
      if(duplicatesInSource){
        statusEl.textContent += " (ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…ÙƒØ±Ø±Ø© ÙÙŠ Ø§Ù„Ù…ØµØ¯Ø±)";
      }
    }

    /**************************************************************************
     * Ø§Ù„Ø¨Ø­Ø«: Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« Ù‡Ùˆ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„ÙˆØ­ÙŠØ¯ â€” Ù†Ø¹Ø±Ø¶ Ù†Ø³Ø®Ø© ÙˆØ§Ø­Ø¯Ø© Ù„ÙƒÙ„ UID ÙÙ‚Ø·
     **************************************************************************/
    let scaleFilterActive = false;
    function search(fromScanner=false, val=""){
      const q = (fromScanner ? String(val) : (searchBar.value || "")).trim().toLowerCase();
      resultsTbody.innerHTML = "";
      if(!Array.isArray(rawExcel) || rawExcel.length <= startIndex){
        checkClearResultsVisibility();
        return;
      }
      if(q === ""){
        checkClearResultsVisibility();
        return;
      }

      if(duplicatesInSource && !shownDuplicateAlert){
        alert("ØªØ­Ø°ÙŠØ±: ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…ÙƒØ±Ø±Ø© ÙÙŠ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„. Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ù†Ø³Ø®Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ù„ÙƒÙ„ Ù…Ù†ØªØ¬ ÙÙŠ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«.");
        shownDuplicateAlert = true;
      }

      const shownUids = new Set();
      for(let i = startIndex; i < rawExcel.length; i++){
        const row = rawExcel[i] || [];
        if(row.length === 0) continue;
        const name = getCell(row, NAME_IDX).toLowerCase();
        const code = getCell(row, CODE_IDX).toLowerCase();
        const qr = getCell(row, QR_IDX).toLowerCase();
        if(name.includes(q) || code.includes(q) || qr.includes(q)){
          const uid = uidFromRowArray(row);
          if(shownUids.has(uid)) continue; // Ø¹Ø±Ø¶ Ù†Ø³Ø®Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
          shownUids.add(uid);

          const tr = document.createElement('tr');
          const tdName = document.createElement('td'); tdName.textContent = getCell(row, NAME_IDX); tr.appendChild(tdName);
          const tdCode = document.createElement('td'); tdCode.textContent = getCell(row, CODE_IDX); tr.appendChild(tdCode);
          const tdQty = document.createElement('td'); tdQty.textContent = ""; tr.appendChild(tdQty);
          const tdQr = document.createElement('td'); tdQr.textContent = getCell(row, QR_IDX); tr.appendChild(tdQr);

          const tdAction = document.createElement('td');
          const receiveBtn = document.createElement('button');
          receiveBtn.className = 'addBtn';
          receiveBtn.textContent = 'Ø§Ø³ØªÙ„Ø§Ù…';
          receiveBtn.addEventListener('click', ()=> openReceiveModalFromResults(i));
          tdAction.appendChild(receiveBtn);

          const delBtn = document.createElement('button');
          delBtn.className = 'delBtn';
          delBtn.textContent = 'Ø­Ø°Ù';
          delBtn.addEventListener('click', ()=> { tr.remove(); checkClearResultsVisibility(); });
          tdAction.appendChild(delBtn);

          tr.appendChild(tdAction);

          tr.dataset.sourceIndex = i;
          tr.dataset.uid = uid;

          resultsTbody.appendChild(tr);
        }
      }

      applyScaleFilterTo(resultsTbody);
      checkClearResultsVisibility();
    }

    function checkClearResultsVisibility(){ clearResultsBtn.style.display = (resultsTbody.rows.length === 0) ? 'none' : 'inline-block'; }
    function clearSearch(){ searchBar.value = ""; resultsTbody.innerHTML = ""; checkClearResultsVisibility(); }

    function toggleScaleFilter(){ scaleFilterActive = !scaleFilterActive; scaleBtn.classList.toggle('active', scaleFilterActive); applyScaleFilterTo(resultsTbody); applyScaleFilterTo(finalTbody); }
    function applyScaleFilterTo(tbody){
      if(!tbody) return;
      Array.from(tbody.rows).forEach(row=>{
        const code = (row.cells[1] && row.cells[1].textContent) || "";
        row.style.display = (scaleFilterActive && code.trim() === "") ? 'none' : '';
      });
    }

    /**************************************************************************
     * Ø¥ÙŠØ¬Ø§Ø¯ ØµÙ Ù…Ø·Ø§Ø¨Ù‚ Ø¨Ø§Ù„Ù‚ÙŠÙ…Ø© (QR exact -> code exact -> name contains)
     **************************************************************************/
    function findRowByValue(value){
      if(!Array.isArray(rawExcel) || rawExcel.length <= startIndex) return null;
      const v = String(value || "").trim();
      if(!v) return null;
      // QR exact
      for(let i = startIndex; i < rawExcel.length; i++){
        const row = rawExcel[i] || [];
        if(getCell(row, QR_IDX).toString().trim() === v) return i;
      }
      // code exact
      for(let i = startIndex; i < rawExcel.length; i++){
        const row = rawExcel[i] || [];
        if(getCell(row, CODE_IDX).toString().trim() === v) return i;
      }
      // name contains
      for(let i = startIndex; i < rawExcel.length; i++){
        const row = rawExcel[i] || [];
        if(getCell(row, NAME_IDX).toString().toLowerCase().includes(v.toLowerCase())) return i;
      }
      return null;
    }

    /**************************************************************************
     * Ù…ÙˆØ¯Ø§Ù„: ÙØªØ­ Ù…Ù† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ Ù…Ù† ØªØ¹Ø¯ÙŠÙ„ ØµÙ ÙÙŠ final
     **************************************************************************/
    function openReceiveModalFromResults(sourceIndex){
      modalCurrentSourceIndex = sourceIndex;
      modalEditingFinalUid = null;
      modalOpen = true;
      const row = rawExcel[sourceIndex] || [];
      modalName.textContent = getCell(row, NAME_IDX) || "";
      const uid = uidFromRowArray(row);
      if(finalMap.has(uid)) modalInput.value = finalMap.get(uid).qty || ""; else modalInput.value = "";
      receiveModalOverlay.style.display = 'flex';
      setTimeout(()=> {
        try{ modalInput.focus(); modalInput.select && modalInput.select(); }catch(e){}
      }, 120);
    }

    function openEditFinal(uid){
      if(!finalMap.has(uid)) return;
      modalEditingFinalUid = uid;
      modalCurrentSourceIndex = null;
      modalOpen = true;
      const entry = finalMap.get(uid);
      const r = entry.rowArray || entry.rowData || [];
      modalName.textContent = getCell(r, NAME_IDX) || getCell(r,0) || "";
      modalInput.value = entry.qty || "";
      receiveModalOverlay.style.display = 'flex';
      setTimeout(()=> {
        try{ modalInput.focus(); modalInput.select && modalInput.select(); }catch(e){}
      }, 120);
    }

    function closeModal(){
      receiveModalOverlay.style.display = 'none';
      modalInput.value = "";
      modalCurrentSourceIndex = null;
      modalEditingFinalUid = null;
      modalOpen = false;
      lastModalTime = Date.now();
    }

    // numpad buttons interaction + keep focus on input after click
    document.querySelectorAll('.numpad button[data-key]').forEach(btn=>{
      btn.addEventListener('click', ()=> {
        const k = btn.getAttribute('data-key');
        insertAtCaret(modalInput, k);
        modalInput.focus();
      });
    });
    modalBackBtn && modalBackBtn.addEventListener('click', ()=>{
      backspaceAtCaret(modalInput);
      modalInput.focus();
    });

    // helper to insert at caret position
    function insertAtCaret(input, text){
      try{
        const start = input.selectionStart || 0;
        const end = input.selectionEnd || 0;
        const val = input.value || "";
        input.value = val.slice(0,start) + text + val.slice(end);
        const pos = start + text.length;
        input.setSelectionRange(pos,pos);
      }catch(e){
        input.value = (input.value || "") + text;
      }
    }
    function backspaceAtCaret(input){
      try{
        const start = input.selectionStart || 0;
        const end = input.selectionEnd || 0;
        if(start === end && start > 0){
          const val = input.value || "";
          input.value = val.slice(0, start-1) + val.slice(end);
          const pos = start-1;
          input.setSelectionRange(pos,pos);
        } else {
          const val = input.value || "";
          input.value = val.slice(0,start) + val.slice(end);
          input.setSelectionRange(start,start);
        }
      }catch(e){
        input.value = (input.value || "").slice(0,-1);
      }
    }

    // ensure Enter and keys from physical keyboard work when modal open
    document.addEventListener('keydown', function(e){
      if(modalOpen){
        if(e.key === 'Enter'){
          e.preventDefault();
          confirmModal();
          return;
        }
        if(e.key === 'Escape'){
          e.preventDefault();
          closeModal();
          return;
        }
        // When modal is open: allow typing with keyboard â€” we only prevent default and insert
        // ourselves to guarantee consistent caret behavior even if input not focused.
        if((e.key >= '0' && e.key <= '9') || e.key === '.'){
          // if modalInput is focused, let browser handle input (to keep native composition), else insert
          if(document.activeElement !== modalInput){
            insertAtCaret(modalInput, e.key);
            e.preventDefault();
          }
          return;
        }
        if(e.key === 'Backspace'){
          if(document.activeElement !== modalInput){
            backspaceAtCaret(modalInput);
            e.preventDefault();
          }
          return;
        }
      } else {
        // when modal not open, allow Enter in searchBar to trigger search
        if(e.key === 'Enter' && document.activeElement === searchBar){
          e.preventDefault();
          search(false);
        }
      }
    });

    // also ensure modal input Enter key (if focused) triggers confirm
    modalInput.addEventListener('keydown', function(e){
      if(e.key === 'Enter'){
        e.preventDefault();
        confirmModal();
      } else if(e.key === 'Escape'){
        e.preventDefault();
        closeModal();
      }
    });

    // modal confirm/cancel events
    modalConfirmBtn.addEventListener('click', confirmModal);
    modalCancelBtn.addEventListener('click', closeModal);

    function confirmModal(){
      const v = (modalInput.value || '').trim();
      if(v === ''){ alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ±Ùƒ Ø§Ù„Ø­Ù‚Ù„ ÙØ§Ø±ØºØ§Ù‹'); modalInput.focus(); return; }
      const num = Number(v);
      if(!isFinite(num)){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ§Ù„Ø­'); modalInput.focus(); return; }

      if(modalEditingFinalUid){
        const entry = finalMap.get(modalEditingFinalUid);
        if(entry && entry.rowEl){
          entry.qty = v;
          entry.rowEl.cells[2].textContent = v;
        }
        searchBar.value = "";
        closeModal();
        return;
      }

      if(modalCurrentSourceIndex == null){
        alert('Ø®Ø·Ø£: Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØµØ¯Ø±');
        closeModal(); return;
      }

      const rowArray = rawExcel[modalCurrentSourceIndex] || [];
      addOrUpdateFinalFromRow(rowArray, v);

      // Update results row qty if visible
      Array.from(resultsTbody.rows).forEach(r=>{
        if(r.dataset && r.dataset.sourceIndex){
          if(Number(r.dataset.sourceIndex) === modalCurrentSourceIndex){
            r.cells[2].textContent = v;
          }
        }
      });

      // clear search bar after adding
      searchBar.value = "";

      closeModal();
    }

    /**************************************************************************
     * Ø¥Ø¶Ø§ÙØ©/ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø¬Ø¯ÙˆÙ„ final Ù…Ø¹ Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø­Ø³Ø¨ UID
     **************************************************************************/
    function addOrUpdateFinalFromRow(rowArray, qty){
      const uid = uidFromRowArray(rowArray);
      if(finalMap.has(uid)){
        const existing = finalMap.get(uid);
        existing.qty = qty;
        if(existing.rowEl) existing.rowEl.cells[2].textContent = qty;
        return 'updated';
      }
      const tr = document.createElement('tr');
      const tdName = document.createElement('td'); tdName.textContent = getCell(rowArray, NAME_IDX); tr.appendChild(tdName);
      const tdPrice = document.createElement('td'); tdPrice.textContent = getCell(rowArray, PRICE_IDX); tr.appendChild(tdPrice);
      const tdQty = document.createElement('td'); tdQty.textContent = qty; tr.appendChild(tdQty);
      const tdCode = document.createElement('td'); tdCode.textContent = getCell(rowArray, CODE_IDX); tr.appendChild(tdCode);
      const tdQr = document.createElement('td'); tdQr.textContent = getCell(rowArray, QR_IDX); tr.appendChild(tdQr);

      const tdDel = document.createElement('td');
      const delBtn = document.createElement('button'); delBtn.className='delBtn'; delBtn.textContent='Ø­Ø°Ù';
      delBtn.addEventListener('click', ()=> { tr.remove(); finalMap.delete(uid); checkClearAllVisibility(); });
      tdDel.appendChild(delBtn); tr.appendChild(tdDel);

      finalTbody.appendChild(tr);
      finalMap.set(uid, { rowEl: tr, qty: qty, rowArray: rowArray });
      applyScaleFilterTo(finalTbody);
      checkClearAllVisibility();
      return 'added';
    }

    function checkClearAllVisibility(){ clearAllBtn.style.display = (finalTbody.rows.length === 0) ? 'none' : 'inline-block'; }
    function clearAllSelected(){ finalTbody.innerHTML = ""; finalMap.clear(); checkClearAllVisibility(); }
    function clearTable(id){ const el = document.getElementById(id); if(!el) return; el.querySelector('tbody').innerHTML=""; if(id==='finalTable') finalMap.clear(); checkClearAllVisibility(); checkClearResultsVisibility(); }

    /**************************************************************************
     * **ØªØµØ¯ÙŠØ± Ù…Ù„Ù Excel Ù…Ø±ØªØ¨ ÙˆÙ…Ù‡Ù†Ø¯Ù… (HTML-based .xls)**
     * Ù†ÙˆÙ„Ø¯ Ù…Ù„Ù HTML ÙŠØ­ØªÙˆÙŠ Ø¬Ø¯ÙˆÙ„ Ù…Ù†Ø³Ù‚ (Ø®Ù„ÙÙŠØ© Ø±Ø¤ÙˆØ³ØŒ Ù…Ø­Ø§Ø°Ø§Ø©ØŒ Ø£Ø¹Ù…Ø¯Ø©)
     * Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ | Ø§Ù„Ø³Ø¹Ø± | Ø§Ù„Ø¹Ø¯Ø¯/Ø§Ù„ÙˆØ²Ù† | ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù† | QR
     **************************************************************************/
    function exportFinalToExcel(){
      // Build rows (preserve insertion order of finalMap)
      const rows = [];
      // header
      rows.push(["Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬","Ø§Ù„Ø³Ø¹Ø±","Ø§Ù„Ø¹Ø¯Ø¯/Ø§Ù„ÙˆØ²Ù†","ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†","QR"]);
      for(const [uid, entry] of finalMap){
        const r = entry.rowArray || [];
        const name = getCell(r, NAME_IDX) || (entry.rowEl && entry.rowEl.cells[0] && entry.rowEl.cells[0].textContent) || "";
        const price = getCell(r, PRICE_IDX) || (entry.rowEl && entry.rowEl.cells[1] && entry.rowEl.cells[1].textContent) || "";
        const qty = entry.qty || (entry.rowEl && entry.rowEl.cells[2] && entry.rowEl.cells[2].textContent) || "";
        const code = getCell(r, CODE_IDX) || (entry.rowEl && entry.rowEl.cells[3] && entry.rowEl.cells[3].textContent) || "";
        const qr = getCell(r, QR_IDX) || (entry.rowEl && entry.rowEl.cells[4] && entry.rowEl.cells[4].textContent) || "";
        rows.push([name, price, qty, code, qr]);
      }

      // Build HTML table string with inline styles for header
      let html = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" lang="ar"><head><meta charset="utf-8" /></head><body>';
      html += '<table border="1" style="border-collapse:collapse;">';
      // header with background color
      html += '<thead><tr>';
      const headerBg = '#cfe2ff';
      rows[0].forEach(h => {
        html += `<th style="background:${headerBg}; font-weight:bold; padding:6px 10px; text-align:center;">${escapeHtml(h)}</th>`;
      });
      html += '</tr></thead>';
      html += '<tbody>';
      for(let i = 1; i < rows.length; i++){
        html += '<tr>';
        rows[i].forEach(cell => {
          html += `<td style="padding:6px 8px; text-align:center;">${escapeHtml(cell)}</td>`;
        });
        html += '</tr>';
      }
      html += '</tbody></table></body></html>';

      // create blob and download as .xls (Excel will open and preserve inline styles)
      const blob = new Blob([html], { type: 'application/vnd.ms-excel;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'exported_products.xls';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function escapeHtml(s){
      if(s === undefined || s === null) return '';
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    /**************************************************************************
     * Ù‚Ø§Ø±Ø¦ QR: ÙŠØ®ØªØ§Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¥Ù† ÙˆÙØ¬Ø¯ØªØŒ Ù„Ø§ ÙŠÙˆÙ‚Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¨Ø¹Ø¯ ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„.
     **************************************************************************/
    function chooseBackCamera(devices){
      if(!devices || devices.length === 0) return null;
      const keywords = ["back","rear","env","environment","back camera","rear camera","Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø®Ù„ÙÙŠØ©","Ø®Ù„ÙÙŠ","backcam","rearcam"];
      for(const d of devices){
        const label = (d.label || "").toString().toLowerCase();
        for(const k of keywords) if(label.includes(k)) return d.id || d.deviceId || (d.id ?? d.deviceId);
      }
      if(devices.length > 1){
        const last = devices[devices.length - 1];
        return last.id || last.deviceId || (last.id ?? last.deviceId);
      }
      const first = devices[0];
      return first.id || first.deviceId || (first.id ?? first.deviceId);
    }

    async function startScanner(){
      if(scannerRunning){
        // stop scanner when user presses camera button again
        try{ await html5QrCode.stop(); }catch(e){}
        try{ html5QrCode.clear(); }catch(e){}
        html5QrCode = null; readerDiv.innerHTML = ""; scannerRunning = false; cameraBtn.textContent = 'ğŸ“· Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§';
        return;
      }

      readerDiv.innerHTML = ""; readerDiv.style.display = 'block'; cameraBtn.textContent = 'â¹ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§';
      try{
        html5QrCode = new Html5Qrcode("reader");
        const devices = await Html5Qrcode.getCameras().catch(()=>[]);
        const chosenId = chooseBackCamera(devices);
        const cameraConfig = chosenId ? { deviceId: { exact: chosenId } } : { facingMode: "environment" };

        await html5QrCode.start(
          cameraConfig,
          { fps: 10, qrbox: 250 },
          (decodedText, decodedResult) => {
            try {
              const now = Date.now();
              if(decodedText === lastScan.text && (now - lastScan.time) < lastScan.tolerance){
                lastScan.time = now; return;
              }
              lastScan.text = decodedText; lastScan.time = now;

              // Ù†Ø¶Ø¹ Ø§Ù„Ù‚ÙŠÙ…Ø© ÙÙŠ Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø«
              searchBar.value = decodedText;
              try{ searchBar.focus(); }catch(e){}

              // Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØµÙ Ù…Ø·Ø§Ø¨Ù‚
              const matchIndex = findRowByValue(decodedText);
              const uid = (matchIndex !== null) ? uidFromRowArray(rawExcel[matchIndex]) : null;

              // Ø¥Ø°Ø§ ÙˆØ¬Ø¯Ù†Ø§ Ù…Ø·Ø§Ø¨Ù‚Ù‹Ø§ ÙˆÙ†Ù‚Ø¯Ø± Ù†ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (Ù„Ù… ÙŠÙÙØªØ­ Ø­Ø§Ù„ÙŠØ§Ù‹ ÙˆÙ„Ù… ÙŠÙÙØªØ­ Ù…Ø¤Ø®Ø±Ø§Ù‹ Ù„Ù†ÙØ³ uid)
              if(matchIndex !== null){
                const now2 = Date.now();
                if(!modalOpen && (!lastModalUid || lastModalUid !== uid || (now2 - lastModalTime) > MODAL_COOLDOWN)){
                  modalOpen = true;
                  modalCurrentSourceIndex = matchIndex;
                  modalEditingFinalUid = null;
                  lastModalUid = uid;
                  lastModalTime = now2;
                  const row = rawExcel[matchIndex] || [];
                  modalName.textContent = getCell(row, NAME_IDX) || "";
                  if(finalMap.has(uid)) modalInput.value = finalMap.get(uid).qty || ""; else modalInput.value = "";
                  receiveModalOverlay.style.display = 'flex';
                  setTimeout(()=> {
                    try{ modalInput.focus(); modalInput.select && modalInput.select(); }catch(e){}
                  }, 120);
                }
              }
            } catch(err){
              console.error("scan callback error", err);
            }
          },
          (errorMessage) => {
            // ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ÙØ±ÙŠÙ…
          }
        );
        scannerRunning = true;
      }catch(err){
        alert('ÙØ´Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ' + (err && err.message ? err.message : err));
        readerDiv.innerHTML = ""; readerDiv.style.display = 'none'; scannerRunning = false; cameraBtn.textContent = 'ğŸ“· Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§';
      }
    }

    /**************************************************************************
     * Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ù„ØªØµØ±ÙØ§Øª
     **************************************************************************/
    document.getElementById('searchBtn').addEventListener('click', ()=> search(false));
    document.getElementById('clearBtn').addEventListener('click', clearSearch);
    document.getElementById('cameraBtn').addEventListener('click', startScanner);
    document.getElementById('scaleBtn').addEventListener('click', toggleScaleFilter);
    document.getElementById('clearResultsBtn').addEventListener('click', ()=> { resultsTbody.innerHTML = ""; checkClearResultsVisibility(); });
    document.getElementById('clearAllBtn').addEventListener('click', clearAllSelected);
    document.getElementById('exportBtn').addEventListener('click', exportFinalToExcel);

    document.addEventListener('keydown', function(e){
      if(e.key === 'Enter' && document.activeElement === searchBar){ e.preventDefault(); search(false); }
      if(e.key === 'Delete'){ if(finalTbody.rows.length > 0){ finalTbody.deleteRow(finalTbody.rows.length - 1); rebuildFinalMapFromDom(); checkClearAllVisibility(); } }
    });

    receiveModalOverlay.addEventListener('click', function(e){ if(e.target === receiveModalOverlay) closeModal(); });

    function rebuildFinalMapFromDom(){
      finalMap.clear();
      Array.from(finalTbody.rows).forEach(r=>{
        const name = r.cells[0] ? r.cells[0].textContent : "";
        const price = r.cells[1] ? r.cells[1].textContent : "";
        const qty = r.cells[2] ? r.cells[2].textContent : "";
        const code = r.cells[3] ? r.cells[3].textContent : "";
        const qr = r.cells[4] ? r.cells[4].textContent : "";
        const rArr = [name, price, code, qr];
        const uid = uidFromRowArray(rArr);
        finalMap.set(uid, { rowEl: r, qty: qty, rowArray: rArr });
      });
    }

    const observerFinal = new MutationObserver(()=> applyScaleFilterTo(finalTbody));
    observerFinal.observe(finalTbody, { childList:true, subtree:true });

    /**************************************************************************
     * Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„: Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
     **************************************************************************/
    window.addEventListener('load', function(){
      tryLoad();
      setTimeout(()=>{ try{ searchBar.focus(); }catch(e){} }, 200);
      checkClearAllVisibility(); checkClearResultsVisibility();
    });

    function tryLoad(){ tryLoadExcelCandidates(excelCandidates); }
    function tryLoadExcelCandidates(list){
      let idx = 0;
      function attempt(){
        if(idx >= list.length){
          statusEl.textContent = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. Ø§Ø³ØªØ®Ø¯Ù… Ø±ÙØ¹ Ù…Ù„Ù Ù…Ø­Ù„ÙŠ.";
          statusEl.className = "inactive";
          return;
        }
        const name = list[idx++];
        fetch(name).then(res=>{
          if(!res.ok) throw new Error("not found");
          return res.arrayBuffer();
        }).then(buff=> parseWorkbookArrayBuffer(buff, name)).catch(err=>{ attempt(); });
      }
      attempt();
    }

    /**************************************************************************
     * ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© Ø£Ø®ÙŠØ±Ø©
     **************************************************************************/
    function checkClearResultsVisibility(){ document.getElementById('clearResultsBtn').style.display = (resultsTbody.rows.length === 0) ? 'none' : 'inline-block'; }
    function checkClearAllVisibility(){ document.getElementById('clearAllBtn').style.display = (finalTbody.rows.length === 0) ? 'none' : 'inline-block'; }

  </script>
</body>
</html>
