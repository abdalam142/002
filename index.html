<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>Ø¨Ø­Ø« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>
  <meta name="viewport" content="width=1024" />
  <style>
    body { font-family: Arial, sans-serif; direction: rtl; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    .tables-wrapper { display: flex; gap: 20px; align-items: flex-start; }
    .table-box { width: 50%; }
    #status { margin-top: 10px; font-weight: bold; color: green; }
    .btn { margin: 5px; padding: 6px 12px; cursor: pointer; }
    .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%;
             background: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
    .modal-content { background: #fff; padding: 20px; border-radius: 8px; text-align: center; min-width: 300px; }
    .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
    .numpad button { padding: 15px; font-size: 18px; cursor: pointer; }
    video { max-width: 100%; border: 1px solid #ccc; margin-top: 10px; }
  </style>
</head>
<body>

  <h2>Ø¨Ø­Ø« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
  <input type="text" id="searchBar" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ QR" style="width:300px; padding:5px;" />
  <button class="btn" onclick="searchProducts()">Ø¨Ø­Ø«</button>
  <button class="btn" onclick="toggleFilter()">ÙÙ„ØªØ± ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</button>
  <button class="btn" onclick="toggleCamera()">ğŸ“· Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
  <div id="status"></div>
  <video id="preview" autoplay></video>

  <div class="tables-wrapper">
    <div class="table-box">
      <h3>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</h3>
      <button class="btn" onclick="clearTable('selectedTable')">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
      <button class="btn" onclick="exportExcel()">ØªØµØ¯ÙŠØ± Ø¥ÙƒØ³Ù„</button>
      <table id="selectedTable">
        <thead>
          <tr>
            <th>Ø§Ø³Ù…</th>
            <th>ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</th>
            <th>QR</th>
            <th>Ø§Ù„Ø¹Ø¯Ø¯/Ø§Ù„ÙˆØ²Ù†</th>
            <th>Ø­Ø°Ù</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="table-box">
      <h3>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</h3>
      <button class="btn" onclick="clearTable('resultsTable')">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
      <table id="resultsTable">
        <thead>
          <tr>
            <th>Ø§Ø³Ù…</th>
            <th>ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†</th>
            <th>QR</th>
            <th>Ø§Ø³ØªÙ„Ø§Ù…</th>
            <th>Ø­Ø°Ù</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <h3>Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ø¯Ø¯/Ø§Ù„ÙˆØ²Ù†</h3>
      <input type="text" id="modalInput" style="width:100%; padding:8px; font-size:16px;" />
      <div class="numpad">
        <button onclick="numpadPress('1')">1</button>
        <button onclick="numpadPress('2')">2</button>
        <button onclick="numpadPress('3')">3</button>
        <button onclick="numpadPress('4')">4</button>
        <button onclick="numpadPress('5')">5</button>
        <button onclick="numpadPress('6')">6</button>
        <button onclick="numpadPress('7')">7</button>
        <button onclick="numpadPress('8')">8</button>
        <button onclick="numpadPress('9')">9</button>
        <button onclick="numpadPress('.')">.</button>
        <button onclick="numpadPress('0')">0</button>
        <button onclick="numpadBack()">âŒ«</button>
      </div>
      <button class="btn" onclick="confirmModal()">ØªÙ…</button>
      <button class="btn" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>

  <!-- Ù…ÙƒØªØ¨Ø© XLSX + QR -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script>
    let products = [];
    let filterActive = false;
    let modalProduct = null;
    let html5QrCode;

    // ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø§ÙƒØ³Ù„
    fetch("products.xlsx")
      .then(res => res.arrayBuffer())
      .then(data => {
        let wb = XLSX.read(data, {type:"array"});
        let ws = wb.Sheets[wb.SheetNames[0]];
        let rows = XLSX.utils.sheet_to_json(ws, {header:1});
        products = rows.slice(1).map(r=>({
          name: r[0],
          price: r[1],
          code: r[2],
          qr: r[3]
        }));
        document.getElementById("status").textContent="âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„";
      })
      .catch(err=>{
        document.getElementById("status").textContent="âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„";
      });

    function searchProducts() {
      let q = document.getElementById("searchBar").value.trim();
      let resultsBody = document.querySelector("#resultsTable tbody");
      resultsBody.innerHTML = "";
      products.forEach(p=>{
        if(filterActive && !p.code) return;
        if(p.name.includes(q) || String(p.code).includes(q) || String(p.qr).includes(q)){
          let tr=document.createElement("tr");
          tr.innerHTML = `
            <td>${p.name}</td>
            <td>${p.code||""}</td>
            <td>${p.qr||""}</td>
            <td><button onclick="openModal(${JSON.stringify(p).replace(/"/g,'&quot;')})">Ø§Ø³ØªÙ„Ø§Ù…</button></td>
            <td><button onclick="tr.remove()">ğŸ—‘</button></td>`;
          resultsBody.appendChild(tr);
        }
      });
    }

    function toggleFilter(){
      filterActive=!filterActive;
      searchProducts();
    }

    function clearTable(id){
      document.querySelector("#"+id+" tbody").innerHTML="";
    }

    function openModal(product){
      modalProduct = product;
      document.getElementById("modalInput").value="";
      document.getElementById("modal").style.display="flex";
    }

    function closeModal(){
      document.getElementById("modal").style.display="none";
    }

    function numpadPress(v){
      let inp=document.getElementById("modalInput");
      inp.value += v;
    }
    function numpadBack(){
      let inp=document.getElementById("modalInput");
      inp.value=inp.value.slice(0,-1);
    }

    function confirmModal(){
      let val=document.getElementById("modalInput").value.trim();
      if(!val){alert("Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø©");return;}
      let uid=modalProduct.qr || modalProduct.code;
      let tbody=document.querySelector("#selectedTable tbody");
      let row=[...tbody.querySelectorAll("tr")].find(r=>(r.children[2].textContent||r.children[1].textContent)===uid);
      if(row){
        row.children[3].textContent=val;
      } else {
        let tr=document.createElement("tr");
        tr.innerHTML=`<td>${modalProduct.name}</td><td>${modalProduct.code||""}</td><td>${modalProduct.qr||""}</td><td>${val}</td><td><button onclick="tr.remove()">ğŸ—‘</button></td>`;
        tbody.appendChild(tr);
      }
      document.getElementById("searchBar").value="";
      closeModal();
    }

    function exportExcel(){
      let rows=[["Ø§Ø³Ù…","ÙƒÙˆØ¯ Ø§Ù„Ù…ÙŠØ²Ø§Ù†","QR","Ø§Ù„Ø¹Ø¯Ø¯/Ø§Ù„ÙˆØ²Ù†"]];
      document.querySelectorAll("#selectedTable tbody tr").forEach(r=>{
        rows.push([r.children[0].textContent, r.children[1].textContent, r.children[2].textContent, r.children[3].textContent]);
      });
      let csv=rows.map(r=>r.join(",")).join("\n");
      let blob=new Blob([csv],{type:"text/csv"});
      let a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download="selected.csv";
      a.click();
    }

    function toggleCamera(){
      if(html5QrCode){
        html5QrCode.stop().then(()=>{html5QrCode=null;});
        return;
      }
      html5QrCode = new Html5Qrcode("preview");
      Html5Qrcode.getCameras().then(devices=>{
        if(devices && devices.length){
          let backCam = devices.find(d=>d.label.toLowerCase().includes("back")) || devices[devices.length-1];
          html5QrCode.start(
            { deviceId: { exact: backCam.id } },
            { fps: 10, qrbox: 250 },
            qrCodeMessage => {
              document.getElementById("searchBar").value = qrCodeMessage;
              let match = products.find(p=>p.qr==qrCodeMessage || String(p.code)==qrCodeMessage);
              if(match){ openModal(match); }
            }
          );
        }
      });
    }
  </script>
</body>
</html>
